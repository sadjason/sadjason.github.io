<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Objective-C Copy 那些事儿 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/58.1fccc879.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">Objective-C Copy 那些事儿</div> <div class="post-info">2015-01-24 • iOS</div></div> <div class="content content__default"><p>Objective-C 中的 copy 相关内容比我想象中要丰富多了。</p> <h3 id="nscopying-和-nsmutablecopying-协议"><a href="#nscopying-和-nsmutablecopying-协议" class="header-anchor">#</a> NSCopying 和 NSMutableCopying 协议</h3> <p>使用对象时经常需要拷贝它。在 Objective-C 中，此操作是通过<code>copy</code>和<code>mutableCopy</code>方法完成的，基类<code>NSObject</code>中与 copy 相关的 API 如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>copy<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>mutableCopy<span class="token punctuation">;</span>
    
<span class="token operator">+</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>copyWithZone<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">struct</span> _NSZone <span class="token operator">*</span><span class="token punctuation">)</span>zone OBJC_ARC_UNAVAILABLE<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>mutableCopyWithZone<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">struct</span> _NSZone <span class="token operator">*</span><span class="token punctuation">)</span>zone OBJC_ARC_UNAVAILABLE<span class="token punctuation">;</span>
</code></pre></div><p>显然，<code>NSObject</code>已经实现了<code>copy</code>和<code>mutableCopy</code>方法。</p> <p>如果想让自己的类（继承自<code>NSObject</code>，假设叫<code>CustomClass</code>）支持拷贝操作，该怎么弄呢？第一个想到的处理方式恐怕是重写<code>copy</code>方法（暂时不谈<code>mutableCopy</code>，稍后再叙）。</p> <p>但是，这种做法是错误的。</p> <p>正确的做法是让自定义类遵循<code>NSCopying</code>协议（<code>NSObject</code>并未遵循该协议），该协议只有一个方法：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@protocol</span> NSCopying
    
<span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>copyWithZone<span class="token punctuation">:</span><span class="token punctuation">(</span>NSZone <span class="token operator">*</span><span class="token punctuation">)</span>zone<span class="token punctuation">;</span>
    
<span class="token keyword">@end</span>
</code></pre></div><p>简单来说，当对某个对象发送<code>copy</code>消息时，<code>NSObject#copy</code>的实现逻辑会去自动调用<code>copyWithZone:</code>方法，有点回调的感觉；因此，若想支持拷贝操作，需要在自定义类中让其支持<code>NSCopying</code>，即实现<code>copyWithZone:</code>方法，而不是重写<code>copy</code>方法。</p> <p>参数<code>zone</code>是什么鬼？这是因为在以前开发程序时，会把内存分为不同的<strong>区</strong>（zone），而对象会创建在某个区里面。现在不用了，每个程序只有一个区：默认区（default zone）。所以说，尽管必须实现<code>copyWithZone:</code>方法，但是不必担心其中的 zone 参数。</p> <p>举个栗子，有个表示个人信息的类，可以在其接口定义中声明此类遵循<code>NSCopying</code>协议，如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> UserInfo <span class="token punctuation">:</span> NSObject <span class="token operator">&lt;</span>NSCopying<span class="token operator">&gt;</span>
    
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">)</span> NSString <span class="token operator">*</span>firstName<span class="token punctuation">;</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">)</span> NSString <span class="token operator">*</span>lastName<span class="token punctuation">;</span>
    
<span class="token operator">-</span> <span class="token punctuation">(</span>instancetype<span class="token punctuation">)</span>initWithFirstName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>firstName
                      andLastName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>lastName<span class="token punctuation">;</span>
    
<span class="token keyword">@end</span>
    
<span class="token keyword">@implementation</span> UserInfo
    
<span class="token operator">-</span> <span class="token punctuation">(</span>instancetype<span class="token punctuation">)</span>initWithFirstName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>firstName
                      andLastName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>lastName <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">super</span> init<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _firstName <span class="token operator">=</span> <span class="token punctuation">[</span>firstName copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _lastName <span class="token operator">=</span> <span class="token punctuation">[</span>lastName copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token macro property">#<span class="token directive keyword">pragma</span> mark - NSCopying</span>
    
<span class="token operator">-</span> <span class="token punctuation">(</span>instancetype<span class="token punctuation">)</span>copyWithZone<span class="token punctuation">:</span><span class="token punctuation">(</span>NSZone <span class="token operator">*</span><span class="token punctuation">)</span>zone <span class="token punctuation">{</span>
    UserInfo <span class="token operator">*</span>copy <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> class<span class="token punctuation">]</span> allocWithZone<span class="token punctuation">:</span>zone<span class="token punctuation">]</span> initWithFirstName<span class="token punctuation">:</span>_firstName
                                                              andLastName<span class="token punctuation">:</span>_lastName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> copy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token keyword">@end</span>
</code></pre></div><p>再来讲一下<code>mutableCopy</code>方法和<code>NSMutableCopying</code>协议；它们俩与<code>copy</code>方法和<code>NSCopying</code>协议相对应。当你的类还有 mutable 版本时，你还应该遵循<code>NSMutableCopying</code>协议，并实现<code>mutableCopyWithZone:</code>方法，这样，当向该类对象发送<code>mutableCopy</code>消息时，NSObject 的<code>mutableCopy</code>方法实现代码中会回调你的<code>mutableCopyWithZone:</code>方法。</p> <p><strong>Note:</strong> 虽然在自定义<code>copyWithZone:</code>和<code>mutableCopyWithZone:</code>中可以弄各种花样，但是务必保证如下逻辑：</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase">[CustomClass copy] -&gt; CustomClass
// 向immutable对象发送copy消息，得到一个immutable对象</span>

<span class="token phrase">[MutableCustomClass copy] -&gt; CustomClass
// 向mutable对象发送一个copy消息，得到一个immutable对象</span>

<span class="token phrase">[CustomClass mutableCopy] -&gt; MutableCustomClass
// 向immutable对象发送mutableCopy消息，得到mutable对象</span>

<span class="token phrase">[MutableCustomClass mutableCopy] -&gt; MutableCustomClass
// 向mutable对象发送mutableCopy消息，得到mutable对象
</span></code></pre></div><p>下一个问题：向 immutable 对象发送<code>copy</code>消息一定会得到一个新对象吗？</p> <p>No！下面的测试栗子所做的事情是分别向不可变的<code>NSString</code>、<code>NSArray</code>、<code>NSDictionary</code>以及<code>NSSet</code>对象发送<code>copy</code>消息，得到几个新的对象，新对象显然是 immutable 的，问题是：这些新对象真的是<strong>新</strong>对象吗？如下栗子分别把新老对象的地址给打印出来：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>NSString <span class="token operator">*</span>testString <span class="token operator">=</span> <span class="token string">@&quot;1&quot;</span><span class="token punctuation">;</span>
NSString <span class="token operator">*</span>copyString <span class="token operator">=</span> <span class="token punctuation">[</span>testString copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;testString address = %x&quot;</span><span class="token punctuation">,</span> testString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;copyString address = %x&quot;</span><span class="token punctuation">,</span> copyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// print:</span>
<span class="token comment">// testString address = 79720cc0</span>
<span class="token comment">// copyString address = 79720cc0</span>
    
NSArray <span class="token operator">*</span>testArray <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">@</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">@</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
NSArray <span class="token operator">*</span>copyArray <span class="token operator">=</span> <span class="token punctuation">[</span>testArray copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;testArray address = %x&quot;</span><span class="token punctuation">,</span> testArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;copyArray address = %x&quot;</span><span class="token punctuation">,</span> copyArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// print:</span>
<span class="token comment">// testArray address = 79722fb0</span>
<span class="token comment">// copyArray address = 79722fb0</span>
    
NSDictionary <span class="token operator">*</span>testDictionary <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">{</span><span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
NSDictionary <span class="token operator">*</span>copyDictionary <span class="token operator">=</span> <span class="token punctuation">[</span>testDictionary copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;testDictionary address = %x&quot;</span><span class="token punctuation">,</span> testDictionary<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;copyDictionary address = %x&quot;</span><span class="token punctuation">,</span> copyDictionary<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// print:</span>
<span class="token comment">// testDictionary address = 79722fd0</span>
<span class="token comment">// copyDictionary address = 79722fd0    </span>
    
NSSet <span class="token operator">*</span>testSet <span class="token operator">=</span> <span class="token punctuation">[</span>NSSet setWithObject<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
NSSet <span class="token operator">*</span>copySet <span class="token operator">=</span> <span class="token punctuation">[</span>testSet copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;testSet address = %x&quot;</span><span class="token punctuation">,</span> testSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;copySet address = %x&quot;</span><span class="token punctuation">,</span> copySet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// print:</span>
<span class="token comment">// testSet address = 79722ff0</span>
<span class="token comment">// copySet address = 79722ff0</span>
</code></pre></div><p>答案很明了！<code>NSString</code>、<code>NSArray</code>、<code>NSDictionary</code>以及<code>NSSet</code>，这是我们最常用的四个含有 mutable 版本的类型；向这些类型的 immutable 对象发送<code>copy</code>消息，这些对象会直接返回本身，而不是返回一个新创建的对象。</p> <p>关于这一点，我反复使用各种姿势测试了很多次，均得到这样的结果；但是目前还没能找到比较权威的说法对这个现象进行说明。不过想想也很容易理解，对于一个 immutable 对象，真的没必要再复制一个，毕竟其中的内容不会发生改变，如果复制了，那么内存中将会存在两个一模一样的资源，岂不浪费？</p> <p>总结这一段内容的要点如下：</p> <ul><li>若想令自己的类具备拷贝功能，则需要遵循<code>NSCopying</code>协议，实现其定义的<code>copyWithZone:</code>方法；</li> <li>若自定义的类分为 immutable 和 mutable 版本，则需要同时遵循<code>NSCopying</code>和<code>NSMutableCopying</code>协议；</li> <li>向 immutable 对象发送<code>copy</code>消息，并不一定会得到一个新对象；</li></ul> <h3 id="深拷贝和浅拷贝"><a href="#深拷贝和浅拷贝" class="header-anchor">#</a> 深拷贝和浅拷贝</h3> <p>在很长时间里，我都认为<strong>浅拷贝</strong>（shallow copy）指的是「指针拷贝」，而<strong>深拷贝</strong>（deep copy）才是真正 copy 一个对象；显然，这种说法是不正确的。</p> <p>一般来说，「深拷贝」和「浅拷贝」这两个概念是分析集合类型才会谈及的。深拷贝的意思是：在拷贝对象时，将其底层数据也一并复制过去。<strong>Foundation 框架中所有集合类型在默认情况下都执行浅拷贝，也就是说，只拷贝容器对象本身，而不复制其中数据。这样做的原因在于，容器内的对象未必能拷贝，而且调用者也未必想在拷贝容器时一并拷贝其中每一个对象。</strong></p> <p>深拷贝和浅拷贝对比图如下：</p> <div retina="" class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150720-01.png" srcset="/image/20150720-01.png 2x" data-v-339c7bd5></div> <h3 id="理解-property-中的-copy-修饰符"><a href="#理解-property-中的-copy-修饰符" class="header-anchor">#</a> 理解@property 中的 copy 修饰符</h3> <p>经常看到@property 中有些对象类型属性被<code>strong</code>修饰，有些被<code>copy</code>修饰。<code>strong</code>修饰符的作用不消多说，该如何理解<code>copy</code>修饰符呢？</p> <p>关于@property 中<code>copy</code>修饰符的使用，我曾经历了这么两个阶段：</p> <ol><li>使用<code>copy</code>修饰 mutable 类型，使用<code>strong</code>修饰 immutable 类型；</li> <li>使用<code>copy</code>修饰 immutable 类型，使用<code>strong</code>修饰 mutable 类型；</li></ol> <p>关于第 1 个阶段，我忘记了当时是怎么想的，它显然是错的；</p> <p>关于第 2 个阶段，我之所以有这样的认识是因为曾在<a href="http://stackoverflow.com/questions/387959/nsstring-property-copy-or-retain" target="_blank" rel="noopener noreferrer">stackoverflow<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中看到了如下这么一段说明：</p> <blockquote><p>For attributes whose type is an immutable value class that conforms to the <code>NSCopying</code> protocol, you almost always should specify <code>copy</code> in your <code>@property</code> declaration. Specifying retain is something you almost never want in such a situation.</p></blockquote> <p>这句话错了吗？当然没有，要不也不会得到这么多的 votes。但为什么这么说呢？不晓得是当时没耐心还是咋地，反正没怎么思考这个问题。</p> <p>接着以上文提到的<code>UserInfo</code>为栗子，对之进行简化，只是定义两个<code>NSString</code>属性：<code>firstName</code>和<code>lastName</code>，作为对比前者使用<code>copy</code>修饰，后者使用<code>strong</code>修饰。如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> UserInfo <span class="token punctuation">:</span> NSObject <span class="token operator">&lt;</span>NSCopying<span class="token operator">&gt;</span>
    
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">)</span> NSString <span class="token operator">*</span>firstName<span class="token punctuation">;</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSString <span class="token operator">*</span>lastName<span class="token punctuation">;</span>
    
<span class="token keyword">@end</span>
</code></pre></div><p>基于<code>UserInfo</code>创建实例进行测试：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>NSMutableString <span class="token operator">*</span>mutableFirstName <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableString stringWithFormat<span class="token punctuation">:</span><span class="token string">@&quot;张&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
NSMutableString <span class="token operator">*</span>mutableLastName <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableString stringWithFormat<span class="token punctuation">:</span><span class="token string">@&quot;不坏&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
UserInfo <span class="token operator">*</span>u <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UserInfo alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
u<span class="token punctuation">.</span>firstName <span class="token operator">=</span> mutableFirstName<span class="token punctuation">;</span>
u<span class="token punctuation">.</span>lastName  <span class="token operator">=</span> mutableLastName<span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;全名：%@%@&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> u<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// print: 全名：张不坏</span>
    
<span class="token comment">// 改mutableFirstName「张」为「长孙」</span>
<span class="token punctuation">[</span>mutableFirstName deleteCharactersInRange<span class="token punctuation">:</span><span class="token function">NSMakeRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>mutableFirstName appendString<span class="token punctuation">:</span><span class="token string">@&quot;长孙&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 改mutableLastName「不坏」为「不坏蛋」</span>
<span class="token punctuation">[</span>mutableLastName appendString<span class="token punctuation">:</span><span class="token string">@&quot;蛋&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;全名：%@%@&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> u<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// print: 全名：张不坏蛋</span>
</code></pre></div><p>简单来说，对于 immutable 对象类型属性，假设该类型存在 mutable 版本，若使用<code>strong</code>修饰该属性，则将会是不安全的。</p> <p>在上述代码中，<code>u.lastName</code>被<code>strong</code>修饰，对之赋值一个 mutable 类型<code>mutableLastName</code>，之后改变<code>mutableLastName的</code>值（由「不坏」变为「不坏蛋」），显然也影响到了<code>u.lastName</code>的值，这通常是我们所不希望发生的；作为对比，<code>u.firstName</code>被<code>copy</code>修饰，也为之赋值 mutable 类型<code>mutableFirstName</code>，之后也改变<code>mutableFirstName</code>的值（由「张」变为「长孙」），但是<code>u.firstName</code>不受影响。</p> <p>再往深一点看：<code>@property</code>的<code>copy</code>的作用机制是什么？根据我的理解，<code>copy</code>修饰符的意义有两点：</p> <ol><li>在系统自动合成属性的 setter 提供「指示」，使用类似于<code>_iVar = [var copy];</code>的方式进行赋值；</li> <li>告诉使用者，安心的使用吧！</li></ol> <p>因此，根据我的理解，系统合成 UserInfo 的 firstName 和 lastName 的 setter 代码如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setFirstName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>firstName <span class="token punctuation">{</span>
    _firstName <span class="token operator">=</span> <span class="token punctuation">[</span>firstName copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setLastName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>lastName <span class="token punctuation">{</span>
    _lastName <span class="token operator">=</span> lastName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>写到这里，可以回答一个常见的问题了：<strong>如何重写带 copy 关键字的 setter？</strong></p> <p>换句话说，即便<code>firstName</code>属性被<code>copy</code>修饰，但是如果重写 setter 时采用错误的方式，<code>copy</code>带来的好处会荡然无存。譬如这样重写<code>setFirstName:</code>：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setFirstName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>firstName <span class="token punctuation">{</span>
    _firstName <span class="token operator">=</span> firstName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>得到的结果如下（显然，<code>firstName</code>也是不安全的）：</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase">全名：张不坏
全名：长孙不坏蛋
</span></code></pre></div><p>继续深挖：</p> <ol><li>是不是所有遵循<code>NSCopying</code>类型属性都应该使用<code>copy</code>修饰呢？</li> <li>mutable 类型属性可以使用<code>copy</code>修饰吗？</li></ol> <p>对于第一个问题，答案是 No！对于向<code>NSString</code>、<code>NSDictionary</code>等属性才需要使用<code>copy</code>修饰，因为它们存在 mutable 版本，在为属性赋值时，右值很可能是它们的 mutable 类型对象，若使用<code>strong</code>修饰则会带来不稳定因子；另外一个方面，如果属性类型不存在对应的 mutable 版本，则完全不用担心这点，反正你也无法在外部修改它，不稳定因子自然不存在了。</p> <p>对于第二个问题，答案仍然是 No！被修饰符<code>copy</code>修饰的属性，默认的 setter 赋值方式是<code>_iVar = [var copy];</code>而<code>copy</code>方法返回的是 immutable 类型，将 immutable 对象赋值给 mutable 类型指针显然是不对的。</p> <p>P.S：如果存在<code>mutableCopy</code>修饰符，或许可以使用<code>mutableCopy</code>修饰 mutable 属性^_^</p> <h3 id="本文参考"><a href="#本文参考" class="header-anchor">#</a> 本文参考</h3> <ul><li>《Effective Objective-2.0》</li> <li><a href="http://stackoverflow.com/questions/387959/nsstring-property-copy-or-retain" target="_blank" rel="noopener noreferrer">NSString: copy 还是 retain<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.objc.io/issue-7/value-objects.html" target="_blank" rel="noopener noreferrer">Value Objects<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://objccn.io/issue-7-2/" target="_blank" rel="noopener noreferrer">值对象<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/58.1fccc879.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
