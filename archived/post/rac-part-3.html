<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ReactiveCocoa 组件的内存逻辑分析 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/96.82bafc57.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">ReactiveCocoa 组件的内存逻辑分析</div> <div class="post-info">2016-08-26 • iOS</div></div> <div class="content content__default"><p>为了更好了解 ReactiveCocoa，以便在开发过程中更准确的使用，曾花蛮多时间阅读 ReactiveCocoa 的实现源码。漫无目的地阅读源码是难以坚持的，因此总习惯找一条脉络，分析 ReactiveCocoa 的内存管理逻辑显然是一条不错的路线。</p> <p>ReactiveCocoa 的三大基础组件（signal、subscriber、disposable）中，signal 的逻辑是最复杂的；而众多 signal 中，<code>RACDynamicSignal</code>的实现逻辑最为晦涩难懂，它的使用频率也最高，因此本文选择对围绕<code>RACDynamicSignal</code>的信号处理逻辑进行内存分析，过程中自然也会将 subscriber、disposable 的逻辑也给弄清楚；站在另外一个角度来看，倘若能将<code>RACDynamicSignal</code>的内存逻辑分析清除，分析<code>RACSubject</code>等自然也不在话下。</p> <p>本文是我围绕内存管理，分析源码过程中的一些记录。</p> <h3 id="冷信号和订阅者"><a href="#冷信号和订阅者" class="header-anchor">#</a> 冷信号和订阅者</h3> <p>关于冷信号和订阅者，有些事实是我之前不太清楚的，直接罗列如下：</p> <ul><li>冷信号（譬如<code>RACDynamicSignal</code>）和订阅者（<code>RACSubscriber</code>）之间没有持有（引用）关系</li> <li><code>RACSubscriber</code>一旦接收到<code>sendError:</code>或者<code>sendCompleted</code>消息，就会把 3 个 block 设置为<code>nil</code></li></ul> <p>下图是更生动的描述：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/RACDynamicSignal-RACSubscriber@2x.png" srcset="/image/RACDynamicSignal-RACSubscriber@2x.png 2x" data-v-339c7bd5></div> <p>看一段代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token punctuation">{</span>
    RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         
        <span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler mainThreadScheduler<span class="token punctuation">]</span> afterDelay<span class="token punctuation">:</span><span class="token number">1.0</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token comment">// timing 5</span>
            <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// timing 6</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
        <span class="token comment">// timing 3</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// timing 1</span>
     
    <span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;next: %@&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> error<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>NSError <span class="token operator">*</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;error: %@&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> completed<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// timing 2</span>
<span class="token punctuation">}</span>
<span class="token comment">// timing 4</span>
</code></pre></div><p>问题：在<code>timing 5</code>处，<code>signal</code>对象还存在吗？</p> <p>答案：不存在！<code>signal</code>没有被任何对象持有，到<code>timing 4</code>处，它就被释放掉了。</p> <h3 id="热信号和订阅者"><a href="#热信号和订阅者" class="header-anchor">#</a> 热信号和订阅者</h3> <p>和冷信号不同，热信号和订阅者之间是有持有关系的，即：</p> <ul><li>热信号（譬如<code>RACSubject</code>）会持有订阅者</li></ul> <p>下图是更生动的描述：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/RACSubject-RACSubscriber@2x.png" srcset="/image/RACSubject-RACSubscriber@2x.png 2x" data-v-339c7bd5></div> <p><code>RACSubject#subscribers</code>是一个数组，每次被订阅时，它就将订阅者存到该数组中，以便日后产生事件时向它们发送<code>sendNext:</code>/<code>sendError:</code>/<code>sendCompleted</code>消息。</p> <h2 id="真·生命周期"><a href="#真·生命周期" class="header-anchor">#</a> 真·生命周期</h2> <p>上面分析的生命周期其实将一些内部细节给过滤掉了。</p> <p>先来看段代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token punctuation">{</span>
    RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>RACScheduler<span class="token punctuation">.</span>mainThreadScheduler afterDelay<span class="token punctuation">:</span><span class="token number">2</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token comment">// async block 2</span>
            <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>RACDisposable disposableWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;dispose in didSubscribe block&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     
    RACDisposable <span class="token operator">*</span>disposable <span class="token operator">=</span> <span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;next: %@&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> completed<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     
    <span class="token punctuation">[</span>RACScheduler<span class="token punctuation">.</span>mainThreadScheduler afterDelay<span class="token punctuation">:</span><span class="token number">1</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// async block 1</span>
        <span class="token punctuation">[</span>disposable dispose<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码中有两个异步 block，安排 async block 1 在 1s 时执行，async block 2 在 2s 时执行。程序执行结果会怎样呢？</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>next<span class="token punctuation">:</span> <span class="token number">1</span>
dispose <span class="token keyword">in</span> didSubscribe block
</code></pre></div><p>结果有些令人诧异，为什么不是这样：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>next<span class="token punctuation">:</span> <span class="token number">1</span>
next<span class="token punctuation">:</span> <span class="token number">2</span>
dispose <span class="token keyword">in</span> didSubscribe block
completed
</code></pre></div><p>把这个原因分析清楚并不是特别简单，因为要涉及一些其他角色。</p> <p>先从<code>RACDisposable</code>讲起吧。顾名思义，它与「销毁对象」有关，站在程序的角度，它有一个 block 类型变量<code>_disposeBlock</code>，当向它第一次发送<code>dispose</code>消息时，该 block 会被调用。</p> <p>除了<code>RACDisposable</code>之外，这里还要涉及它的子类<code>RACCompoundDisposable</code>，后者除了拥有<code>RACDisposable</code>特性外，它还可以管理多个子 disposable，当向它发送<code>dispose</code>消息时，除了调用自身<code>_disposeBlock</code>，它也会向其子 disposable 发送该消息。</p> <p>OK！开始从代码层面分析<code>RACDynamicSignal</code>的订阅过程了。</p> <p>订阅信号（signal）时，首先会创建一个<code>RACSubscriber</code>对象（subscriber），如上文所述，subscriber 和 signal 没有引用关系。</p> <p>其次，内部还会创建一个<code>RACCompoundDisposable</code>实例（compound disposable），该实例会作为<code>subscribeNext:error:completed:</code>的返回值返回。</p> <p>最后，内部还会创建一个<code>RACPassthroughSubscriber</code>实例（passthrough subscriber），passthrough subscriber 是 subscriber 的透明代理，它有 3 个属性，分别指向 subscriber、compound disposable 以及 signal。如下图所示：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/complex@2x.png" srcset="/image/complex@2x.png 2x" data-v-339c7bd5></div> <p>如图，<code>RACPassthroughSubscriber#disposable</code>和<code>RACPassthroughSubscriber#innerSubscriber</code>都是强引用，<code>RACPassthroughSubscriber#signal</code>是弱引用。</p> <p>P.S: passthrough subscriber 引用 signal 的目的似乎只是为了调试。</p> <p>还需要说明的是，signal 的 didSubscribe block 返回的 disposable（可能为<code>nil</code>）会被添加到 compound disposable 中，作为其子 dispose 进行管理。</p> <p>再次说明，compound disposable 作为<code>subscribeNext:error:completed:</code>返回值返回，用户获取后，可以向其发送<code>dispose</code>消息。</p> <p>RAC 的设定是：当 compound disposable 被 disposed 时，passthrough subscriber 就无法将<code>sendNext:</code>/<code>sendError:</code>/<code>sendCompleted</code>消息透传给 subscriber。详见<code>RACPassthroughSubscriber</code>的实现代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token comment">// RACPassthroughSubscriber.m</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>sendNext<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>value <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>disposable<span class="token punctuation">.</span>disposed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token comment">// &lt;--这是关键</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">RACSIGNAL_NEXT_ENABLED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 暂时不用理会这个`if`语句</span>
        <span class="token function">RACSIGNAL_NEXT</span><span class="token punctuation">(</span><span class="token function">cleanedSignalDescription</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>signal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cleanedDTraceString</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>innerSubscriber<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cleanedDTraceString</span><span class="token punctuation">(</span><span class="token punctuation">[</span>value description<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>innerSubscriber sendNext<span class="token punctuation">:</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>搞清楚了这个，就不难理解上面代码的执行结果了。如下这段代码的分析也类似：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token punctuation">{</span>
    RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        RACDisposable <span class="token operator">*</span>disposable1 <span class="token operator">=</span> <span class="token punctuation">[</span>RACScheduler<span class="token punctuation">.</span>mainThreadScheduler afterDelay<span class="token punctuation">:</span><span class="token number">2</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        RACDisposable <span class="token operator">*</span>disposable2 <span class="token operator">=</span> <span class="token punctuation">[</span>RACScheduler<span class="token punctuation">.</span>mainThreadScheduler afterDelay<span class="token punctuation">:</span><span class="token number">2</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>RACDisposable disposableWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token punctuation">[</span>disposable1 dispose<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>disposable2 dispose<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;dispose!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    RACDisposable <span class="token operator">*</span>disposable <span class="token operator">=</span> <span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;next: %@&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> completed<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>RACScheduler<span class="token punctuation">.</span>mainThreadScheduler afterDelay<span class="token punctuation">:</span><span class="token number">1</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token punctuation">[</span>disposable dispose<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>P.P.S: <code>didSubscribe</code>的返回值 disposable 还是非常有用，举个例子，若<code>didSubscribe</code>的副作用是发起一个网络任务（譬如<code>AFHTTPRequestOperation</code>），则可以在该 disposable 的 dispose block 中执行<code>[operation cancel]</code>操作，当取消订阅时，就取消网络任务，因为它没有执行的必要了。</p> <p>貌似看到过这样的说法：若向<code>didSubscribe</code>返回的 disposable 发送 dispose 消息，则 subscriber 的 3 个 block 都会被置为<code>nil</code>。我验证并查看了代码，这种说法是错误的。</p> <p>来看段代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token punctuation">{</span>
    RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>RACDisposable disposableWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>  <span class="token comment">// mark 1</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;disposed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     
    <span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// mark 3</span>
     
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span class="token comment">// mark 2</span>
</code></pre></div><p>这段代码的执行结果是什么？是这样？</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase">end
disposed
</span></code></pre></div><p>还是这样？</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase">disposed
end
</span></code></pre></div><p>正确答案是后者。这个问题的本质是回答「<code>mark 1</code>处 disposable 的生命周期是怎么样的」，据上文的分析，它间接由 passthrough subscriber 持有，因此问题是：passthrough subscriber 什么时候被释放？</p> <p>我刚开始以为 passthrough subscriber 在<code>mark 2</code>处释放。事实不是这样的，passthrough subscriber 在<code>RACDynamic#subscribe:</code>内部被创建，被传递给 didSubscribe block，在<code>mark 3</code>处时，<code>RACDynamic#subscribe:</code>调用完毕，didSubscribe block 也被同步调用了，不再有任何人持有它，故而被释放掉，连带着<code>mark 1</code>处的 disposable 被 disposed 掉...</p> <p>如果代码改成这样：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token punctuation">{</span>
    RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler mainThreadScheduler<span class="token punctuation">]</span> afterDelay<span class="token punctuation">:</span><span class="token number">1.0</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            subscriber<span class="token punctuation">;</span>  <span class="token comment">// passthrough subscriber被GCD持有，1s后才被释放</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>RACDisposable disposableWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>  <span class="token comment">// mark 1</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;disposed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     
    <span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// mark 3</span>
     
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span class="token comment">// mark 2</span>
</code></pre></div><p>留个问题：这段代码执行结果又会如何？</p> <p><strong>补充</strong></p> <p>现在（2017 年末）再看这篇一年前的博客，有些汗颜，虽然没有明显的逻辑错误，但是结构太乱；当前对 ReactiveCocoa 的理解比当时要清楚得多，却没有当时的激情来对它进行重新整理了。今年早些时候在公司内部对为新人准备了一场 ReactiveCocoa 主题分享，此处贴上 Keynote: <a href="/file/ReactiveCocoa.key.zip">ReactiveCocoa.key.zip</a>，或许对看客有一点点用...</p></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/96.82bafc57.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
