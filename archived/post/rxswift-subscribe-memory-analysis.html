<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RxSwift 订阅过程的内存分析 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/99.79a6f693.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">RxSwift 订阅过程的内存分析</div> <div class="post-info">2016-12-13 • iOS</div></div> <div class="content content__default"><p>在<a href="/post/rxswift-subscribe-source-analysis.html">RxSwift 订阅过程的源内存分析</a>中，对 RxSwift 的订阅过程进行了简单的源码分析，本文在此基础上分析内存（对象间的持有关系）。</p> <p>先来看一段伪代码：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">let</span> observable <span class="token operator">=</span> <span class="token builtin">Observable</span><span class="token operator">&lt;</span><span class="token builtin">Int</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> observer <span class="token keyword">in</span>
    <span class="token comment">// subscribe closure</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  
<span class="token keyword">let</span> binaryDisposable <span class="token operator">=</span> observable<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// onNext closure</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在上面代码中，可以在 subscribe closure 中发射 event，在 onNext closure（<code>onError</code>和<code>onCompleted</code>略过）处接收 event。然而，onNext closure 中并不总能接收到有效的 next event，使用 ReactiveCocoa 的经验告诉我，有两种情况，onNext closure 无法接收到 next event：</p> <ul><li>过早取消订阅，即<code>binaryDisposable</code>过早被 disposed</li> <li>subscribe closure 中发射了 error 或者 completed，之后的值事件无法传播到 onNext closure</li></ul> <p>本文就基于这两种情况分析各种组件在各个阶段的存在情况和引用情况。</p> <h3 id="主动取消订阅"><a href="#主动取消订阅" class="header-anchor">#</a> 主动取消订阅</h3> <p>在下面一段代码中，observable 被订阅后，两秒后才发射 next 事件和 completed 事件：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> observable <span class="token operator">=</span> <span class="token builtin">Observable</span><span class="token operator">&lt;</span><span class="token builtin">Int</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> observer <span class="token keyword">in</span>
        <span class="token builtin">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">asyncAfter</span><span class="token punctuation">(</span>deadline<span class="token punctuation">:</span> <span class="token builtin">DispatchTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> execute<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            observer<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            observer<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// timing 4</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">Disposables</span><span class="token punctuation">.</span>create <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Subscription Disposable&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
 
    <span class="token keyword">let</span> binaryDisposable <span class="token operator">=</span> observable<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;onNext closure: <span class="token interpolation"><span class="token delimiter variable">\(</span>$<span class="token number">0</span><span class="token delimiter variable">)</span></span>&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> onDisposed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;onDisposed closure&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>  <span class="token comment">// timing 1</span>
 
    binaryDisposable<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// timing 2</span>
<span class="token punctuation">}</span>  <span class="token comment">// timing 3</span>
</code></pre></div><p>上面代码逻辑中，标记了 4 个时间点。创建一个 observable，然后订阅（timing 1），接着取消订阅（timing 2），2 秒后（timing 4）发送值事件和 completed 事件。</p> <p>现在关心的是 4 个状态下的各个部件的存在情况。</p> <p><strong>timing 1</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/cancel-subscribe-timing-1@2x.png" srcset="/image/cancel-subscribe-timing-1@2x.png 2x" data-v-339c7bd5></div> <p><code>timing 1</code>处，各种组件的引用情况比较容易理清，参考<a href="/post/rxswift-subscribe-source-analysis.html">RxSwift 订阅过程的源内存分析</a>，需要说明的是，在本文应用场景中，Some Thread 实际上就是 Main Thread。</p> <p><strong>timing 2</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/cancel-subscribe-timing-2@2x.png" srcset="/image/cancel-subscribe-timing-2@2x.png 2x" data-v-339c7bd5></div> <p>在<code>timing 2</code>处，Binary Disposable 主动触发 dispose，因此它持有的两个子 disposables（即 Disposer 和 User Disposable）也会触发 dispose；另外，Disposer 也管理了两个子 disposables：Subscription Disposable，因此连带着把后两者也给 dispose 了，参考<code>SinkDisposer</code>的实现代码，还可以知道，它在<code>dispose()</code>中，除了 dispose 掉两个子 disposables 外，还会释放对它们的强持有。</p> <p><code>SinkDisposer#dispose()</code>的逻辑如下：</p> &quot; extra-class&quot;&gt;<pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> previousState <span class="token operator">=</span> <span class="token function">OSAtomicOr32OrigBarrier</span><span class="token punctuation">(</span><span class="token builtin">DisposeState</span><span class="token punctuation">.</span>disposed<span class="token punctuation">.</span>rawValue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_state<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>previousState <span class="token operator">&amp;</span> <span class="token builtin">DisposeStateInt32</span><span class="token punctuation">.</span>disposed<span class="token punctuation">.</span>rawValue<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>previousState <span class="token operator">&amp;</span> <span class="token builtin">DisposeStateInt32</span><span class="token punctuation">.</span>sinkAndSubscriptionSet<span class="token punctuation">.</span>rawValue<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> sink <span class="token operator">=</span> _sink <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">rxFatalError</span><span class="token punctuation">(</span><span class="token string">&quot;Sink not set&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> subscription <span class="token operator">=</span> _subscription <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">rxFatalError</span><span class="token punctuation">(</span><span class="token string">&quot;Subscription not set&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
 
        sink<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        subscription<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
        _sink <span class="token operator">=</span> <span class="token constant">nil</span>
        _subscription <span class="token operator">=</span> <span class="token constant">nil</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> <p><strong>timing 3</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/cancel-subscribe-timing-3@2x.png" srcset="/image/cancel-subscribe-timing-3@2x.png 2x" data-v-339c7bd5></div> <p>在<code>timing 3</code>中，Binary Disposable 超出作用域，因此被释放，但是 User Disposable 和 Disposer 仍然被持有，因此仍然存在于内存中。</p> <p><strong>timing 4</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/cancel-subscribe-timing-4@2x.png" srcset="/image/cancel-subscribe-timing-4@2x.png 2x" data-v-339c7bd5></div> <p>2 秒过后，subscribe closure 中的逻辑全部执行完，Some Thread 会释放该 closure，Any Observer 就不复存在了，它引用或间接引用的其他内部资源也便被释放掉了。</p> <p>整个世界都清净了。</p> <h3 id="当发射-error-或-completed-事件时"><a href="#当发射-error-或-completed-事件时" class="header-anchor">#</a> 当发射 error 或 completed 事件时</h3> <p>接下来看另外一种情况，当「主动取消订阅」的时间晚于 completed 事件发射时间时：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> observable <span class="token operator">=</span> <span class="token builtin">Observable</span><span class="token operator">&lt;</span><span class="token builtin">Int</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> observer <span class="token keyword">in</span>
        observer<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        observer<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// timing 2</span>
        <span class="token keyword">return</span> <span class="token builtin">Disposables</span><span class="token punctuation">.</span>create <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Subscription Disposable&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
 
    <span class="token keyword">let</span> binaryDisposable <span class="token operator">=</span> observable<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;onNext closure: <span class="token interpolation"><span class="token delimiter variable">\(</span>$<span class="token number">0</span><span class="token delimiter variable">)</span></span>&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> onDisposed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;onDisposed closure&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>  <span class="token comment">// timing 1</span>
 
    <span class="token builtin">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">asyncAfter</span><span class="token punctuation">(</span>deadline<span class="token punctuation">:</span> <span class="token builtin">DispatchTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> execute<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        binaryDisposable<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// timing 4</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>  <span class="token comment">// timing 3</span>
</code></pre></div><p>上面逻辑中，observable 被订阅后立马发送一个 next 和 completed；在 2 秒后才取消订阅。</p> <p><strong>timing 1</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/error-completed-timing-1@2x.png" srcset="/image/error-completed-timing-1@2x.png 2x" data-v-339c7bd5></div> <p><code>timing 1</code>处和上文的一样。</p> <p><strong>timing 2</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/error-completed-timing-2@2x.png" srcset="/image/error-completed-timing-2@2x.png 2x" data-v-339c7bd5></div> <p>在<code>timing 2</code>处（准确来说，在<code>timing 2</code>之后的某个点），Sink 的<code>on(_)</code>方法在处理 error 或 completed 事件时，做两件事情：</p> <ul><li>将 event 下发（forward on）到 Anoymous Observer，后者除了处理 event 外，还会将它所引用的 User Disposable 给 dispose 掉
回调自己的 dispose()方法</li> <li><code>Sink#dispose()</code>又会触发<code>Disposer#dispose()</code>...故而上文的<code>timing 2</code>所做的事情在这里又会做一遍。</li></ul> <p><strong>timing 3</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/error-completed-timing-3@2x.png" srcset="/image/error-completed-timing-3@2x.png 2x" data-v-339c7bd5></div> <p>在<code>timing 3</code>时，Some Thread 不再持有 Any Observer，后者持有的和间接持有的资源随后也会被释放。</p> <p><strong>timing 4</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/error-completed-timing-4@2x.png" srcset="/image/error-completed-timing-4@2x.png 2x" data-v-339c7bd5></div> <p><code>timing 4</code>后，或说 2 秒后，Some Thread 不再持有 Binary Disposable，便被释放掉了...</p> <p>世界又清净了...</p></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/99.79a6f693.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
