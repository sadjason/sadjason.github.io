<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分析 dyld 的启动过程 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/61.d9ae36dc.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/4.a7413ce2.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">分析 dyld 的启动过程</div> <div class="post-info">2018-10-19</div></div> <div class="content content__default"><p>之前的博文<a href="/post/macho-dynamic-link.html">Mach-O 与动态链接</a>基于 Mach-O 文件结构，分析了 Mach-O 的动态链接逻辑。当一个可执行 Mach-O 文件被执行时，内核在完成进程创建等一系列初始化后，会把后续的链接以及镜像加载工作交给 dyld 来完成。</p> <p>本文对 dyld 的启动过程稍作分析，在分析的过程中会回答如下两个问题：</p> <ul><li>程序是如何加载的，或者说，程序的入口代码（譬如<code>main</code>函数）是如何被调用的？</li> <li>dyld 逻辑的启动过程是怎样的？</li></ul> <p>本文所分析对象包括：</p> <ul><li>dyld Mach-O 文件（在<code>/usr/lib/dyld</code>中，本文所分析的版本是 640.2，对应源码还没来得及开源）</li> <li><a href="https://opensource.apple.com/source/dyld/dyld-635.2/" target="_blank" rel="noopener noreferrer">dyld-635.2 源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/" target="_blank" rel="noopener noreferrer">xnu-4903.221.2 源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>dyld 本身也是一个 dylib，但它有一些特殊性。对于普通 dylib 来说，它的重定位工作由 dyld 来完成；它也可以依赖与其他 dylib，其中被依赖的 dylib 由 dyld 负责链接和装载。对于 dyld 来说，它是如何被加载的呢？它是否可以依赖于其他的 dylib？</p> <p>首先，dyld 本身不可以依赖于其他任何 dylib，使用<code>xcrun dyldinfo -dylibs</code>查看可以证实这一点：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ xcrun dyldinfo -dylibs dyld
<span class="token keyword">for</span> arch x86_64:
attributes     dependent dylibs
<span class="token keyword">for</span> arch i386:
attributes     dependent dylibs
</code></pre></div><p>如上结果（也可以使用 MachOView 工具查看）显示，dyld 没有依赖任何其他 dylib；不过这一点显然是可以人为控制的，在编写动态链接器时保证不使用任何其他库资源（包括系统库）就可以了。</p> <p>那么对于另一个问题：dyld 是如何被加载的呢？或者说，它的代码是如何被执行的呢？</p> <p>dyld 的代码逻辑开始于<a href="https://opensource.apple.com/source/dyld/dyld-635.2/src/dyldStartup.s.auto.html" target="_blank" rel="noopener noreferrer">dyldStartup.s<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它用汇编实现了名为<code>__dyld_start</code>的函数，主要做两件事情：</p> <ul><li>调用<code>dyldbootstrap::start</code>方法，后者返回可执行文件的入口，暂称为<code>_main</code></li> <li>填入参数，调用<code>_main</code></li></ul> <blockquote><p><code>dyldbootstrap::start</code>也定义于 dyld 中，该函数对应的符号是<code>__ZN13dyldbootstrap5startEPK12macho_headeriPPKclS2_Pm</code>，定义于<a href="https://opensource.apple.com/source/dyld/dyld-635.2/src/dyld.order.auto.html" target="_blank" rel="noopener noreferrer">dyld.order<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></blockquote> <p>所以说，可执行文件的入口，是由 dyld 负责找到并调用的，如何找到？这个问题比较简单，对于依赖于 dyld 的可执行文件，其逻辑代码的起点（entry point）可以从<code>LC_MAIN</code>这个 load command 里解析得到，该指令的参数记录了程序入口指令相对于镜像文件的 file offset；dyld 完成 rebase、binding 等工作后，会去调用该地址的函数。</p> <blockquote><p>貌似从 10.7 开始，Mac OS X (macOS) 里的可执行文件都得依赖于 dyld。</p></blockquote> <p>另一个关键问题是：内核是如何找到<code>__dyld_start</code>函数的呢？</p> <p>关于这个问题，参考<a href="https://stackoverflow.com/questions/39863112/what-is-required-for-a-mach-o-executable-to-load" target="_blank" rel="noopener noreferrer">StackOverflow: What is required for a Mach-O executable to load?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，尝试从<code>LC_UNIXTHREAD</code>这个 load command 里挖掘答案。</p> <p>dyld 本身逻辑的加载，依赖于内核调用，内核在对 dyld 镜像进行解析时，从<code>LC_UNIXTHREAD</code>这个 load command 中提取 dyld 的 entry point。</p> <p>使用<code>otool -l</code>查看<code>LC_UNIXTHREAD</code>的结构：</p> <div class="language-raw extra-class"><pre class="language-text"><code>Load command 9
        cmd LC_UNIXTHREAD
    cmdsize 184
     flavor x86_THREAD_STATE64
      count x86_THREAD_STATE64_COUNT
   rax    0x0000000000000000 rbx    0x0000000000000000 rcx    0x0000000000000000
   rdx    0x0000000000000000 rdi    0x0000000000000000 rsi    0x0000000000000000
   rbp    0x0000000000000000 rsp    0x0000000000000000 r8     0x0000000000000000
    r9    0x0000000000000000 r10    0x0000000000000000 r11    0x0000000000000000
   r12    0x0000000000000000 r13    0x0000000000000000 r14    0x0000000000000000
   r15    0x0000000000000000 rip    0x0000000000001000 rflags 0x0000000000000000
   cs     0x0000000000000000 fs     0x0000000000000000 gs     0x0000000000000000
</code></pre></div><p>它包含了三个有效信息：flavor、count、thread_state。flavor 描述的是进程类型（x86_64 架构对应的是<code>x86_THREAD_STAT64</code>，i386 架构对应的是<code>x86_THREAD_STAT32</code>）；count 描述 thread_state 的长度；至于<code>thread_state</code>，描述的是进程状态，「进程」这个概念的完成需要硬件和软件通力协作，不同不同架构的<code>thread_state</code>不同，对于<code>x86_THREAD_STAT64</code>，<code>thread_state</code>结构定义于<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/osfmk/mach/i386/_structs.h.auto.html" target="_blank" rel="noopener noreferrer">/osfmk/mach/i386/_structs.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，如下：：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> _STRUCT_X86_THREAD_STATE64 struct x86_thread_state64</span>
_STRUCT_X86_THREAD_STATE64
<span class="token punctuation">{</span>
  __uint64_t  rax<span class="token punctuation">;</span>
  __uint64_t  rbx<span class="token punctuation">;</span>
  __uint64_t  rcx<span class="token punctuation">;</span>
  __uint64_t  rdx<span class="token punctuation">;</span>
  __uint64_t  rdi<span class="token punctuation">;</span>
  __uint64_t  rsi<span class="token punctuation">;</span>
  __uint64_t  rbp<span class="token punctuation">;</span>
  __uint64_t  rsp<span class="token punctuation">;</span>
  __uint64_t  r8<span class="token punctuation">;</span>
  __uint64_t  r9<span class="token punctuation">;</span>
  __uint64_t  r10<span class="token punctuation">;</span>
  __uint64_t  r11<span class="token punctuation">;</span>
  __uint64_t  r12<span class="token punctuation">;</span>
  __uint64_t  r13<span class="token punctuation">;</span>
  __uint64_t  r14<span class="token punctuation">;</span>
  __uint64_t  r15<span class="token punctuation">;</span>
  __uint64_t  rip<span class="token punctuation">;</span>
  __uint64_t  rflags<span class="token punctuation">;</span>
  __uint64_t cs<span class="token punctuation">;</span>
  __uint64_t  fs<span class="token punctuation">;</span>
  __uint64_t  gs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>对于<code>x86_THREAD_STAT64</code>类型的 thread_state，rip 存储了进程的 entry point（相对于镜像的 file offset）；接下来的 xnu 源码分析是为了证实这一点。</p> <p>从<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/bsd/kern/mach_loader.c.auto.html" target="_blank" rel="noopener noreferrer">/bsd/kern/mach_loader.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>里的<code>parse_machfile</code>函数开始看，顾名思义，<code>parse_machfile</code>用于解析 Mach-O 文件，摘录其解析 load commands 的<code>LC_UNIXTHREAD</code>分支：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> load_return_t <span class="token function">parse_machfile</span><span class="token punctuation">(</span>
  <span class="token keyword">struct</span> <span class="token class-name">vnode</span>        <span class="token operator">*</span>vp<span class="token punctuation">,</span>       
  vm_map_t            map<span class="token punctuation">,</span>
  thread_t            thread<span class="token punctuation">,</span>
  <span class="token keyword">struct</span> <span class="token class-name">mach_header</span>  <span class="token operator">*</span>header<span class="token punctuation">,</span>
  off_t               file_offset<span class="token punctuation">,</span>
  off_t               macho_size<span class="token punctuation">,</span>
  <span class="token keyword">int</span>                 depth<span class="token punctuation">,</span>
  int64_t             aslr_offset<span class="token punctuation">,</span>
  int64_t             dyld_aslr_offset<span class="token punctuation">,</span>
  load_result_t       <span class="token operator">*</span>result<span class="token punctuation">,</span>
  load_result_t       <span class="token operator">*</span>binresult<span class="token punctuation">,</span>
  <span class="token keyword">struct</span> <span class="token class-name">image_params</span> <span class="token operator">*</span>imgp
<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">case</span> LC_UNIXTHREAD<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pass <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">load_unixthread</span><span class="token punctuation">(</span>
                        <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">thread_command</span> <span class="token operator">*</span><span class="token punctuation">)</span> lcp<span class="token punctuation">,</span>
                        thread<span class="token punctuation">,</span>
                        slide<span class="token punctuation">,</span>
                        result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>跟着<code>load_unixthread</code>往下看，关键代码如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> load_return_t <span class="token function">load_unixthread</span><span class="token punctuation">(</span>
  <span class="token keyword">struct</span> <span class="token class-name">thread_command</span> <span class="token operator">*</span>tcp<span class="token punctuation">,</span>
  thread_t              thread<span class="token punctuation">,</span>
  int64_t               slide<span class="token punctuation">,</span>
  load_result_t         <span class="token operator">*</span>result
<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  ret <span class="token operator">=</span> <span class="token function">load_threadentry</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vm_offset_t<span class="token punctuation">)</span>tcp<span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">thread_command</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        tcp<span class="token operator">-&gt;</span>cmdsize <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">thread_command</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> LOAD_SUCCESS<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">-&gt;</span>using_lcmain <span class="token operator">||</span> result<span class="token operator">-&gt;</span>entry_point <span class="token operator">!=</span> MACH_VM_MIN_ADDRESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Already processed LC_MAIN or LC_UNIXTHREAD */</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>LOAD_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  result<span class="token operator">-&gt;</span>entry_point <span class="token operator">=</span> addr<span class="token punctuation">;</span>
  result<span class="token operator">-&gt;</span>entry_point <span class="token operator">+=</span> slide<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>提取 entry point 的重任被辗转到<code>load_threadentry</code>，后者逻辑也挺简单，所做的事情不过是把锅甩到<code>thread_entrypoint</code>，不同平台的<code>thread_entrypoint</code>定义不同，对于 x86 架构，该函数定义于<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/osfmk/i386/bsd_i386.c.auto.html" target="_blank" rel="noopener noreferrer">xnu/osfmk/i386/bsd_i386.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它的逻辑蛮简单：</p> <div class="language-c extra-class"><pre class="language-c"><code>kern_return_t <span class="token function">thread_entrypoint</span><span class="token punctuation">(</span>
    __unused thread_t       thread<span class="token punctuation">,</span>
    <span class="token keyword">int</span>                     flavor<span class="token punctuation">,</span>
    thread_state_t          tstate<span class="token punctuation">,</span>
    __unused <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   count<span class="token punctuation">,</span>
    mach_vm_offset_t        <span class="token operator">*</span>entry_point
<span class="token punctuation">)</span>
<span class="token punctuation">{</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>entry_point <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">*</span>entry_point <span class="token operator">=</span> VM_MIN_ADDRESS<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>flavor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> x86_THREAD_STATE32<span class="token operator">:</span>
    <span class="token punctuation">{</span>
      x86_thread_state32_t <span class="token operator">*</span>state25<span class="token punctuation">;</span>

      state25 <span class="token operator">=</span> <span class="token punctuation">(</span>i386_thread_state_t <span class="token operator">*</span><span class="token punctuation">)</span> tstate<span class="token punctuation">;</span>
      <span class="token operator">*</span>entry_point <span class="token operator">=</span> state25<span class="token operator">-&gt;</span>eip <span class="token operator">?</span> state25<span class="token operator">-&gt;</span>eip<span class="token operator">:</span> VM_MIN_ADDRESS<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">case</span> x86_THREAD_STATE64<span class="token operator">:</span>
    <span class="token punctuation">{</span>
      x86_thread_state64_t <span class="token operator">*</span>state25<span class="token punctuation">;</span>

      state25 <span class="token operator">=</span> <span class="token punctuation">(</span>x86_thread_state64_t <span class="token operator">*</span><span class="token punctuation">)</span> tstate<span class="token punctuation">;</span>
      <span class="token operator">*</span>entry_point <span class="token operator">=</span> state25<span class="token operator">-&gt;</span>rip <span class="token operator">?</span> state25<span class="token operator">-&gt;</span>rip<span class="token operator">:</span> VM_MIN_ADDRESS64<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>KERN_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>分析到这里基本实锤了，对于 x86_64 架构，<code>LC_UNIXTHREAD</code> 命令里的<code>thread_state-&gt;rip</code>指定了 dyld 的 entry point。</p> <p>OK，是时候对 dyld 以及程序的启动做个总结了（针对 x86_64 架构的 Mach-O 可执行文件）：</p> <ul><li>对于依赖于 dyld 的可执行文件，进程的 entry point 是 dyld 的<code>__dyld_start</code>函数</li> <li>内核通过解析<code>LC_UNIXTHREAD</code>，从<code>thread_state-&gt;rip</code>里获得 dyld 的入口（即<code>__dyld_start</code>）</li> <li>镜像的入口由<code>dyldbootstrap::start</code>函数发现，返回到<code>__dyld_start</code>，被后者调用</li> <li>镜像的入口可通过解析<code>LC_MAIN</code>得到</li></ul> <h1 id="写在后面"><a href="#写在后面" class="header-anchor">#</a> 写在后面</h1> <p>本文对 xnu 和 dyld 源码的分析完全属于盲人摸象，分析思路是先提出问题，然后分析源码，尝试给出自己的回答。除了理解上可能存在偏差外，还有如下问题没有搞清楚：</p> <ul><li>个人感觉，<code>LC_UNIXTHREAD</code>是 dyld 的专有命令，但没有找到权威的说明</li> <li>现在还能折腾出不依赖 dyld 的程序可执行文件吗？尝试弄了一把，但没有成功，貌似依赖 dyld 是 macOS 对应用程序的强制行为</li></ul> <p>更多阅读：</p> <ul><li><a href="https://stackoverflow.com/questions/39863112/what-is-required-for-a-mach-o-executable-to-load" target="_blank" rel="noopener noreferrer">StackOverflow: What is required for a Mach-O executable to load?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://blog.sunnyxx.com/2014/08/30/objc-pre-main/" target="_blank" rel="noopener noreferrer">iOS 程序 main 函数之前发生了什么<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.mikeash.com/pyblog/friday-qa-2012-11-09-dyld-dynamic-linking-on-os-x.html" target="_blank" rel="noopener noreferrer">dyld: Dynamic Linking On OS X<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.cnbluebox.com/blog/2017/06/30/dyld2/" target="_blank" rel="noopener noreferrer">Dyld系列之一：_dyld_start之前<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/61.d9ae36dc.js" defer></script>
  </body>
</html>
