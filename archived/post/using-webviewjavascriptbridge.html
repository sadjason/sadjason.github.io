<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 WebViewJavascriptBridge | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/108.efc3ce89.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/4.a7413ce2.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">使用 WebViewJavascriptBridge</div> <div class="post-info">2015-06-16 • iOS</div></div> <div class="content content__default"><p>在 App 中使用 Web 代替一些 Native UI 已经成为移动客户端开发的一种思潮。在 App 中嵌入 Web 有一个重要的基础问题：Objective-C 和 JavaScript 的交互。</p> <p>近期的项目需要，笔者开始着手这方面的问题学习。很容易想到：一定存在某个引擎能够在 OC 和 JS 之间转换。去 github 中搜索关键字<code>iOS JavaScript</code>得到的选择并不多，第三方库<a href="https://github.com/marcuswestin/WebViewJavascriptBridge" target="_blank" rel="noopener noreferrer">WebViewJavascriptBridge<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的 Stars 遥遥领先，自然选择它作为 OC 和 JS 的交互引擎了。</p> <p>本文是笔者了解 WebViewJavascriptBridge 过程中的一些学习记录，好记性不如烂笔头嘛！</p> <h2 id="使用-webviewjavascriptbridge"><a href="#使用-webviewjavascriptbridge" class="header-anchor">#</a> 使用 WebViewJavascriptBridge</h2> <p>WebViewJavascriptBridge 的使用不难，<a href="https://github.com/marcuswestin/WebViewJavascriptBridge" target="_blank" rel="noopener noreferrer">WebViewJavascriptBridge<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供的 Example 比较直观的展示了各种接口的使用。</p> <p>App 中嵌入 Web 一般需要使用 UIWebView（除非你自己写一个），WebViewJavascriptBridge 正是配合 UIWebView 进行工作的。</p> <p><strong>初始化</strong></p> <p>和其他第三库一样，使用 WebViewJavascriptBridge 需要做一些初始化，只是 WebViewJavascriptBridge 的初始化包括两部分：「Objective-C 初始化」和「JavaScript 初始化」。</p> <ul><li>OC 初始化</li></ul> <p>OC 中初始化 WebViewJavascriptBridge 的前提是存在一个 UIWebView 对象，每个 WebViewJavascriptBridge 对象都应该与一个 UIWebView 对象绑定。</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token comment">// 创建UIWebView对象</span>
UIWebView <span class="token operator">*</span> webView <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UIWebView alloc<span class="token punctuation">]</span> initWithFrame<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>bounds<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
<span class="token comment">// 配置logging</span>
<span class="token punctuation">[</span>WebViewJavascriptBridge enableLogging<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
<span class="token comment">// 创建WebViewJavascriptBridge对象并与UIWebView对象绑定</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>bridge <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    WebViewJavascriptBridge<span class="token operator">*</span> bridge <span class="token operator">=</span>
    <span class="token punctuation">[</span>WebViewJavascriptBridge bridgeForWebView<span class="token punctuation">:</span>webView
                              webViewDelegate<span class="token punctuation">:</span><span class="token keyword">self</span>
                                      handler<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id data<span class="token punctuation">,</span> WVJBResponseCallback responseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                          <span class="token comment">// do something</span>
                                          <span class="token comment">// responseCallback(responseData)</span>
                                      <span class="token punctuation">}</span>
     <span class="token punctuation">]</span><span class="token punctuation">;</span>
    bridge<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用类方法创建一个 WebViewJavascriptBridge 对象，其中有一个<code>block</code>类型的 handler。这个 handler 用来处理来自于 JavaScript 发送的消息，<strong>handler 的形参与 JavaScript 中的 send 方法的形参对应</strong>，一般有两个参数，第一个参数是 JS send 传入的参数（可以是任意类类型），第二个是 JS send 传入的回调 handler。</p> <p>P.S：看客可能像我当初一样不太理解第二个参数：responseCallback，后文会对此进行详细说明。</p> <ul><li>JS 初始化</li></ul> <p>除了 OC 外，JS 中也得执行针对 WebViewJavascriptBridge 的初始化代码。这意味着，除了客户端（iOS 开发人员）外，服务端（后端写 JS 的开发人员）也得对 WebViewJavascriptBridge 有所了解。好在需要理解的内容不多，十分钟就可以搞定。JavaScript 对 WebViewJavascriptBridge 初始化过程（这部分代码几乎是固定的）如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建了一个connectWebViewJavascriptBridge方法，该方法名是固定的</span>
<span class="token keyword">function</span> <span class="token function">connectWebViewJavascriptBridge</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>WebViewJavascriptBridge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>WebViewJavascriptBridge<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'WebViewJavascriptBridgeReady'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>WebViewJavascriptBridge<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
    
<span class="token comment">// 调用connectWebViewJavascriptBridge方法</span>
<span class="token function">connectWebViewJavascriptBridge</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">bridge</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bridge<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> responseCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// do something</span>
        <span class="token function">responseCallback</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>先创建了一个 connectWebViewJavascriptBridge 方法，该方法注册了一个 WebViewJavascriptBridgeReady 事件，同时声明了一个全局的 WebViewJavascriptBridge 变量，这样我们可以在外部通过 WebViewJavascriptBridge 调用相关方法。</p> <p>在<code>bridge.init</code>里面同样定义了一个匿名 function，这个 function 用来接收 Objective-C 里面通过 send 方法发送的消息的，参数与 OC 里的 send 方法参数对应。同样，一般有两个参数，第一个参数是 OC send 传入的参数（可以是任意类类型），第二个是 OC send 传入的回调 handler。</p> <p>可以简单总结一下。初始化的根本目的是啥？
根据我的理解，初始化的根本目的是：消息接收者定义<code>message handler</code>。</p> <p>P.S：请记住<code>message handler</code>这个名词，后文会经常用到。</p> <p><strong>发送消息</strong></p> <p>上述「初始化」操作的目的是为了确保 OC 和 JS 能够相互处理来自对方的消息。</p> <p>除了「初始化」操作之外，WebViewJavascriptBridge 对发送消息也有所约束，这意味着 OC 和 JS 发送消息必须得遵守一定的格式。</p> <ul><li>OC 向 JS 发送消息</li></ul> <p>OC 向 JS 发送消息，定义了两个用于「发送消息」的接口：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token comment">// APIs</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>send<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>data<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>send<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>data responseCallback<span class="token punctuation">:</span> <span class="token punctuation">(</span>WVJBResponseCallback<span class="token punctuation">)</span>responseCallback<span class="token punctuation">;</span>
</code></pre></div><p>两个接口的区别只是参数个数不同，参数 data 指的是「传给 JS 的参数」，responseCallback 参数是一个<code>block</code>，给 JS 发送消息后，JS 的<code>message handler</code>可能会返回一些值，responseCallback 就是用来处理***返回值***的。</p> <p>P.S：data 可以为空；这里的「返回值」并不是非常准确的说法，只是一种参考「函数」的说法，准确来讲应该叫<code>response data</code>。</p> <ul><li>JS 向 OC 发送消息</li></ul> <p>JS 向 OC 发送消息，WebViewJavascriptBridge 也定义了两种格式：</p> <div class="language-js extra-class"><pre class="language-js"><code>bridge<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
bridge<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">responseCallback</span><span class="token punctuation">(</span><span class="token parameter">responseData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>显然，无论是「OC 向 JS 发送消息」，还是「JS 向 OC 发送消息」，都有两种格式，含有<code>responseCallback</code>和不含<code>responseCallback</code>。</p> <p>P.S：data 可以为空；</p> <p><strong>理解 responseCallback</strong></p> <p>上文已经多次提到了<code>responseCallback</code>，可能是由于笔者对跨平台了解得比较少，也可能是对函数式编程了解不多，刚开始对<code>responseCallback</code>不甚理解。这一小段将对<code>responseCallback</code>进行详细阐述。</p> <p>关于「消息处理」和「消息发送」，我是参考「函数定义」和「函数调用」这两个概念来理解的。「函数定义」定义了函数的具体工作（即说明这段代码块都干了些啥），「函数调用」指示执行具体代码块；根据我的理解，从概念上讲，「消息处理」对应「函数定义」，「消息发送」对应「函数调用」。</p> <p>这段话非常啰嗦，但引入这么一种对应关系是为了更好说明<code>responseCallback</code>。</p> <p>对于函数（广义上的「函数」，而不仅仅指 JavaScript function）来说，函数可能有返回值，也可能没有返回值。当有返回值时，调用者往往会定义变量接收返回值，方便之后使用返回值...而上文中反复出现的<code>responseCallback</code>有些类似于对函数返回值的处理，消息发送方向消息接收方发出一个消息，除了希望对方处理某些事情之外，可能还期待对方返回一些数据（<code>response data</code>），这些数据往往会在后续的处理中起作用。</p> <p>因此，若「消息接收方」的<code>message handler</code>中可能有需要传给「消息发送方」的<code>response data</code>时，「消息发送方」还需要定义一个 handler 用来处理这些值，即所谓的<code>responseCallBack</code>。</p> <p>P.S：为什么函数处理返回值使用<code>ret = aFunction(variable)</code>这样的格式，而这里使用<code>responseCallBack</code>处理呢？我想是因为这里处理的是两种不同语言，过程中难免存在类型转换，况且，还有可能是由于并发。</p> <p>对于函数而言，若某个函数有返回值，但调用者不想要保存该返回值，此时往往不会定义变量接收该返回。这在大多属于语言中是被允许的。</p> <p>对于 WebViewJavascriptBridge 也一样，「消息发送方」发送消息时，可以不传入 responseCallback 参数，表示对「消息接收方」的<code>response data</code>不 care。</p> <p>在定义<code>message handler</code>时，在 handler 的<code>responseCallback(responseData)</code>好比函数中<code>return ret</code>。</p> <p>P.S：在定义<code>message handler</code>时，并不要求一定有<code>responseCallback(responseData)</code>这么一句代码；只是个人觉得，有必要写上，哪怕没有任何<code>response data</code>需要返回，也得加上<code>responseCallback(null)</code>。类似于函数，若某个函数没有返回值，也没有显式调用<code>return</code>语句，在编译阶段，编译器也会帮助在末尾加上<code>return void</code>。</p> <p>理清了<code>responseCallback</code>这个概念，就基本上算是学会使用 WebViewJavascriptBridge 了。</p> <p><strong>OC 和 JS 互相调用</strong></p> <p>「OC 和 JS 互相调用」指的是 OC 和 JS 互相对应对方的 handler（block 或 function）。</p> <p>笔者刚开始觉得啰嗦：既然「消息机制」能够解决 OC 和 JS 交互问题，为啥还需要 OC 和 JS 互相调用对方的 handler 呢？</p> <p>我还没有找到比较权威的的说法，但这里也谈谈自己的一点理解。</p> <p>先说「函数」，「函数」的本质不过是代码的一种组织结构，它使得代码块具有了更好的可读性，同时极大加强代码复用。</p> <p>基于「消息机制」，我们可以尽可能实现任何基于文本交互。可以做的事情非常丰富，譬如「消息发送者」传入参数<code>1</code>，<code>message handler</code>执行 A 段代码，传入参数<code>2</code>，执行 B 段代码。但问题是：基于「消息机制」，OC 和 JS 之间的几乎所有交互任务都得写在<code>message handler</code>中。当交互任务变得复杂时，代码组织将是一种灾难（会充斥很长并且嵌套很深的<code>if</code>语句）。以消息的第一个参数 data 为例，有时候，data 可能是一个 URL 字符串，有时候可能是一个 JSON 字符串，有时候可能只是一个数值，光是解析这些参数，都需要一个非常复杂的<code>if</code>语句...写到这里，「在 OC 和 JS 中定义能被对方调用的 handler」的意义就不需要多讲了。</p> <p>关于「OC 和 JS 互相调用」，WebViewJavascriptBridge 也定义了一些约束。约束包括两部分：定义 handler 的姿势，调用 handler 的姿势。</p> <p><strong>OC 定义和调用 JS handler</strong></p> <p>所谓定义 handler，其实是向 bridge 注册一个 handler，如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token comment">// API</span>
<span class="token comment">// - (void)registerHandler:(NSString *)handlerName handler:(WVJBHandler)handler</span>
    
<span class="token comment">// eg:</span>
<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>bridge registerHandler<span class="token punctuation">:</span><span class="token string">@&quot;OCHandlerName&quot;</span>
                     handler<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id data<span class="token punctuation">,</span> WVJBResponseCallback responseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                         <span class="token comment">// do something</span>
                         <span class="token function">responseCallback</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
 <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>向 bridge 注册 handler 包括两部分内容：name 和 handler body。</p> <p>调用 JS 的 handler 也简单，如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token comment">// APIs</span>
<span class="token comment">// - (void)callHandler:(NSString *)handlerName;</span>
<span class="token comment">// - (void)callHandler:(NSString*)handlerName data:(id)data;</span>
<span class="token comment">// - (void)callHandler:(NSString*)handlerName data:(id)data responseCallback:(WVJBResponseCallback)responseCallback;</span>
    
<span class="token comment">// eg：</span>
<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>bridge callHandler<span class="token punctuation">:</span><span class="token string">@&quot;JSHandlerName&quot;</span> data<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>JS 定义和调用 OC handler</strong></p> <p>在 JS 定义（注册）handler 的姿势如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>bridge<span class="token punctuation">.</span><span class="token function">registerHandler</span><span class="token punctuation">(</span><span class="token string">&quot;handlerName&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">responseData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>调用 OC 的 handler 也简单，和 OC 调用 JS handler 类似。</p> <p>。。。。。。</p> <p>本文写得好啰嗦啊！</p> <h2 id="本文参考"><a href="#本文参考" class="header-anchor">#</a> 本文参考</h2> <ul><li><a href="https://github.com/marcuswestin/WebViewJavascriptBridge" target="_blank" rel="noopener noreferrer">WebViewJavascriptBridge - github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://dxldy.iteye.com/blog/2078350?utm_source=tuicool" target="_blank" rel="noopener noreferrer">《WebViewJavascriptBridge 使用说明（iOS）》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://honglu.me/2014/09/27/WebViewJavascriptBridge%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener noreferrer">《WebViewJavascriptBridge 使用》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/108.efc3ce89.js" defer></script>
  </body>
</html>
