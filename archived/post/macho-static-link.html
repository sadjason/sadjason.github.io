<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mach-O 与静态链接 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/78.63e767ab.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">Mach-O 与静态链接</div> <div class="post-info">2018-10-13</div></div> <div class="content content__default"><p>本文以《深入理解计算机系统》第七章「链接」为纲，以《程序员的自我修养》为主要参考，以 Mach-O 文件为研究对象，旨在整理静态链接相关的知识。</p> <p></p><div class="table-of-contents"><ul><li><a href="#概述">概述</a><ul><li><a href="#符号-模块">符号 &amp; 模块</a></li><li><a href="#静态链接">静态链接</a></li><li><a href="#rip-relative-寻址">RIP-relative 寻址</a></li></ul></li><li><a href="#中间文件的符号分析">中间文件的符号分析</a><ul><li><a href="#relocation-symbol-table">Relocation Symbol Table</a></li><li><a href="#symbol-table">Symbol Table</a></li></ul></li><li><a href="#可执行文件的符号分析">可执行文件的符号分析</a></li></ul></div><p></p> <blockquote><p>下一篇<a href="/post/macho-dynamic-link.html">Mach-O 与动态链接</a>分析 Mach-O 动态链接相关内容。</p></blockquote> <h1 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h1> <p>本文的核心主题是静态链接，这一部分会对静态链接的内容做一个概述；在介绍链接之前，有必要先理清两个基本概念：符号、模块。</p> <h2 id="符号-模块"><a href="#符号-模块" class="header-anchor">#</a> 符号 &amp; 模块</h2> <p>先说符号（symbol）。计算机世界里的符号概念起源于汇编，在汇编之前，远古大神的代码都是机器代码，机器代码充满了各种各样的数值，这些数值描述着指令、操作数、地址值；可以想到，全是数值的机器代码可读性非常糟糕；对于地址值而言，当程序变更时，地址值就得重新计算，这种操作实在过于黑暗，于是先驱者发明了汇编语言，使用符号来帮助记忆，如下：</p> <div class="language-asm6502 extra-class"><pre class="language-asm6502"><code><span class="token opcode property">jmp</span> foo
foo:
  addl $<span class="token decimalnumber string">4</span>, %ecx
</code></pre></div><p><code>jmp</code>符号表示跳转指令，<code>foo</code>符号描述子程序的地址；无论<code>foo</code>前插入还是减少了代码，程序员无需关心它的具体地址值，汇编器在汇编时会自动计算，极大解放生产力。</p> <p>对于表示地址值的符号而言，可以把它理解为键值对，符号是 key，地址值是 value。在之后的计算机发展中，「符号」表达的意思基本上没有变化。</p> <p>再说模块。稍有规模的现代项目源码，常被按照功能或性质进行划分，分别形成不同的功能模块，不同的模块之间按照层级结构或其他结构来组织。譬如，在 C 语言，若干个变量和函数组成一个模块，存放在一个<code>.c</code>的源码文件中，然后这些源代码文件按照目录结构来组织。</p> <blockquote><p>对于 Objective-C 项目，每个<code>.m</code>或者<code>.mm</code>文件构成一个模块。</p></blockquote> <p>大规模软件往往拥有成千上万个模块，这些模块相互依赖又相互独立。软件模块化有很多好处，譬如更易理解、重用等；对于编译器而言，其好处是每个模块可以单独编译，改变部分代码无需重新编译整个程序。</p> <p>当一个程序被切割成多个模块后，现代编译器会对每个模块进行单独编译，为每一个模块生成中间文件。这些中间文件终究会被组合形成一个单一的可执行文件。</p> <p>将程序各个模块的中间文件组合形成一个单一的可执行文件并不是一件容易的事情，因为模块间往往会互相依赖，或者说它们之间存在通信。因此，从编译器的角度看，模块之间如何组合的问题可以归结为处理模块间通信的问题。对于静态语言 C/C++ 而言，模块间的通信方式有两种：一种是模块间的函数调用，另外一种是模块间的变量访问；函数访问需知道目标函数的地址，变量访问也须知道目标变量的地址，所以这两种方式都可以归结为一种方式：模块间符号的引用。</p> <h2 id="静态链接"><a href="#静态链接" class="header-anchor">#</a> 静态链接</h2> <p>上文铺垫了符号和模块的概念，现在来说说静态链接。所谓静态链接，其本质是把程序各个模块的中间文件粘在一起，拼装成一个整体；换句话说，以模块的中间文件为输入，产生一个新的 Mach-O 文件（往往是可执行文件）。链接的主要内容就是把各个模块之间相互引用的部分都处理好，使得各个模块之间能够正确地衔接，从原理上讲，即把一些指令对其他符号地址的引用加以修正。按照《程序员的自我修养》的说法，静态链接主要过程包括：</p> <ul><li>地址和空间分配（Address and Storage Allocation）</li> <li>符号决议（Symbol Resolution）</li> <li>重定位（Relocation）</li></ul> <p>其中最核心也最值得拧出来分析的是「重定位」过程。静态链接的重定位是围绕符号进行的，私以为，搞清楚了 Mach-O 文件中的符号，也就搞清楚了静态链接。</p> <p>接下来的重心是对中间文件以及可执行文件的符号进行分析。</p> <h2 id="rip-relative-寻址"><a href="#rip-relative-寻址" class="header-anchor">#</a> RIP-relative 寻址</h2> <p>本文所在环境的系统架构是 x86-64，很多指令的寻址方式是 RIP-relative 寻址。虽然笔者对汇编不甚熟悉，但是为了后续分析和阅读方便，还是得花些笔墨整理一下 RIP-relative 寻址相关内容。</p> <blockquote><p>RIP 的全拼是：Relative Instruction Pointer</p></blockquote> <p>按照笔者的粗浅理解，基于 RIP 计算目标地址时，目标地址等于当前指令的下一条指令所在地址加上偏移量。简单来说，若看到如下二进制的反汇编内容：</p> <div class="language-asm6502 extra-class"><pre class="language-asm6502"><code><span class="token decimalnumber string">0000000000001</span>fcd  jmpq  <span class="token decimalnumber string">0</span><span class="token register variable">x</span><span class="token decimalnumber string">2</span>d(%rip)
<span class="token decimalnumber string">0000000000001</span>fd<span class="token decimalnumber string">3</span>  <span class="token opcode property">nop</span>
</code></pre></div><p>则第一行代码 jmpq 的跳转目标地址是：0x1fd3 + 0x2d = 0x2000。</p> <p>关于RIP-relative 的更多内容可参考：</p> <ul><li><a href="https://blog.csdn.net/yeshahayes/article/details/51930610" target="_blank" rel="noopener noreferrer">64位下的相对指令地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://xem.github.io/minix86/manual/intel-x86-and-64-manual-vol2/o_b5573232dd8f1481-72.html" target="_blank" rel="noopener noreferrer">Intel x86-64 Manual Vol2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h1 id="中间文件的符号分析"><a href="#中间文件的符号分析" class="header-anchor">#</a> 中间文件的符号分析</h1> <p>Mach-O 的文件类型有很多种（详见<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/EXTERNAL_HEADERS/mach-o/loader.h" target="_blank" rel="noopener noreferrer">mach-o/loader.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 里以<code>MH_</code>为前缀的 type 宏），常见的有：</p> <ul><li><code>MH_OBJECT</code>: 中间文件</li> <li><code>MH_EXECUTE</code>: 可执行文件</li></ul> <blockquote><p>曾在<a href="/post/macho-structure.html">Mach-O 简单分析</a>中分析了 Mach-O 文件的结构，相关内容不再赘述。</p></blockquote> <p>上文多处提到「中间文件」，它其实就是一种<code>MH_OBJECT</code>类型的 Mach-O 文件，还常被称作「中间目标文件」「可重定位文件」，通常以<code>.o</code>为后缀，</p> <p>这一部分重点分析中间文件与符号相关的结构。将使用下面两个源代码文件 a.c 和 b.c 作为例子展开分析：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* a.c */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> shared<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* b.c */</span>
<span class="token keyword">int</span> shared <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>a <span class="token operator">=</span> <span class="token operator">&amp;</span>b<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>b <span class="token operator">=</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从代码中可以看到，<code>b.c</code>总共定义了两个全局符号，一个是变量<code>shared</code>，另外一个是函数<code>swap</code>；<code>a.c</code>里面定义了一个全局符号<code>main</code>；后者引用了前者的俩符号。</p> <p>使用 gcc 将这俩文件分别编译成目标文件 a.o 和 b.o :</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ gcc -c a.c b.c
<span class="token comment"># 生成 a.o 和 b.o</span>
</code></pre></div><p>先看看<code>a.o</code>的 __TEXT __text 的反汇编内容：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/a_o_machoview.png" srcset="/image/a_o_machoview.png 2x" data-v-339c7bd5></div> <blockquote><p>本文对 Mach-O 文件的查看主要使用 MachOView 工具。</p></blockquote> <p>图中使用红框标记了<code>a.o</code>中的两处符号引用，分别对应 movq 操作和 callq 操作：</p> <ul><li><code>48 8B35 00000000</code>: 其中<code>48</code>是 movq 的操作码，<code>00000000</code>描述<code>_shared</code>的符号值（地址值）</li> <li><code>E8 00000000</code>: 其中<code>E8</code>是 callq 的的操作码，<code>00000000</code>描述<code>_swap</code>的符号值（地址值）</li></ul> <blockquote><p><code>gcc</code>编译器中的符号名，通常都含有<code>_</code>前缀。</p></blockquote> <p>可以看到，在<code>a.o</code>的代码段，该符号对应的地址值都被置为<code>0</code>。</p> <p>问题来了，编译器对中间文件进行链接时，如何知道该对哪些指令进行地址调整呢？这些指令的哪些部分要被调整呢？又该如何调整呢？</p> <p>Relocation Symbol Table 正是解决这个问题的。</p> <h2 id="relocation-symbol-table"><a href="#relocation-symbol-table" class="header-anchor">#</a> Relocation Symbol Table</h2> <p>在每个可重定位的 Mach-O 文件中，有一个叫重定位（Relocation）的区域，专门用来保存这些和重定位相关的信息。</p> <p>某个 section 如果内含需要被重定位的字节，就会有一个 relocation table 与此对应：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/a_o_relocation_table.png" srcset="/image/a_o_relocation_table.png 2x" data-v-339c7bd5></div> <p>在<a href="/post/macho-structure.html">Mach-O 简单分析</a>里介绍过 section 的结构（相关结构体定义于<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/EXTERNAL_HEADERS/mach-o/loader.h" target="_blank" rel="noopener noreferrer">mach-o/loader.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中的 section_64），其中有两个字段描述了其对应的relocation table：</p> <ul><li><code>reloff</code>: relocation table 的 file offset</li> <li><code>nreloc</code>: relocation table 的 entry 数量</li></ul> <p>Relocation table可以看作是一个 relocation entry 的数组，每个 relocation entry 占 8 个字节：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/a_o_relocation_entries.png" srcset="/image/a_o_relocation_entries.png 2x" data-v-339c7bd5></div> <p>对应结构体是<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/EXTERNAL_HEADERS/mach-o/reloc.h" target="_blank" rel="noopener noreferrer">relocation_info<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">relocation_info</span> <span class="token punctuation">{</span>
    int32_t   r_address<span class="token punctuation">;</span>      <span class="token comment">/* offset in the section to what is being relocated */</span>
    uint32_t  r_symbolnum<span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token comment">/* symbol index if r_extern == 1 or section ordinal if r_extern == 0 */</span>
              r_pcrel<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>      <span class="token comment">/* was relocated pc relative already */</span>
              r_length<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token comment">/* 0=byte, 1=word, 2=long, 3=quad */</span>
              r_extern<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token comment">/* does not include value of sym referenced */</span>
              r_type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>       <span class="token comment">/* if not 0, machine specific relocation type */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>对这几个字段稍作说明：</p> <ul><li><code>r_address</code>和<code>r_length</code>字段描述了需要被 relocation 的字节范围，其中<code>r_address</code>是相对于 section 的偏移量</li> <li><code>r_pcrel</code>表示地址值是 PC 相对地址值</li> <li><code>r_extern</code>标记该符号是否是外部符号</li> <li><code>r_symbolnum</code>，index 值，对于外部符号，它描述了符号在 symbol table 中的位置；如果是内部符号，它描述了符号所在的 section 的index</li> <li><code>r_type</code>，符号类型</li></ul> <h2 id="symbol-table"><a href="#symbol-table" class="header-anchor">#</a> Symbol Table</h2> <p>从上文的<code>r_symbolnum</code>可以看出，<code>relocation_info</code>并未完整描述符号信息，它只是告诉链接器哪些指令需要调整地址。符号的具体信息（包括符号名等）在 symbol table 中：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/a_o_symbol_table.png" srcset="/image/a_o_symbol_table.png 2x" data-v-339c7bd5></div> <p>Symbol table 由谁定义呢？或者说，链接器是如何找到 symbol table 的呢？链接器是通过 LC_SYMTAB 这个 load command 找到 symbol table 的，关于 load command，在<a href="/post/macho-structure.html">Mach-O 简单分析</a>里有过介绍，此处不再赘述；LC_SYMTAB 对应的 command 结构体如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">symtab_command</span> <span class="token punctuation">{</span>
    uint32_t cmd<span class="token punctuation">;</span>     <span class="token comment">/* LC_SYMTAB */</span>
    uint32_t cmdsize<span class="token punctuation">;</span> <span class="token comment">/* sizeof(struct symtab_command) */</span>
    uint32_t symoff<span class="token punctuation">;</span>  <span class="token comment">/* symbol table offset */</span>
    uint32_t nsyms<span class="token punctuation">;</span>   <span class="token comment">/* number of symbol table entries */</span>
    uint32_t stroff<span class="token punctuation">;</span>  <span class="token comment">/* string table offset */</span>
    uint32_t strsize<span class="token punctuation">;</span> <span class="token comment">/* string table size in bytes */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这个命令告诉了链接器（无论是本文所述的静态链接器，还是后面博客要提到的动态链接器） symbol table 和 string table 的位置信息；<code>symtab_command</code>这个结构体比较简单，<code>symoff</code>和<code>nsyms</code>指示了符号表的位置和条目，<code>stroff</code>和<code>strsize</code>指示了字符串表的位置和长度。</p> <p>每个 symbol entry 长度是固定的，其结构由内核定义，详见<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/EXTERNAL_HEADERS/mach-o/nlist.h" target="_blank" rel="noopener noreferrer">nlist.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">nlist_64</span> <span class="token punctuation">{</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        uint32_t n_strx<span class="token punctuation">;</span>   <span class="token comment">/* index into the string table */</span>
    <span class="token punctuation">}</span> n_un<span class="token punctuation">;</span>
    uint8_t  n_type<span class="token punctuation">;</span>       <span class="token comment">/* type flag, see below */</span>
    uint8_t  n_sect<span class="token punctuation">;</span>       <span class="token comment">/* section number or NO_SECT */</span>
    uint16_t n_desc<span class="token punctuation">;</span>       <span class="token comment">/* see &lt;mach-o/stab.h&gt; */</span>
    uint64_t n_value<span class="token punctuation">;</span>      <span class="token comment">/* value of this symbol (or stab offset) */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>结构体<code>nlist_64</code>（或<code>nlist</code>）描述了符号的基本信息，xnu 用 5 个字段描述了symbol信息，其中<code>n_un</code>、<code>n_sect</code>、<code>n_value</code>比较容易理解：</p> <ul><li><code>n_un</code>，符号的名字（在一个 Mach-O 文件里，具有唯一性）</li> <li><code>n_sect</code>，符号所在的 section index（内部符号有效值从 1 开始，最大为 255）</li> <li><code>n_value</code>，符号的地址值（在链接过程中，会随着其 section 发生变化）</li></ul> <p><code>n_type</code>和<code>n_desc</code>表达的意思稍微复杂点；都是多功能组合字段，其中，对于中间文件而言，<code>n_desc</code>没啥意义，此乃个人理解。如下关于<code>n_type</code>的信息也是我的个人梳理，主要参考<a href="https://developer.apple.com/documentation/kernel/nlist_64/" target="_blank" rel="noopener noreferrer">kernel/nlist_64<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/EXTERNAL_HEADERS/mach-o/nlist.h" target="_blank" rel="noopener noreferrer">nlist.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。<code>n_type</code>是一个 8 bit 的复合字段：</p> <ul><li><code>bit[5:8]</code>: 如果不为 0，表示这是一个与调试有关的符号，值意义类型详见<a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/EXTERNAL_HEADERS/mach-o/stab.h" target="_blank" rel="noopener noreferrer">mach-o/stab.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>bit[4:5]</code>: 若为 1，则表示该符号是私有的（外部符号）</li> <li><code>bit[1:4]</code>: 符号类型
<ul><li><code>N_UNDF</code> (0x0): 未定义</li> <li><code>N_ABS</code> (0x2): 符号地址指向到绝对地址，链接器后期不会再修改</li> <li><code>N_SECT</code> (0xe): 本地符号，即符号定义于当前 Mach-O</li> <li><code>N_PBUD</code> (0xc): 预绑定符号</li> <li><code>N_INDR</code> (0xa): 表示该符号和另一个符号是同一个，<code>n_value</code>指向到 string table，即该同名符号的名字</li></ul></li> <li><code>bit[0:1]</code>: 表示这是外部符号，即该符号要么定义在外部，要么定义在本地但是可以被外部使用</li></ul> <p>有了 relocation table 和 symbol table，链接器就与足够的信息进行链接处理了。</p> <h1 id="可执行文件的符号分析"><a href="#可执行文件的符号分析" class="header-anchor">#</a> 可执行文件的符号分析</h1> <p>先使用<code>ld</code>工具（静态链接器）对如上 a.o、b.o 进行链接，生成可执行文件：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ld a.o b.o -macosx_version_min <span class="token number">10.14</span> -o ab.out -lSystem
<span class="token comment"># 生成可执行文件 ab.out</span>
</code></pre></div><p>使用 MachOView 工具查看可执行文件 ab.out 的代码段 __TEXT __text 的反汇编内容，如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/ab_macho_text.png" srcset="/image/ab_macho_text.png 2x" data-v-339c7bd5></div> <p>图中红线部分分别是符号<code>_shared</code>和<code>_swap</code>对应的地址，链接前，a.o 中此两处的地址值均为0；在 ab.out 中，链接器根据 a.o 的 relocation table 的信息，对此两处地址进行了调整，将它们修改为有效地址。</p> <p>花些时间分析修正后<code>_shared</code>和<code>_swap</code>所对应的文件偏移地址。</p> <p>先看<code>_shared</code>，其所在指令的下一条指令相对于文件的偏移地址是 0x00000F83，相对偏移是 0x0000007D（小端），计算得到的<code>_shared</code>符号的地址值等于 0x00001000，该地址值对应的是 ab.out 中的 __DATA __data :</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/ab_shared_addr.png" srcset="/image/ab_shared_addr.png 2x" data-v-339c7bd5></div> <p>该地址所存储的值 0x0000002A（小端）恰好等于 42。</p> <p>对于<code>_swap</code>符号也是类似，其所在指令的下一条指令相对于文件的偏移地址是 0x00000F96，相对偏移是 0x0000000A，计算得到的目标地址值等于 0x00000FA0，恰好是<code>_swap</code>子程序的起始地址。</p> <p>另外一个需要注意到的事实是：ab.out 中再也没有 relocation table 了，这不难理解，ab.out 中的符号都得到了重定位，relocation table 已经没有存在的必要了。</p> <p>Relocation table 没有了，symbol table 呢？令人震惊的是，ab.out 的 symbol table 中条目更多了：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/ab_symbol_entries.png" srcset="/image/ab_symbol_entries.png 2x" data-v-339c7bd5></div> <p>其中的<code>_main</code>、<code>_shared</code>、<code>_swap</code>我们是熟悉的，另外两个是啥？没有查到关于<code>__mh_execute_header</code>特别权威的资料，目测与虚拟地址有关，简单来说，Mach-O 某个字节的虚拟地址等于<code>__mh_execute_header</code>的地址值加上该字节在 Mach-O 文件中的 file offset；对于<code>dyld_stub_binder</code>，它和动态链接有关，后面博客讲动态链接时再说。</p> <p>现在的问题是：ab.out 中<code>_main</code>、<code>_shared</code>、<code>_swap</code>这几个 symbol entry 存在的意义是啥？</p> <p>我的理解是：如果从程序正常运行的角度来看，这几个符号没啥用。事实上，使用<code>strip</code>工具可以将这几个 symbol entry 从 symbol table 中抹掉。</p> <p>最后，我的总体感受是：理解静态链接的关键在于理解符号，还是蛮容易的。</p></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/78.63e767ab.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
