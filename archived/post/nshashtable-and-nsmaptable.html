<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NSHashtable 和 NSMaptable | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/88.9ca6511c.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/4.a7413ce2.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">NSHashtable 和 NSMaptable</div> <div class="post-info">2015-04-26 • iOS</div></div> <div class="content content__default"><p><strong>说明</strong></p> <p>本文转自《<a href="http://www.cocoachina.com/industry/20140605/8683.html" target="_blank" rel="noopener noreferrer">NSHashtable and NSMaptable<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>》，其原作者是<a href="http://nshipster.com/nshashtable-and-nsmaptable/" target="_blank" rel="noopener noreferrer">Mattt Thompson<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，该大神是 AFNetworking 的作者。作者简单介绍了一下 iOS 开发中相对于 NSDictionary 和 NSSet 来说，不常被人使用 NSHashTable 和 NSMapTable 的相关知识。</p> <blockquote><p>P.S: 笔者关注《<a href="http://www.cocoachina.com/industry/20140605/8683.html" target="_blank" rel="noopener noreferrer">NSHashtable and NSMaptable<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>》这篇博客的原因是因为以前遇到「如何实现 NSNotificationCenter」这样的问题，我意识到实现 NSNotificationCenter 的关键在于找到一个能够支持弱指针的容器，而 NSHashTable 和 NSMaptable 恰好是这样的容器。</p></blockquote> <p>NSSet，NSDictionary，NSArray 是 Foundation 框架关于集合操作的常用类，和<a href="http://en.wikipedia.org/wiki/Java_collections_framework" target="_blank" rel="noopener noreferrer">其他标准的集合操作库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>不同，他们的实现方法对开发者进行<a href="http://ridiculousfish.com/blog/posts/array.html" target="_blank" rel="noopener noreferrer">隐藏<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，只允许开发者写一些简单的代码，让他们相信这些代码有理由正常的工作。</p> <p>然而这样的话最好的代码抽象风格就会被打破，苹果的本意也被曲解了。在这种情况下，开发者寻求更好的抽象方式来使用集合，或者说寻找一种更通用的方式。</p> <p>对于 NSSet 和 NSDictionary，打破代码抽象风格的是他们在内存中存取 object 的方式。在 NSSet 中，objects 是被强引用的（strongly referenced），同样 NSDictionary 中的 keys 和 values 也会被 NSDictionary 复制。如果一个开发者想要存储一个 weak 类型的值或者使用一个没有实现 NSCopying 协议的 object 作为 NSDictionary 的 key，他可能会很聪明的想到<a href="http://nshipster.com/nsvalue/" target="_blank" rel="noopener noreferrer">NSValue+valueWithNonretainedObject<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。 iOS6 和 OSX 10.5 以后，可以分别使用和 NSSet，NSDictionary 地位相同的 NSHashTable，NSMapTable。</p> <p>这两个类在 Foundation 的 collection 中不常用到，为了避免你慌乱无措，下面将介绍这两个类的用法。</p> <h2 id="nshashtable"><a href="#nshashtable" class="header-anchor">#</a> NSHashTable</h2> <p>NSHashTable 是更广泛意义的 NSSet，区别于 NSSet/NSMutableSet，NSHashTable 有如下特性：</p> <ul><li>NSHashTable 是可变的；</li> <li>NSHashTable 可以持有 weak 类型的成员变量；</li> <li>NSHashTable 可以在添加成员变量的时候复制成员；</li> <li>NSHashTable 可以随意的存储指针并且利用指针的唯一性来进行 hash 同一性检查（检查成员变量是否有重复）和对比操作（equal）；</li></ul> <p>用法如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>NSHashTable <span class="token operator">*</span>hashTable <span class="token operator">=</span> <span class="token punctuation">[</span>NSHashTable hashTableWithOptions<span class="token punctuation">:</span>NSPointerFunctionsCopyIn<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>hashTable addObject<span class="token punctuation">:</span><span class="token string">@&quot;foo&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>hashTable addObject<span class="token punctuation">:</span><span class="token string">@&quot;bar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token punctuation">[</span>hashTable addObject<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>hashTable removeObject<span class="token punctuation">:</span><span class="token string">@&quot;bar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;Members: %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>hashTable allObjects<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>NSHashTable 是根据一个 option 参数来进行初始化的，因为从 OSX 平台上移植到 iOS 平台上，原来 OSX 平台上使用的枚举类型被放弃了，从而用 option 来代替，命名也发生了一些变化：</p> <ul><li>NSHashTableStrongMemory</li></ul> <p>等同于 NSPointerFunctionsStrongMemory。对成员变量进行强引用，这是一个默认值，如果采用这个默认值，NSHashTable 和 NSSet 就没什么区别了。</p> <ul><li>NSHashTableWeakMemory</li></ul> <p>等同于 NSPointerFunctionsWeakMemory。对成员变量进行弱引用，使用 NSPointerFunctionsWeakMemory，object 引用在最后释放的时候会被指向 NULL。</p> <ul><li>NSHashTableZeroingWeakMemory</li></ul> <p>已被抛弃，使用 NSHashTableWeakMemory 代替。</p> <ul><li>NSHashTableCopyIn</li></ul> <p>在对象被加入集合之前进行复制（<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSPointerFunctions_Class/index.html#//apple_ref/occ/instp/NSPointerFunctions/acquireFunction" target="_blank" rel="noopener noreferrer">NSPointerFunction-acquireFunction<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），等同于 NSPointerFunctionsCopyIn。</p> <ul><li>NSHashTableObjectPointerPersonality</li></ul> <p>用指针来等同代替实际的值，当打印这个指针的时候相当于调用 description 方法。和 NSPointerFunctionsObjectPointerPersonality 等同。</p> <h2 id="nsmaptable"><a href="#nsmaptable" class="header-anchor">#</a> NSMapTable</h2> <p>NSMapTable 是对更广泛意义的 NSDictionary。和 NSDictionary/NSMutableDictionary 相比具有如下特性：</p> <ul><li>NSDictionary/NSMutableDictionary 会复制 keys 并且通过强引用 values 来实现存储；</li> <li>NSMapTable 是可变的；</li> <li>NSMapTable 可以通过弱引用来持有 keys 和 values，所以当 key 或者 value 被 deallocated 的时候，所存储的实体也会被移除；</li> <li>NSMapTable 可以在添加 value 的时候对 value 进行复制；</li></ul> <p>和 NSHashTable 类似，NSMapTable 可以随意的存储指针，并且利用指针的唯一性来进行对比和重复检查。</p> <p>用法：假设用 NSMapTable 来存储不用被复制的 keys 和被若引用的 value，这里的 value 就是某个 delegate 或者一种弱类型。</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>id delegate <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
NSMapTable <span class="token operator">*</span>mapTable <span class="token operator">=</span> <span class="token punctuation">[</span>NSMapTable mapTableWithKeyOptions<span class="token punctuation">:</span>NSMapTableStrongMemory
                                             valueOptions<span class="token punctuation">:</span>NSMapTableWeakMemory<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>mapTable setObject<span class="token punctuation">:</span>delegate forKey<span class="token punctuation">:</span><span class="token string">@&quot;foo&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;Keys: %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>mapTable keyEnumerator<span class="token punctuation">]</span> allObjects<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>看完上面几个小例子后，你可能会想 “为什么不使用 object subscripting 呢?”。一些激进的 NSHipster 估计已经开始动手写 NSMapTable 的 subscripting category 了。</p> <p><strong>那么为什么 NSMapTable 不能继承 subscripting？</strong></p> <p>来看看下面的代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>objectForKeyedSubscript<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token operator">&lt;</span>NSCopying<span class="token operator">&gt;</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setObject<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>obj forKeyedSubscript<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token operator">&lt;</span>NSCopying<span class="token operator">&gt;</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>
</code></pre></div><p><strong>注意：参数 key 是类型的</strong>。这对 NSDictionary NSMutableDictionary 来讲是非常有用的，但是我们不能臆断对 NSMapTable 也同样适用。我们陷入一个僵局：通过 id，我们不能利用 NSMapTable 实现 subscripting。如果 object subscripting 的代理方法放弃了约束，那么使用 NSMutableDictionary -setObject:forKeyedSubscript:的时候编译将得不到想要的结果。</p> <p>所以说实话，对比 NSMapTable 所处的位置，句法的方便和快捷并不是大数人所关注的。</p> <p>通常，记住编程不是为了让人更聪明，而是最大化抽象一个问题的能力。NSSet 和 NSDictionary 是非常伟大的类，他们能解决 99%的问题，也无疑是用来工作的正确工具。如果，然而你的问题牵扯到上述的内存问题时候，NSHashTable 和 NSMapTable 是值得一看的。</p></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/88.9ca6511c.js" defer></script>
  </body>
</html>
