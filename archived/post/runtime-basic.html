<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Runtime 预备知识 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/97.da22d13e.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">Runtime 预备知识</div> <div class="post-info">2015-04-30 • iOS</div></div> <div class="content content__default"><p>很早就知道了 Objective-C Runtime 这个概念，「Objective-C 奇技淫巧」「iOS 黑魔法」各种看起来很屌的主题中总会有它的身影；但一直没有深入去学习，一来觉得目前在实际项目中还没有必要了解，二来懒。但，若想成为一个合格的 iOS 开发者，这个东西是躲不过的，好吧，抡起胳膊开始吧，争取一点点把它整明白吧！</p> <p>和了解其他技术一样，在了解一个东西之前，我总是问自己，这个有啥实际意义？为什么要了解它？多自问一些问题，找到实际意义，在理解上总会容易一些，学习也自然更有目的性一些。</p> <p>好吧，看了十几篇博客和 iOS 文档，还是很容易针对 Objective-C Runtime 提出一些问题的，有了这些问题，理解 Objective-C Runtime 就自然不会过于枯燥了，譬如：</p> <ul><li>在 iOS 中调用方法为什么叫「发送消息」，为什么这个概念这么重要？</li> <li>KVO 的实现原理是什么，是否涉及 Objective-C Runtime？</li> <li>Category 的原理是什么？为什么其他语言中没有这个东东？</li> <li>Category 中以「关联对象」的方式添加动态属性的原理什么？</li></ul> <p>看了一些大牛的博客之后，对 Objective-C Runtime 的重要性在心里基本有谱了，但路要一步一步走，饭要一口一口吃，先将一些基础性的概念进行整理，消息转发、Method Swizzling 之类的高端东西放在之后的博客分析吧！</p> <h2 id="关于-objective-c-runtime"><a href="#关于-objective-c-runtime" class="header-anchor">#</a> 关于 Objective-C Runtime</h2> <p><strong>Runtime 的学习资源</strong></p> <p>Runtime 的学习资源非常丰富，下面是个人的一些整理：</p> <ul><li>《Objective-C Runtime Programming Guide》</li> <li><code>/usr/include/objc/</code>下的头文件，譬如<code>objc.h</code>，<code>runtime.h</code>，<code>NSObject.h</code>，<code>message.h</code>等；<code>/usr/include/objc/</code>下的头文件不多，都可以看一下</li> <li>《Effective Objective-C 2.0》</li> <li><a href="http://www.tuicool.com/articles/FRRVNv" target="_blank" rel="noopener noreferrer">理解 Objective-C Runtime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://blog.devtang.com/blog/2013/10/15/objective-c-object-model/" target="_blank" rel="noopener noreferrer">Objective-C 对象模型及应用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://blog.devtang.com/blog/2014/05/30/understand-tagged-pointer/" target="_blank" rel="noopener noreferrer">深入理解 Tagged Point<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/" target="_blank" rel="noopener noreferrer">Objective-C Runtime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Objective-C Runtime 系列博客：
<ul><li><a href="http://tech.glowing.com/cn/objective-c-runtime/" target="_blank" rel="noopener noreferrer">Objective C Runtime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://tech.glowing.com/cn/method-swizzling-aop/" target="_blank" rel="noopener noreferrer">Method Swizzling 和 AOP 实践<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://tech.glowing.com/cn/implement-kvo/" target="_blank" rel="noopener noreferrer">如何自己动手实现 KVO<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>刨根问底 Objective－C Runtime 系列博客：
<ul><li><a href="http://t.cn/R7HYfhz" target="_blank" rel="noopener noreferrer">刨根问底 Objective－C Runtime（1）－ Self &amp; Super<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://t.cn/R7QUSUE" target="_blank" rel="noopener noreferrer">刨根问底 Objective－C Runtime（2）－ Object &amp; Class &amp; Meta Class<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://t.cn/R7meOzE" target="_blank" rel="noopener noreferrer">刨根问底 Objective－C Runtime（3）－ 消息 和 Category<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://t.cn/R7mdOq1" target="_blank" rel="noopener noreferrer">刨根问底 Objective－C Runtime（4）－ 成员变量与属性<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li><a href="http://www.cnblogs.com/biosli/p/NSObject_inherit_2.html" target="_blank" rel="noopener noreferrer">继承自 NSObject 的不常用又很有用的函数（2）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <blockquote><p>P.S: 值得一提的是，Objective-C Runtime 是开源的，任何时候都能从<a href="http://opensource.apple.com" target="_blank" rel="noopener noreferrer">opensource<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中获取源代码。</p></blockquote> <p><strong>动态语言 v.s 静态语言</strong></p> <p>在网上阅读 Objective-C Runtime 相关的信息时都提到了「Objective-C 是一门动态语言...」「作为一门动态语言...」之类的字眼，这让我有些诧异。因为根据我之前的理解：虽然动态和静态语言都是相对的，但 Objective-C 怎么也不算动态语言吧！动态语言是 Python、Javascript 这种弱类型语言吧？！</p> <p>关于 Objective-C 是否是动态语言，笔者才疏学浅，不敢妄论，知乎中关于这个有讨论：<a href="http://www.zhihu.com/question/19970471" target="_blank" rel="noopener noreferrer">Objective-C 是动态语言吗？为什么？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>但无论如何，它比 C++、C 这类传统静态语言具备更多的动态特性，说它是动态语言或许不为过吧。暂时不纠结这个问题了，希望以后有更多的自信回答这个问题。跟随主流意见，暂时认为 Objective-C 是一门动态语言吧。</p> <p>P.S: 后来又仔细阅读了一下《Effective Objective-C 2.0》，其中对「Objective-C 是动态语言」有更好的佐证，后面阐述「Objective-C 的消息传递机制」时再补充说明吧！</p> <p>P.S: 关于 OC 是动态语言这个话题，总会少不了「动态特性」「动态类型」「动态绑定」这几个关键词的讨论分析，之前在《<a href="/post/basics-in-objective-c/#多态、动态类型和动态绑定">Objective-C 基础知识</a>》中进行了简单的概述。</p> <p><strong>Runtime 是什么</strong></p> <p>Runtime 是什么？为什么有 Runtime 这个东东？</p> <p>《Objective-C Runtime Programming Guide》的 introduction 的第一段就回答了这个问题：</p> <blockquote><p>The Objective-C language defers as many decisions as it can from compile time and link time to runtime. Whenever possible, it does things dynamically. This means that the language requires not just a compiler, but also a runtime system to execute the compiled code. The runtime system acts as a kind of operating system for the Objective-C language; it’s what makes the language work.</p></blockquote> <p>不过貌似不够清晰，<a href="http://www.tuicool.com/articles/FRRVNv" target="_blank" rel="noopener noreferrer">理解 Objective-C Runtime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中有更浅显的解释：</p> <blockquote><p>Objective-C 是面相运行时的语言（runtime oriented language），就是说它会尽可能的把编译和链接时要执行的逻辑延迟到运行时。这就给了你很大的灵活性，你可以按需要把消息重定向给合适的对象，你甚至可以交换方法的实现，等等；这就需要使用 runtime，runtime 可以做对象自省查看他们正在做的和不能做的（don't respond to）并且适当地分发消息。</p></blockquote> <blockquote><p>Objective-C 的 Runtime 是一个运行时库（Runtime Library），它是一个主要使用 C 和汇编写的库，为 C 添加了面相对象的能力并创造了 Objective-C。这就是说它在类信息（Class Information）中被加载，完成所有的方法分发，方法转发，等等。Objective-C runtime 创建了所有需要的结构体，让 Objective-C 的面相对象编程变为可能。</p></blockquote> <h2 id="关于-runtime-的一些术语"><a href="#关于-runtime-的一些术语" class="header-anchor">#</a> 关于 Runtime 的一些术语</h2> <p>各种 Runtime 资料中有很多术语，有些是以前认识但理解不深刻的，譬如<code>id</code>、<code>Class</code>，有些是很少接触的，譬如<code>isa</code>。</p> <p>为了更好地理解 Runtime，先了解 Runtime 的一些术语是非常必要的。</p> <p>首先简单提一下<code>objc_class</code>，它是一个结构体，其中包含一些类信息；然后是<code>objc_object</code>，它也是一个结构体，但它只包括一个条目 -- <code>isa</code>，后者是一个<code>objc_class</code>指针；</p> <p>其实，说到底，<code>NSObject</code>就是建立在<code>objc_class</code>这个结构体之上的，所以了解<code>objc_class</code>对于了解<code>NSObject</code>以及 Cocoa 的对象模型是非常重要的。</p> <p>P.S: <code>objc_class</code>和<code>isa</code>相对而言信息量比较大，后文再详细阐述。</p> <p>OK，接着来看建立在<code>objc_class</code>和<code>objc_object</code>基础之上的一些关键字。</p> <p><strong>Class</strong></p> <p><code>Class</code>（不是 class 哦），它在<code>&lt;objc/objc.h&gt;</code>中定义，如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/// An opaque type that represents an Objective-C class.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_class</span> <span class="token operator">*</span>Class<span class="token punctuation">;</span>
</code></pre></div><p>可以看到<code>Class</code>其实是一种指针类型，即用于指向<code>objc_class</code>结构体。<code>NSObject</code>中定义的方法<code>-(Class)class</code>用于返回其对应的<code>objc_class</code>结构体指针；</p> <p>除了<code>-(Class)class</code>方法之外，<code>NSObject</code>类中还有一些常见方法包含<code>Class</code>类型参数或者返回<code>Class</code>类型返回值，如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>Class<span class="token punctuation">)</span>class<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>isKindOfClass<span class="token punctuation">:</span><span class="token punctuation">(</span>Class<span class="token punctuation">)</span>aClass<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>isMemberOfClass<span class="token punctuation">:</span><span class="token punctuation">(</span>Class<span class="token punctuation">)</span>aClass<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>isSubclassOfClass<span class="token punctuation">:</span><span class="token punctuation">(</span>Class<span class="token punctuation">)</span>aClass<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>isSubclassOfClass<span class="token punctuation">:</span><span class="token punctuation">(</span>Class<span class="token punctuation">)</span>aClass<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>Class<span class="token punctuation">)</span>superclass<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>Class<span class="token punctuation">)</span>class<span class="token punctuation">;</span>
</code></pre></div><p><strong>id</strong></p> <p>对于有过 iOS 开发经验的人而言，<code>id</code>使用太广泛了，不过似乎对它还没有过比较深入的理解；事实上，一直以为<code>id</code>和<code>NSObject *</code>等价呢！现在看来，这种理解太 naive 了，它也在<code>&lt;objc/objc.h&gt;</code>中定义：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">objc_object</span> <span class="token punctuation">{</span>
    Class isa  OBJC_ISA_AVAILABILITY<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// objc_object也是一个只包含一个条目isa（指向objc_object结构体的指针）的结构体。</span>
    
<span class="token comment">/// A pointer to an instance of a class.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_object</span> <span class="token operator">*</span>id<span class="token punctuation">;</span>
</code></pre></div><p><strong>SEL</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/// An opaque type that represents a method selector.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_selector</span> <span class="token operator">*</span>SEL<span class="token punctuation">;</span>
</code></pre></div><p>没找到<code>objc_selector</code>的定义，但根据网友的描述：其实它就是个映射到方法的 C 字符串，可以用 Objc 编译器命令<code>@selector()</code>或者 Runtime 系统的<code>sel_registerName</code>函数来获得一个 SEL 类型的方法选择器（通常简称：选择子）。</p> <p>考虑到 Xcode 对<code>@selector</code>的支持比对<code>sel_registerName</code>的支持更好，所以<code>@selector</code>貌似用得更多一些，但有时候<code>sel_registerName</code>或许更简洁一些。</p> <p>譬如有一段代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>selectedViewController respondsToSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>isReadyForEditing<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    boolNumber <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>selectedViewController performSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>isReadyForEditing<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但当前上下文中没有<code>isReadyForEditing</code>这个方法，所以编译器会有警告；当然，可以有各种方式来关闭警告，如下是其中一种：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token macro property">#<span class="token directive keyword">pragma</span> clang diagnostic push</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> clang diagnostic ignored &quot;-Wundeclared-selector&quot;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>selectedViewController respondsToSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>isReadyForEditing<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    boolNumber <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>selectedViewController performSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>isReadyForEditing<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> clang diagnostic pop</span>
</code></pre></div><p>但此时，若改用<code>sel_registerName</code>，则这个警告就没了！</p> <p>P.S: 不晓得 Apple 更青睐于哪一个，个人感觉是<code>@selector</code>，因为<code>sel_registerName</code>的使用几乎没碰到过。</p> <p><strong>IMP</strong></p> <p>IMP 的定义如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/// A pointer to the function of a method implementation. </span>
<span class="token macro property">#<span class="token directive keyword">if</span> !OBJC_OLD_DISPATCH_PROTOTYPES</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>IMP<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token comment">/* id, SEL, ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token keyword">typedef</span> id <span class="token punctuation">(</span><span class="token operator">*</span>IMP<span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> SEL<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre></div><p>可以了解到，IMP 是一个函数指针。IMP 是 Implementation 的缩写，一个函数是由一个 selector(SEL)，和一个 implement(IML)组成的；Selector 相当于门牌号，而 Implement 才是真正的住户（函数实现）。理解 Selector 和 Implementation 的关系蛮重要的！</p> <p><strong>Method</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/// An opaque type that represents a method in a class definition.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_method</span> <span class="token operator">*</span>Method<span class="token punctuation">;</span>
</code></pre></div><p><strong>Ivar</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/// An opaque type that represents an instance variable.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_ivar</span> <span class="token operator">*</span>Ivar<span class="token punctuation">;</span>
</code></pre></div><p><strong>Category</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/// An opaque type that represents a category.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_category</span> <span class="token operator">*</span>Category<span class="token punctuation">;</span>
</code></pre></div><p><strong>objc_property_t</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/// An opaque type that represents an Objective-C declared property.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_property</span> <span class="token operator">*</span>objc_property_t<span class="token punctuation">;</span>
</code></pre></div><p>可以通过<code>class_copyPropertyList</code>和<code>protocol_copyPropertyList</code>方法来获取类（Class）和协议（Protocol）中的属性，获取属性之后，还可以使用<code>property_getName</code>获取属性的名字（C 字串）：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>objc_property_t <span class="token operator">*</span><span class="token function">class_copyPropertyList</span><span class="token punctuation">(</span>Class cls<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>outCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
objc_property_t <span class="token operator">*</span><span class="token function">protocol_copyPropertyList</span><span class="token punctuation">(</span>Protocol <span class="token operator">*</span>proto<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>outCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">property_getName</span><span class="token punctuation">(</span>objc_property_t property<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>举个例子：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> Student <span class="token punctuation">:</span> NSObject
    
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSString <span class="token operator">*</span>name<span class="token punctuation">;</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> NSUInteger age<span class="token punctuation">;</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> NSUInteger score<span class="token punctuation">;</span>
    
<span class="token keyword">@end</span>
    
<span class="token keyword">@implementation</span> Student
    
<span class="token keyword">@end</span>
    
<span class="token keyword">@interface</span> ViewController <span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token keyword">@end</span>
    
<span class="token keyword">@implementation</span> ViewController
    
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> outCount<span class="token punctuation">;</span>
    objc_property_t <span class="token operator">*</span>aProperty <span class="token operator">=</span> <span class="token function">class_copyPropertyList</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Student class<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>outCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;一共有%d个属性，它们的名字分别是：&quot;</span><span class="token punctuation">,</span> outCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        objc_property_t aP <span class="token operator">=</span> aProperty<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> property_name <span class="token operator">=</span> <span class="token function">property_getName</span><span class="token punctuation">(</span>aP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%s&quot;</span><span class="token punctuation">,</span> property_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">@end</span>

<span class="token comment">/*输出：
Student类一共有3个属性，它们的名字分别是：
name
age
score
*/</span>
</code></pre></div><p>这个示例的执行结果也从侧面反映出了，<code>NSObject</code>中没有定义属性（只有一个叫<code>isa</code>成员变量）。</p> <p>P.S: 属性 v.s 成员变量？这里留个尾巴，以后把这个问题也分析一下吧！</p> <h2 id="objc-class-和-isa"><a href="#objc-class-和-isa" class="header-anchor">#</a> objc_class 和 isa</h2> <p>把<code>objc_class</code>和<code>isa</code>单独拧出来的原因是它们的信息量比较大，稍微复杂一点！</p> <p>Objective-C 是一种面向对象的语言。按照面向对象语言的设计原则，所有事物都应该是对象（严格来说 Objective-C 并没有完全做到这一点，因为它有象<code>int</code>, <code>double</code>这样的简单变量类型）。所以一定要有这个认识：<strong>Objective-C 中，类也是对象</strong>。</p> <p>在 Cocoa 中，所有类都继承自<code>NSObject</code>，参考<code>NSObject</code>在<code>&lt;objc/NSObject.h&gt;</code>中的定义如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> NSObject <span class="token operator">&lt;</span>NSObject<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Class isa  OBJC_ISA_AVAILABILITY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>objc_class</code>的定义如下：</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">objc_class</span> <span class="token punctuation">{</span>
    Class isa  OBJC_ISA_AVAILABILITY<span class="token punctuation">;</span>
    
<span class="token macro property">#<span class="token directive keyword">if</span> !__OBJC2__</span>
    Class super_class                                        OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name                                         OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
    <span class="token keyword">long</span> version                                             OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
    <span class="token keyword">long</span> info                                                OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
    <span class="token keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">objc_ivar_list</span> <span class="token operator">*</span>ivars                             OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">objc_method_list</span> <span class="token operator">*</span><span class="token operator">*</span>methodLists                    OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">objc_cache</span> <span class="token operator">*</span>cache                                 OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">objc_protocol_list</span> <span class="token operator">*</span>protocols                     OBJC2_UNAVAILABLE<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>可以知道在运行时，所有类对象都有一个名为<code>isa</code>的指针，这个指针指向一个<code>objc_class</code>结构体，<code>objc_class</code>结构体中包含一些与类相关的信息。问题是这个<code>isa</code>指向的<code>objc_class</code>结构体的信息所对应的是自己的信息还是对应的类的信息呢？当然是其所对应的类的信息，存储了变量列表、方法列表、遵守的协议列表等等。</p> <p>简单来说，<code>isa</code>指针被称为「is a」指针，顾名思义，它告诉了对象所属的类信息，描述「aX is a X」。</p> <p>某个对象的<code>isa</code>指针指向的<code>objc_class</code>结构体存放的是其所对应的类的元数据（metadata），通过它我们可以知道该对象：所对应类的名字（<code>name</code>）、可以做哪些事情（<code>objc_method_list</code>是个二维方法列表）、包括哪些成员变量（<code>objc_ivar_list</code>）、遵守哪些协议（<code>protocols</code>）。</p> <p>回到<code>objc_class</code>，可以看到<code>objc_class</code>结构体首变量也是一个<code>isa</code>指针，这也印证了「类也是对象」这个说法。对象的<code>isa</code>指针指向的是该对象的本类，而类的<code>isa</code>指针指向的另外一个类被称为<strong>元类</strong>（metaclass），用来表述类本身所表具备的元数据，类方法就定义于此；也正因为类本身也是一个对象，所以类本身可以接收消息。譬如：考虑到<code>NSObject</code>类本身也是一个对象（是 metaclass 的一个对象，常称之为<strong>类类型对象</strong>），所以<code>[NSObject alloc]</code>其实可以看成是对<code>NSObject</code>这个类类型对象发送一个消息（调用器<code>alloc</code>实例方法）。</p> <p>除了<code>isa</code>指针之外，<code>objc_class</code>结构体中还有一个变量<code>super_class</code>，它指向了是这个类的超类（super class），可以看到这个<code>super_class</code>不是一个一位数组，而是一个单独的指针，即一个类有且仅有一个 super class，即所谓的「单继承」。</p> <p>关于<code>isa</code>和<code>super_class</code>的更直观描述，还请看图：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/class-diagram.png" srcset="/image/class-diagram.png 2x" data-v-339c7bd5></div> <p>到了这里，Objective-C 的对象模型基本上解释清楚了；可能还有一个问题：最终的元类是啥？在 Cocoa 中，所有类都继承自<code>NSObject</code>，而<code>NSObject</code>的元类（不晓得叫什么名字，假设叫<code>NSObjectMetaClass</code>）（上图中右上角的方框）也继承自<code>NSObject</code>。有些绕，具体来说，<code>NSObject</code>和<code>NSObjectMetaClass</code>的<code>isa</code>指针和<code>super_class</code>指针指向情况是这样的：</p> <ul><li><code>NSObject</code>的<code>isa</code>指针<code>NSObjectMetaClass</code>（终极 meta class），<code>NSObjectMetaClass</code>指针指向自己；</li> <li><code>NSObject</code>的<code>super_class</code>指针指向<code>nil</code>，<code>NSObjectMetaClass</code>的<code>super_class</code>指向<code>NSObject</code>；</li></ul> <p>这样就完了？！No！Objective-C 的对象模型还有信息可挖，回过头来看<code>objc_class</code>的<code>ivars</code>变量和<code>methodLists</code>变量：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">objc_class</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">objc_ivar_list</span> <span class="token operator">*</span>ivars<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">objc_method_list</span> <span class="token operator">*</span><span class="token operator">*</span>methodLists<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在运行时，类（包括 class 和 metaclass）的<code>objc_class</code>结构体是固定的，不可能往这个结构体中添加数据，只能修改！譬如可以修改<code>isa</code>指针，让它指向一个中间类；在我的理解里，应该也可以修改<code>ivars</code>和<code>methodLists</code>，让它们指向一个新的区域；若可以这样，那么就可以在运行时随意添加/修改/删除成员变量和方法了。</p> <p>但是，貌似 Objective-C Runtime 没有提供修改<code>ivars</code>和<code>methodLists</code>指针值的接口。</p> <p>也因此，<code>ivars</code>在运行时指向的是一个固定区域，当然可以修改这个区域的值了，但这其实只是修改成员变量值而已；「在这个内存区域后面续上一段空余区域用于存放新的成员变量」？呵呵，想多了吧！因此，我们没办法在运行时为对象添加成员变量，这解释了为什么 category 中不能定义 property（dynamic property 不算）；</p> <p>P.S: 那为什么 protocol 中可以添加变量，在我的理解里，protocol 是在编译器处理的。所以<code>objc_class</code>中有一个变量叫<code>protocols</code>；</p> <p>和<code>ivars</code>不同，<code>methodLists</code>是一个二维数组。虽然我们没办法扩展<code>methodLists</code>指向的内存区域，但是我们可以改变这个内存区域（这个内存区域存储的都是指针）的值。因此，我们可以在运行时动态添加（以及做其他的处理，譬如交换等）方法！</p> <p>P.S: <code>objc_class</code>结构体中还有一个变量<code>cache</code>，顾名思义，它是用于缓存的，缓存啥呢？缓存方法，下一篇博客阐述「消息传递机制」时会谈到这个。</p> <p>到了这里，谁还敢说 Objective-C 不是动态语言？</p></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/97.da22d13e.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
