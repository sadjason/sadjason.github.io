(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{191:function(t,n,s){"use strict";s.r(n);var a=s(0),o=Object(a.a)({},(function(){var t=this,n=t.$createElement,s=t._self._c||n;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("常见问题：")]),t._v(" "),s("ul",[s("li",[t._v("NSTimer 使用起来有什么弊端？它只能工作于 Common Mode，默认情况下，只能工作于 DefaultMode。")]),t._v(" "),s("li",[t._v("RunLoop 的保活方案有哪些？添加 Source0 和 Source1。")])]),t._v(" "),s("p",[t._v("参考资料：")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://blog.ibireme.com/2015/05/18/runloop/",target:"_blank",rel:"noopener noreferrer"}},[t._v("深入理解 RunLoop"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://mrpeak.cn/blog/ios-runloop/",target:"_blank",rel:"noopener noreferrer"}},[t._v("解密 RunLoop"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://bestswifter.com/runloop-and-thread/",target:"_blank",rel:"noopener noreferrer"}},[t._v("深入研究 RunLoop 与保活"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://blog.csdn.net/u011619283/column/info/13762",target:"_blank",rel:"noopener noreferrer"}},[t._v("RunLoop CSDN 专题"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.cnblogs.com/kenshincui/p/6823841.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("iOS 刨根问底: 深入理解 RunLoop"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("有事做事，没事休息。有五种让它做事的方式：")]),t._v(" "),s("ul",[s("li",[t._v("DoTimers: 定时器相关")]),t._v(" "),s("li",[t._v("DoMainQueue: 类似于 dispatch_async_main")]),t._v(" "),s("li",[t._v("DoBlocks: 执行 block")]),t._v(" "),s("li",[t._v("DoSources0: 系统用 source0 任务来接收硬件事件。")]),t._v(" "),s("li",[t._v("DoSources1: 系统使用，没有对外开放")])]),t._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#如何唤醒-runloop"}},[t._v("如何唤醒 RunLoop")])]),s("li",[s("a",{attrs:{href:"#停止-runloop"}},[t._v("停止 RunLoop")])]),s("li",[s("a",{attrs:{href:"#source0-v-s-source1"}},[t._v("Source0 v.s Source1")]),s("ul",[s("li",[s("a",{attrs:{href:"#source0-custom-input-sources"}},[t._v("Source0 (Custom Input Sources)")])]),s("li",[s("a",{attrs:{href:"#source1-port-based-sources"}},[t._v("Source1 (Port-Based Sources)")])])])]),s("li",[s("a",{attrs:{href:"#理解-mode"}},[t._v("理解 mode")]),s("ul",[s("li",[s("a",{attrs:{href:"#common-mode"}},[t._v("Common Mode")])]),s("li",[s("a",{attrs:{href:"#mode-的意义"}},[t._v("Mode 的意义")])]),s("li",[s("a",{attrs:{href:"#切换-mode"}},[t._v("切换 mode")])])])]),s("li",[s("a",{attrs:{href:"#runloop-和线程的关系"}},[t._v("RunLoop 和线程的关系")])]),s("li",[s("a",{attrs:{href:"#cfrunloopgetmain-cfrunloopgetcurrent"}},[t._v("CFRunLoopGetMain & CFRunLoopGetCurrent")])]),s("li",[s("a",{attrs:{href:"#runloop-的基本操作"}},[t._v("RunLoop 的基本操作")]),s("ul",[s("li",[s("a",{attrs:{href:"#cfrunlooprun-cfrunloopruninmode-cfrunloopstop"}},[t._v("CFRunLoopRun & CFRunLoopRunInMode & CFRunLoopStop")])]),s("li",[s("a",{attrs:{href:"#runloop-的状态"}},[t._v("RunLoop 的状态")])]),s("li",[s("a",{attrs:{href:"#cfrunloopiswaiting-cfrunloopwakeup"}},[t._v("CFRunLoopIsWaiting & CFRunLoopWakeUp")])]),s("li",[s("a",{attrs:{href:"#mode-item"}},[t._v("Mode Item")])])])]),s("li",[s("a",{attrs:{href:"#runloop-observer"}},[t._v("RunLoop Observer")])]),s("li",[s("a",{attrs:{href:"#runloop-应用场景"}},[t._v("RunLoop 应用场景")])])])]),s("p"),t._v(" "),s("h1",{attrs:{id:"如何唤醒-runloop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何唤醒-runloop"}},[t._v("#")]),t._v(" 如何唤醒 RunLoop")]),t._v(" "),s("h1",{attrs:{id:"停止-runloop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#停止-runloop"}},[t._v("#")]),t._v(" 停止 RunLoop")]),t._v(" "),s("p",[t._v("可以通过"),s("code",[t._v("CFRunLoopStop()")]),t._v("停止 RunLoop，但是它并不总是有效的，详见"),s("a",{attrs:{href:"https://bestswifter.com/runloop-and-thread/",target:"_blank",rel:"noopener noreferrer"}},[t._v("深入研究 RunLoop 与保活"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h1",{attrs:{id:"source0-v-s-source1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#source0-v-s-source1"}},[t._v("#")]),t._v(" Source0 v.s Source1")]),t._v(" "),s("h2",{attrs:{id:"source0-custom-input-sources"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#source0-custom-input-sources"}},[t._v("#")]),t._v(" Source0 (Custom Input Sources)")]),t._v(" "),s("p",[t._v("Source0 只包含了一个回调（函数指针），它并不能主动触发事件。使用时，你需要先调用 CFRunLoopSourceSignal(source)，将这个 Source 标记为待处理，然后手动调用 CFRunLoopWakeUp(runloop) 来唤醒 RunLoop，让其处理这个事件。")]),t._v(" "),s("p",[t._v("负责 App 内部事件，由 App 负责管理触发（例如 UITouch 事件）和 Timer（又叫 Timer Source，基于时间的触发器，上层对应 NSTimer）。")]),t._v(" "),s("p",[t._v("Source0 有公开的 API 可供开发者调用，使用起来很简单，如下使用 Source0 进行保活：")]),t._v(" "),s("div",{staticClass:"language-objectivec extra-class"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("@")]),t._v("autoreleasepool "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    _runLoop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("NSRunLoop currentRunLoop"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatch_group_leave")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_waitGroup"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Add an empty run loop source to prevent runloop from spinning.")]),t._v("\n    CFRunLoopSourceContext sourceCtx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("version "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("retain "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("release "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("copyDescription "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("equal "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hash "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("schedule "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cancel "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("perform "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    CFRunLoopSourceRef source "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRunLoopSourceCreate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("sourceCtx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRunLoopAddSource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRunLoopGetCurrent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" source"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kCFRunLoopDefaultMode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRelease")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("source"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("_runLoop runMode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("NSDefaultRunLoopMode beforeDate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("NSDate distantFuture"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"source1-port-based-sources"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#source1-port-based-sources"}},[t._v("#")]),t._v(" Source1 (Port-Based Sources)")]),t._v(" "),s("p",[t._v("Source1 可以监听系统端口和其他线程相互发送消息，它能够主动唤醒 RunLoop （由操作系统内核进行管理，例如 CFMessagePort 消息）。")]),t._v(" "),s("p",[t._v("Source1 包含了一个 mach_port 和一个回调（函数指针），被用于通过内核和其他线程相互发送消息。这种 Source 能主动唤醒 RunLoop 的线程，其原理在下面会讲到。")]),t._v(" "),s("p",[t._v("Source1 主要为系统服务，并不对开发者开放，系统会使用它来执行一些内部任务，比如渲染 UI。")]),t._v(" "),s("p",[t._v("当然，也可以使用"),s("code",[t._v("NSRunLoop#addPort:forMode:")]),t._v("添加 Source1 进行保活。")]),t._v(" "),s("p",[t._v("AFN 3.0 将保活方案从 Source1 变为了 Source0，我想很有可能是因为前者有副作用 -- 唤醒 RunLoop -- 吧。")]),t._v(" "),s("h1",{attrs:{id:"理解-mode"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#理解-mode"}},[t._v("#")]),t._v(" 理解 mode")]),t._v(" "),s("p",[t._v("每次 loop 只会以一种 mode 运行，以该 mode 运行的时候，就只执行和该 mode 相关的任务，只通知该 mode 注册过的 observer。")]),t._v(" "),s("h2",{attrs:{id:"common-mode"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#common-mode"}},[t._v("#")]),t._v(" Common Mode")]),t._v(" "),s("p",[t._v("Mode 有两类：common mode 和 private mode。我们所熟知的 kCFRunLoopDefaultMode 和 UITrackingRunLoopMode 是属于 common mode。")]),t._v(" "),s("blockquote",[s("p",[t._v("它们的 mode 具有 common 标记。")])]),t._v(" "),s("p",[t._v("系统还定义了其他一些 private mode，比如 UIInitializationRunLoopMode 和 GSEventReceiveRunLoopMode。如果你在 app 启动的时候通过 CFRunLoopCopyAllModes 打印出所有的 runloop mode，就可以看到这两个 mode。")]),t._v(" "),s("p",[t._v("添加 source 的时候，如果 modeName 传入 kCFRunLoopCommonModes 或者 NSRunLoopCommonModes，则该 source 会被保存到 RunLoop 的 _commonModeItems 中，而且，会被添加到 commonModes 中的所有mode中去。")]),t._v(" "),s("p",[t._v("用户可以通过"),s("code",[t._v("CFRunLoopAddCommonMode")]),t._v("自定义 mode，不过只能提供 mode name，mode 在内部创建。")]),t._v(" "),s("h2",{attrs:{id:"mode-的意义"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mode-的意义"}},[t._v("#")]),t._v(" Mode 的意义")]),t._v(" "),s("p",[t._v("对 source 进行隔离，避免低优先级的 source 在敏感期占据太多时间。")]),t._v(" "),s("h2",{attrs:{id:"切换-mode"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#切换-mode"}},[t._v("#")]),t._v(" 切换 mode")]),t._v(" "),s("p",[t._v("如何切换 mode，通常的说法是：切换 mode 只能退出 Loop，再重新指定一个 Mode 进入。")]),t._v(" "),s("p",[t._v("按照"),s("a",{attrs:{href:"http://mrpeak.cn/blog/ios-runloop/",target:"_blank",rel:"noopener noreferrer"}},[t._v("解密 RunLoop"),s("OutboundLink")],1),t._v("的说法：runloop 有两种切换 mode 的方式，一是在 loop 的中途切换，二是按顺序在当前 mode 结束之后切换。")]),t._v(" "),s("h1",{attrs:{id:"runloop-和线程的关系"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#runloop-和线程的关系"}},[t._v("#")]),t._v(" RunLoop 和线程的关系")]),t._v(" "),s("ul",[s("li",[t._v("RunLoop 实际上就是一个对象，这个对象管理了其需要处理的事件和消息，并提供了一个入口函数来执行上面 Event Loop 的逻辑。")]),t._v(" "),s("li",[t._v("NSRunLoop 是基于 CFRunLoopRef 的封装")]),t._v(" "),s("li",[t._v("CFRunLoop 和线程是一一对应关系，它们组成 key-Value 放在一个全局字典里")])]),t._v(" "),s("h1",{attrs:{id:"cfrunloopgetmain-cfrunloopgetcurrent"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cfrunloopgetmain-cfrunloopgetcurrent"}},[t._v("#")]),t._v(" CFRunLoopGetMain & CFRunLoopGetCurrent")]),t._v(" "),s("p",[t._v("线程的 RunLoop 是无需创建的，只能通过俩基本接口获取：")]),t._v(" "),s("div",{staticClass:"language-objectivec extra-class"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[t._v("CFRunLoopRef "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRunLoopGetMain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CHECK_FOR_FORK")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" CFRunLoopRef __main "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// no retain needed")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("__main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" __main "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_CFRunLoopGet0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_main_thread_np")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// no CAS needed")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" __main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nCFRunLoopRef "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRunLoopGetCurrent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CHECK_FOR_FORK")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    CFRunLoopRef rl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CFRunLoopRef"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_CFGetTSD")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__CFTSDKeyRunLoop"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" rl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_CFRunLoopGet0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_self")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("ul",[s("li",[t._v("线程刚创建时并没有 RunLoop，如果你不主动获取，那它一直都不会有")]),t._v(" "),s("li",[t._v("主线程之外的线程，只能在内部通过"),s("code",[t._v("CFRunLoopGetCurrent")]),t._v("获取其 RunLoop")]),t._v(" "),s("li",[t._v("其他线程可以通过 CFRunLoopGetMain 获取主线程的 runloop")])]),t._v(" "),s("h1",{attrs:{id:"runloop-的基本操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#runloop-的基本操作"}},[t._v("#")]),t._v(" RunLoop 的基本操作")]),t._v(" "),s("h2",{attrs:{id:"cfrunlooprun-cfrunloopruninmode-cfrunloopstop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cfrunlooprun-cfrunloopruninmode-cfrunloopstop"}},[t._v("#")]),t._v(" CFRunLoopRun & CFRunLoopRunInMode & CFRunLoopStop")]),t._v(" "),s("p",[t._v("获取到 runloop 后可以干什么？可以让它 run 起来；让 runloop 显式 run 起来有俩接口：")]),t._v(" "),s("div",{staticClass:"language-objectivec extra-class"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRunLoopRun")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nSInt32 "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRunLoopRunInMode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CFStringRef modeName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CFTimeInterval seconds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Boolean returnAfterSourceHandled"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("前者写死了 mode（"),s("code",[t._v("kCFRunLoopDefaultMode")]),t._v("），后者可以指定 mode。")]),t._v(" "),s("h2",{attrs:{id:"runloop-的状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#runloop-的状态"}},[t._v("#")]),t._v(" RunLoop 的状态")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CF_OPTIONS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CFOptionFlags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CFRunLoopActivity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  kCFRunLoopEntry         "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1UL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 即将进入Loop")]),t._v("\n  kCFRunLoopBeforeTimers  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1UL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 即将处理 Timer")]),t._v("\n  kCFRunLoopBeforeSources "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1UL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 即将处理 Source")]),t._v("\n  kCFRunLoopBeforeWaiting "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1UL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 即将进入休眠")]),t._v("\n  kCFRunLoopAfterWaiting  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1UL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 刚从休眠中唤醒")]),t._v("\n  kCFRunLoopExit          "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1UL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 即将退出Loop")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("e-img",{attrs:{src:"/image/draft/ibireme-runloop.png"}}),t._v(" "),s("h2",{attrs:{id:"cfrunloopiswaiting-cfrunloopwakeup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cfrunloopiswaiting-cfrunloopwakeup"}},[t._v("#")]),t._v(" CFRunLoopIsWaiting & CFRunLoopWakeUp")]),t._v(" "),s("p",[t._v("可以使用"),s("code",[t._v("CFRunLoopIsWaiting")]),t._v("判断 RunLoop 是否处于休眠状态。")]),t._v(" "),s("p",[t._v("可以使用"),s("code",[t._v("CFRunLoopWakeUp")]),t._v("唤醒正在休眠的 RunLoop。")]),t._v(" "),s("h2",{attrs:{id:"mode-item"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mode-item"}},[t._v("#")]),t._v(" Mode Item")]),t._v(" "),s("p",[t._v("如果一个 mode 中一个 item 都没有，则 RunLoop 会直接退出，不进入循环。")]),t._v(" "),s("h1",{attrs:{id:"runloop-observer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#runloop-observer"}},[t._v("#")]),t._v(" RunLoop Observer")]),t._v(" "),s("p",[t._v("Q: 添加 Observer 能够让 RunLoop 保活吗？")]),t._v(" "),s("p",[t._v("A: 不能。")]),t._v(" "),s("h1",{attrs:{id:"runloop-应用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#runloop-应用场景"}},[t._v("#")]),t._v(" RunLoop 应用场景")]),t._v(" "),s("ul",[s("li",[t._v("线程保活")]),t._v(" "),s("li",[t._v("NSTimer 在视图滑动时，依然能正常运转")]),t._v(" "),s("li",[t._v("监控主线程卡顿\n"),s("ul",[s("li",[t._v("使用 perfromSelector 在默认模式下设置图片，防止 UITableView 滚动卡顿")])])]),t._v(" "),s("li",[t._v("UITableView 滑动优化\n"),s("ul",[s("li",[t._v("利用 Observer 在界面空闲状态下计算出 UITableViewCell 的高度并进行缓存")])])]),t._v(" "),s("li",[t._v("主线程卡顿监控/监测\n"),s("ul",[s("li",[s("a",{attrs:{href:"http://www.tanhao.me/code/151113.html/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://www.tanhao.me/code/151113.html/"),s("OutboundLink")],1)])])]),t._v(" "),s("li",[t._v("让应用起死回生")])]),t._v(" "),s("p",[t._v("imeituan 内部已有引用：")]),t._v(" "),s("ul",[s("li",[t._v("SMModuleDistributer")]),t._v(" "),s("li",[t._v("WMSearchRunloopDistributer")]),t._v(" "),s("li",[t._v("计算 FPS")])])],1)}),[],!1,null,null,null);n.default=o.exports}}]);