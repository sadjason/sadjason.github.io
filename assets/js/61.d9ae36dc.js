(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{137:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("之前的博文"),s("router-link",{attrs:{to:"/post/macho-dynamic-link.html"}},[t._v("Mach-O 与动态链接")]),t._v("基于 Mach-O 文件结构，分析了 Mach-O 的动态链接逻辑。当一个可执行 Mach-O 文件被执行时，内核在完成进程创建等一系列初始化后，会把后续的链接以及镜像加载工作交给 dyld 来完成。")],1),t._v(" "),s("p",[t._v("本文对 dyld 的启动过程稍作分析，在分析的过程中会回答如下两个问题：")]),t._v(" "),s("ul",[s("li",[t._v("程序是如何加载的，或者说，程序的入口代码（譬如"),s("code",[t._v("main")]),t._v("函数）是如何被调用的？")]),t._v(" "),s("li",[t._v("dyld 逻辑的启动过程是怎样的？")])]),t._v(" "),s("p",[t._v("本文所分析对象包括：")]),t._v(" "),s("ul",[s("li",[t._v("dyld Mach-O 文件（在"),s("code",[t._v("/usr/lib/dyld")]),t._v("中，本文所分析的版本是 640.2，对应源码还没来得及开源）")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://opensource.apple.com/source/dyld/dyld-635.2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("dyld-635.2 源码"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://opensource.apple.com/source/xnu/xnu-4903.221.2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("xnu-4903.221.2 源码"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("dyld 本身也是一个 dylib，但它有一些特殊性。对于普通 dylib 来说，它的重定位工作由 dyld 来完成；它也可以依赖与其他 dylib，其中被依赖的 dylib 由 dyld 负责链接和装载。对于 dyld 来说，它是如何被加载的呢？它是否可以依赖于其他的 dylib？")]),t._v(" "),s("p",[t._v("首先，dyld 本身不可以依赖于其他任何 dylib，使用"),s("code",[t._v("xcrun dyldinfo -dylibs")]),t._v("查看可以证实这一点：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("$ xcrun dyldinfo -dylibs dyld\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" arch x86_64:\nattributes     dependent dylibs\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" arch i386:\nattributes     dependent dylibs\n")])])]),s("p",[t._v("如上结果（也可以使用 MachOView 工具查看）显示，dyld 没有依赖任何其他 dylib；不过这一点显然是可以人为控制的，在编写动态链接器时保证不使用任何其他库资源（包括系统库）就可以了。")]),t._v(" "),s("p",[t._v("那么对于另一个问题：dyld 是如何被加载的呢？或者说，它的代码是如何被执行的呢？")]),t._v(" "),s("p",[t._v("dyld 的代码逻辑开始于"),s("a",{attrs:{href:"https://opensource.apple.com/source/dyld/dyld-635.2/src/dyldStartup.s.auto.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("dyldStartup.s"),s("OutboundLink")],1),t._v("，它用汇编实现了名为"),s("code",[t._v("__dyld_start")]),t._v("的函数，主要做两件事情：")]),t._v(" "),s("ul",[s("li",[t._v("调用"),s("code",[t._v("dyldbootstrap::start")]),t._v("方法，后者返回可执行文件的入口，暂称为"),s("code",[t._v("_main")])]),t._v(" "),s("li",[t._v("填入参数，调用"),s("code",[t._v("_main")])])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("dyldbootstrap::start")]),t._v("也定义于 dyld 中，该函数对应的符号是"),s("code",[t._v("__ZN13dyldbootstrap5startEPK12macho_headeriPPKclS2_Pm")]),t._v("，定义于"),s("a",{attrs:{href:"https://opensource.apple.com/source/dyld/dyld-635.2/src/dyld.order.auto.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("dyld.order"),s("OutboundLink")],1),t._v("。")])]),t._v(" "),s("p",[t._v("所以说，可执行文件的入口，是由 dyld 负责找到并调用的，如何找到？这个问题比较简单，对于依赖于 dyld 的可执行文件，其逻辑代码的起点（entry point）可以从"),s("code",[t._v("LC_MAIN")]),t._v("这个 load command 里解析得到，该指令的参数记录了程序入口指令相对于镜像文件的 file offset；dyld 完成 rebase、binding 等工作后，会去调用该地址的函数。")]),t._v(" "),s("blockquote",[s("p",[t._v("貌似从 10.7 开始，Mac OS X (ma\b\bcOS) 里的可执行文件都得依赖于 dyld。")])]),t._v(" "),s("p",[t._v("另一个关键问题是：内核是如何找到"),s("code",[t._v("__dyld_start")]),t._v("函数的呢？")]),t._v(" "),s("p",[t._v("关于这个问题，参考"),s("a",{attrs:{href:"https://stackoverflow.com/questions/39863112/what-is-required-for-a-mach-o-executable-to-load",target:"_blank",rel:"noopener noreferrer"}},[t._v("StackOverflow: What is required for a Mach-O executable to load?"),s("OutboundLink")],1),t._v("，尝试从"),s("code",[t._v("LC_UNIXTHREAD")]),t._v("这个 load command 里挖掘答案。")]),t._v(" "),s("p",[t._v("dyld 本身逻辑的加载，依赖于内核调用，内核在对 dyld 镜像进行解析时，从"),s("code",[t._v("LC_UNIXTHREAD")]),t._v("这个 load command 中提取 dyld 的 entry point。")]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("otool -l")]),t._v("查看"),s("code",[t._v("LC_UNIXTHREAD")]),t._v("的结构：")]),t._v(" "),s("div",{staticClass:"language-raw extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Load command 9\n        cmd LC_UNIXTHREAD\n    cmdsize 184\n     flavor x86_THREAD_STATE64\n      count x86_THREAD_STATE64_COUNT\n   rax    0x0000000000000000 rbx    0x0000000000000000 rcx    0x0000000000000000\n   rdx    0x0000000000000000 rdi    0x0000000000000000 rsi    0x0000000000000000\n   rbp    0x0000000000000000 rsp    0x0000000000000000 r8     0x0000000000000000\n    r9    0x0000000000000000 r10    0x0000000000000000 r11    0x0000000000000000\n   r12    0x0000000000000000 r13    0x0000000000000000 r14    0x0000000000000000\n   r15    0x0000000000000000 rip    0x0000000000001000 rflags 0x0000000000000000\n   cs     0x0000000000000000 fs     0x0000000000000000 gs     0x0000000000000000\n")])])]),s("p",[t._v("它包含了三个有效信息：flavor、count、thread_state。flavor 描述的是进程类型（x86_64 架构对应的是"),s("code",[t._v("x86_THREAD_STAT64")]),t._v("，i386 架构对应的是"),s("code",[t._v("x86_THREAD_STAT32")]),t._v("）；count 描述 thread_state 的长度；至于"),s("code",[t._v("thread_state")]),t._v("，描述的是进程状态，「进程」这个概念的完成需要硬件和软件通力协作，不同不同架构的"),s("code",[t._v("thread_state")]),t._v("不同，对于"),s("code",[t._v("x86_THREAD_STAT64")]),t._v("，"),s("code",[t._v("thread_state")]),t._v("结构定义于"),s("a",{attrs:{href:"https://opensource.apple.com/source/xnu/xnu-4903.221.2/osfmk/mach/i386/_structs.h.auto.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("/osfmk/mach/i386/_structs.h"),s("OutboundLink")],1),t._v("，如下：：")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" _STRUCT_X86_THREAD_STATE64 struct x86_thread_state64")]),t._v("\n_STRUCT_X86_THREAD_STATE64\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  __uint64_t  rax"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rbx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rcx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rdx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rdi"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rsi"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rbp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rsp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  r8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  r9"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  r10"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  r11"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  r12"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  r13"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  r14"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  r15"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rip"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  rflags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t cs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __uint64_t  gs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("对于"),s("code",[t._v("x86_THREAD_STAT64")]),t._v("类型的 thread_state，rip 存储了进程的 entry point（相对于镜像的 file offset）；接下来的 xnu 源码分析是为了证实这一点。")]),t._v(" "),s("p",[t._v("从"),s("a",{attrs:{href:"https://opensource.apple.com/source/xnu/xnu-4903.221.2/bsd/kern/mach_loader.c.auto.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("/bsd/kern/mach_loader.c"),s("OutboundLink")],1),t._v("里的"),s("code",[t._v("parse_machfile")]),t._v("函数开始看，顾名思义，"),s("code",[t._v("parse_machfile")]),t._v("用于解析 Mach-O 文件，摘录其解析 load commands 的"),s("code",[t._v("LC_UNIXTHREAD")]),t._v("分支：")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" load_return_t "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse_machfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vnode")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("vp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("       \n  vm_map_t            map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  thread_t            thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("mach_header")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("header"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  off_t               file_offset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  off_t               macho_size"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v("                 depth"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  int64_t             aslr_offset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  int64_t             dyld_aslr_offset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  load_result_t       "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  load_result_t       "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("binresult"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("image_params")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("imgp\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" LC_UNIXTHREAD"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pass "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ret "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("load_unixthread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("thread_command")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" lcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        slide"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("跟着"),s("code",[t._v("load_unixthread")]),t._v("往下看，关键代码如下：")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" load_return_t "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("load_unixthread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("thread_command")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  thread_t              thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  int64_t               slide"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  load_result_t         "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("result\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  ret "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("load_threadentry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uint32_t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm_offset_t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("tcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("thread_command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        tcp"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("cmdsize "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("thread_command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("addr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ret "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" LOAD_SUCCESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ret"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("using_lcmain "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" result"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("entry_point "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" MACH_VM_MIN_ADDRESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Already processed LC_MAIN or LC_UNIXTHREAD */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LOAD_FAILURE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  result"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("entry_point "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" addr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  result"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("entry_point "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" slide"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("提取 entry point 的重任被辗转到"),s("code",[t._v("load_threadentry")]),t._v("，后者逻辑也挺简单，所做的事情不过是把锅甩到"),s("code",[t._v("thread_entrypoint")]),t._v("，不同平台的"),s("code",[t._v("thread_entrypoint")]),t._v("定义不同，对于 x86 架构，该函数定义于"),s("a",{attrs:{href:"https://opensource.apple.com/source/xnu/xnu-4903.221.2/osfmk/i386/bsd_i386.c.auto.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("xnu/osfmk/i386/bsd_i386.c"),s("OutboundLink")],1),t._v("，它的逻辑蛮简单：")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[t._v("kern_return_t "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("thread_entrypoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    __unused thread_t       thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v("                     flavor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    thread_state_t          tstate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    __unused "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v("   count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    mach_vm_offset_t        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("entry_point\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("entry_point "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("entry_point "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" VM_MIN_ADDRESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flavor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" x86_THREAD_STATE32"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      x86_thread_state32_t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("state25"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      state25 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i386_thread_state_t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" tstate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("entry_point "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" state25"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("eip "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" state25"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("eip"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VM_MIN_ADDRESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" x86_THREAD_STATE64"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      x86_thread_state64_t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("state25"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      state25 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x86_thread_state64_t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" tstate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("entry_point "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" state25"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("rip "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" state25"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("rip"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VM_MIN_ADDRESS64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("KERN_SUCCESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("分析到这里基本实锤了，对于 x86_64 架构，"),s("code",[t._v("LC_UNIXTHREAD")]),t._v(" 命令里的"),s("code",[t._v("thread_state->rip")]),t._v("指定了 dyld 的 entry point。")]),t._v(" "),s("p",[t._v("OK，是时候对 dyld 以及程序的启动做个总结了（针对 x86_64 架构的 Mach-O 可执行文件）：")]),t._v(" "),s("ul",[s("li",[t._v("对于依赖于 dyld 的可执行文件，进程的 entry point 是 dyld 的"),s("code",[t._v("__dyld_start")]),t._v("函数")]),t._v(" "),s("li",[t._v("内核通过解析"),s("code",[t._v("LC_UNIXTHREAD")]),t._v("，从"),s("code",[t._v("thread_state->rip")]),t._v("里获得 dyld 的入口（即"),s("code",[t._v("__dyld_start")]),t._v("）")]),t._v(" "),s("li",[t._v("镜像的入口由"),s("code",[t._v("dyldbootstrap::start")]),t._v("函数发现，返回到"),s("code",[t._v("__dyld_start")]),t._v("，被后者调用")]),t._v(" "),s("li",[t._v("镜像的入口可通过解析"),s("code",[t._v("LC_MAIN")]),t._v("得到")])]),t._v(" "),s("h1",{attrs:{id:"写在后面"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#写在后面"}},[t._v("#")]),t._v(" 写在后面")]),t._v(" "),s("p",[t._v("本文对 xnu 和 dyld 源码的分析完全属于盲人摸象，分析思路是先提出问题，然后分析源码，尝试给出自己的回答。除了理解上可能存在偏差外，还有如下问题没有搞清楚：")]),t._v(" "),s("ul",[s("li",[t._v("个人感觉，"),s("code",[t._v("LC_UNIXTHREAD")]),t._v("是 dyld 的专有命令，但没有找到权威的说明")]),t._v(" "),s("li",[t._v("现在还能折腾出不依赖 dyld 的程序可执行文件吗？尝试弄了一把，但没有成功，貌似依赖 dyld 是 macOS 对应用程序的强制行为")])]),t._v(" "),s("p",[t._v("更多阅读：")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://stackoverflow.com/questions/39863112/what-is-required-for-a-mach-o-executable-to-load",target:"_blank",rel:"noopener noreferrer"}},[t._v("StackOverflow: What is required for a Mach-O executable to load?"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://blog.sunnyxx.com/2014/08/30/objc-pre-main/",target:"_blank",rel:"noopener noreferrer"}},[t._v("iOS 程序 main 函数之前发生了什么"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.mikeash.com/pyblog/friday-qa-2012-11-09-dyld-dynamic-linking-on-os-x.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("dyld: Dynamic Linking On OS X"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://blog.cnbluebox.com/blog/2017/06/30/dyld2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Dyld系列之一：_dyld_start之前"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);