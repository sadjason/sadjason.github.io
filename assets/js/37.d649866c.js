(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{202:function(v,_,e){"use strict";e.r(_);var r=e(0),a=Object(r.a)({},(function(){var v=this,_=v.$createElement,e=v._self._c||_;return e("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[e("p",[v._v("相关问题：")]),v._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://leetcode-cn.com/problems/kth-largest-element-in-an-array/",target:"_blank",rel:"noopener noreferrer"}},[v._v("数组中的第 K 个最大元素"),e("OutboundLink")],1)]),v._v(" "),e("li",[v._v("事件链条")]),v._v(" "),e("li",[v._v("OCLint 的工作原理是啥？\n"),e("ul",[e("li",[v._v("关键词：XcodeBuild，编译参数")])])]),v._v(" "),e("li",[v._v("你写过哪些 rule?")])]),v._v(" "),e("p",[v._v("对于监控来说，常常讲究个闭环。")]),v._v(" "),e("h1",{attrs:{id:"美食监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#美食监控"}},[v._v("#")]),v._v(" 美食监控")]),v._v(" "),e("p",[v._v("美食频道重视监控是从去年下半年就开始的，主要是我和组内一个同学在做：监控包括很多。如下是我认为的分类：")]),v._v(" "),e("ul",[e("li",[v._v("质量监控\n"),e("ul",[e("li",[v._v("测速")]),v._v(" "),e("li",[v._v("端到端")]),v._v(" "),e("li",[v._v("FPS")]),v._v(" "),e("li",[v._v("卡顿")]),v._v(" "),e("li",[v._v("Crash")]),v._v(" "),e("li",[v._v("断言")]),v._v(" "),e("li",[v._v("其他：CPU、内存")])])]),v._v(" "),e("li",[v._v("业务监控\n"),e("ul",[e("li",[v._v("订单详情空码率")]),v._v(" "),e("li",[v._v("券码详情空券率")]),v._v(" "),e("li",[v._v("团单提单成功率")]),v._v(" "),e("li",[v._v("支付结果成功率")])])])]),v._v(" "),e("p",[v._v("以前客户端比较重视的主要是 Crash 监控（但没有做得特别好，触发了阈值我们才关注）。端到端监控是 Server 同学做的，但是它们是站在 server 的角度。")]),v._v(" "),e("p",[v._v("这些监控，我和另外一个同学有所分工，它负责页面加载速度相关的监控，包括端到端、测试等等。而我负责的是一些其他监控，Crash、断言、业务监控等等。")]),v._v(" "),e("p",[v._v("这些东西都有现成的平台资源在支持，其实没啥技术含量。我在做这些事情，考虑的重点是如何让它们形成一个闭环，并且发挥作用。")]),v._v(" "),e("h1",{attrs:{id:"crash-监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#crash-监控"}},[v._v("#")]),v._v(" Crash 监控")]),v._v(" "),e("p",[v._v("Crash 监控没太多好讲，因为我们这一块儿一直做得比较好。有了 Crash 基本上就算一次事故，是要写 CaseStudy 的。")]),v._v(" "),e("p",[v._v("包括三方面：")]),v._v(" "),e("ul",[e("li",[v._v("优化 Crash 报警\n"),e("ul",[e("li",[v._v("以前也是有 Crash 报警的（康哥做的）：轮询抓取、公众号发送")]),v._v(" "),e("li",[v._v("以前的缺点：无法直接跳转到相应崩溃数据")]),v._v(" "),e("li",[v._v("所做的优化：可以直接跳转到相关页面")])])]),v._v(" "),e("li",[v._v("自动采集开发阶段的 Crash\n"),e("ul",[e("li",[v._v("通过爬 API 数据（公开的）")]),v._v(" "),e("li",[v._v("落到我们频道的")])])]),v._v(" "),e("li",[v._v("自动采集开发阶段的 Assert")])]),v._v(" "),e("h1",{attrs:{id:"assert-收集"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#assert-收集"}},[v._v("#")]),v._v(" Assert 收集")]),v._v(" "),e("p",[v._v("为什么要收集断言？我们代码中有很多断言，它经常用来标记不太合理的逻辑的产生，但是断言仅能在 debug 环境下起作用。")]),v._v(" "),e("p",[v._v("断言有两种：关键断言，原生断言。")]),v._v(" "),e("p",[v._v("所做的事情是在 TEST 环境下，将关键断言和原生断言都上报到 server，生成 HTML 报告，然后同步到大象群。")]),v._v(" "),e("p",[v._v("实现原理：hook NSAssertionHandler 的方法"),e("code",[v._v("handleFailureInMethod:object:file:lineNumber:description:")])]),v._v(" "),e("e-img",{attrs:{src:"/image/draft/assert-upload.png"}}),v._v(" "),e("p",[e("a",{attrs:{href:"https://km.sankuai.com/page/94080615",target:"_blank",rel:"noopener noreferrer"}},[v._v("Crash 报警"),e("OutboundLink")],1),v._v(" "),e("a",{attrs:{href:"https://km.sankuai.com/page/46097429",target:"_blank",rel:"noopener noreferrer"}},[v._v("自动采集崩溃"),e("OutboundLink")],1),v._v(" "),e("a",{attrs:{href:"https://km.sankuai.com/page/46086084",target:"_blank",rel:"noopener noreferrer"}},[v._v("自动采集断言"),e("OutboundLink")],1)]),v._v(" "),e("h1",{attrs:{id:"业务监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#业务监控"}},[v._v("#")]),v._v(" 业务监控")]),v._v(" "),e("p",[v._v("先说背景: "),e("a",{attrs:{href:"https://km.sankuai.com/page/138416984",target:"_blank",rel:"noopener noreferrer"}},[v._v("业务监控方案调研"),e("OutboundLink")],1),v._v("。")]),v._v(" "),e("p",[v._v("针对用户实际体验的监控比较匮乏，各种影响用户关键体验的反馈基本都是通过客诉、或其他人为渠道，比如提单是否能正常跳转收银台、支付是否成功、券码是否返回显示等等，对这些业务的监控才是对用户实际体验的最终级反馈。")]),v._v(" "),e("p",[v._v("如何实现？基于 CAT 实现的。")]),v._v(" "),e("p",[v._v("成果：解决已核销的券，仍然能从订单中心查看的问题。")]),v._v(" "),e("h1",{attrs:{id:"图片资源监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#图片资源监控"}},[v._v("#")]),v._v(" 图片资源监控")]),v._v(" "),e("p",[v._v("所谓图片监控，其实针对大图和404。")]),v._v(" "),e("p",[v._v("先说背景。这是我比较早期做的事情。在负责购前业务 - 主要是商家页 - 的时候，经常遇到商家反馈：门店的图片怎么半天才显示出来？")]),v._v(" "),e("p",[v._v("原因很简单：下载图片的时候没有在 path 中携带 size 参数。Server 会根据 size 参数对图片进行切图，如果没有携带，就会返回原图。")]),v._v(" "),e("p",[v._v("最开始 size 参数是由客户端拼上去的，这样比较灵活（可以适应不同客户端）。在比较早期的时候，这个是没啥问题的，因为美团的图片服务就那么几个，都支持这种拼参数的姿势。后来随着图片服务的增多，特别是引入了点评的资源后，就产生了一些问题，因为新增的服务不支持拼参数，这就导致了 404 图片问题的产生；或者需要以别的方式拼参数，这就导致了大图的产生。")]),v._v(" "),e("p",[v._v("所以就开始治理，能想到的办法当然是新增的服务类型进行特别处理。但很快发现这个其实是一个比较糟糕的办法，放在服务端，可靠性太差了。所以就找 Server 同学反馈，想把拼参数的事情放在 Server 端解决。")]),v._v(" "),e("p",[v._v("Server 同学就不乐意，这个时候就向上反馈，由我的 Leader 和 Server 的 Leader 敲定这个事情并产生文档，相当于达成了一个协议。")]),v._v(" "),e("p",[v._v("有了协议之后，还得实施。实施起来有几个困难：")]),v._v(" "),e("ul",[e("li",[v._v("并不是每个 Server 都知道这个这个约束，特别是随着人员更替，这个事情就更难保证")]),v._v(" "),e("li",[v._v("并不是每个客户端同学都知道这个约束")])]),v._v(" "),e("p",[v._v("所以我们就在客户端层做了一个约束：统一了生成图片 URL 的途径，在这个途径里面对 Server 端的图片进行监控，上报关键断言之类的。")]),v._v(" "),e("p",[v._v("对于客户端同学来说，如何让他们写图片逻辑时都是用这个接口呢？通过 OCLint 来解决。")]),v._v(" "),e("h1",{attrs:{id:"oclint"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#oclint"}},[v._v("#")]),v._v(" OCLint")]),v._v(" "),e("p",[v._v("OCLint 工作的原理：")]),v._v(" "),e("ol",[e("li",[v._v("使用 XcodeBuild 对目标工程的源码文件生成 compile flag 信息，对应 JSON 文件")]),v._v(" "),e("li",[v._v("基于这些 compile flag，使用 clang 编译目标源码文件生成 AST")]),v._v(" "),e("li",[v._v("对 AST 进行分析，我们程序里面的方法调用、赋值等操作在抽象语法树里都能找到相应的节点")]),v._v(" "),e("li",[v._v("OCLint 对这些节点进行遍历分析的时候会回调各种各样的方法，我们所要做的事情就是在回调了进行相关的逻辑处理\n"),e("ul",[e("li",[v._v("打个比方，当分析到方法调用相关节点时，会回调 VisitObjCMessage 方法，我之前写的一个 rule 就是检查 imageNamed: 参数，当它是一个字面量并且含有我们频道的前缀（"),e("code",[v._v("def_")]),v._v("）的时候，就报告一个错误")])])])]),v._v(" "),e("ul",[e("li",[v._v("最终分析的对象是一棵抽象语法树\n"),e("ul",[e("li",[v._v("抽象语法树里面包括啥信息\n"),e("ul",[e("li",[e("a",{attrs:{href:"http://huang-jerryc.com/2016/03/15/%E4%BD%95%E4%B8%BA%E8%AF%AD%E6%B3%95%E6%A0%91/",target:"_blank",rel:"noopener noreferrer"}},[v._v("何为语法树"),e("OutboundLink")],1)])])])])]),v._v(" "),e("li",[v._v("为啥不使用 clang\n"),e("ul",[e("li",[v._v("维护成本太高")]),v._v(" "),e("li",[v._v("容易忘记（OCLint 也有这个特点）")])])]),v._v(" "),e("li",[v._v("OCLint 和 clang 是啥关系\n"),e("ul",[e("li",[v._v("OCLint 其实是对 clang 静态分析器（clang static analyzer）的一种封装")])])]),v._v(" "),e("li",[v._v("OCLint 每次都对所有源码进行分析吗？\n"),e("ul",[e("li",[v._v("有两种工作方式：全局分析、增量分析")])])]),v._v(" "),e("li",[v._v("写过哪些 rule\n"),e("ul",[e("li",[v._v("updateConstraints\n"),e("ul",[e("li",[v._v("确保在末尾调用了 super")]),v._v(" "),e("li",[v._v("确保没有"),e("code",[v._v("mas_makeConstraints:")]),v._v("的调用")])])]),v._v(" "),e("li",[v._v("图片字面量引用检查")]),v._v(" "),e("li",[v._v("声明 NSArray、NSDictionary 等属性的时候，要使用"),e("code",[v._v("copy")]),v._v("修饰符修饰")])])])]),v._v(" "),e("p",[v._v("OCLint 有啥问题吗？工程化上的问题蛮严重：")]),v._v(" "),e("ul",[e("li",[v._v("封装程度太低，写 rule 成本仍然非常高（虽然比 clang 要好得多）")]),v._v(" "),e("li",[v._v("调试能力太差")])])],1)}),[],!1,null,null,null);_.default=a.exports}}]);