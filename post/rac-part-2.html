<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>当 ReactiveCocoa 遇上多线程 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/95.fa3326f7.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">当 ReactiveCocoa 遇上多线程</div> <div class="post-info">2016-08-06 • iOS</div></div> <div class="content content__default"><p>在使用 RAC 过程中，无法避免和各种 block 打交道，譬如<code>RACDynamicSignal</code>被订阅时触发的 block（didSubscribe block），处理 signal 值事件的 next block 等等。初学者常会纠结这些 block 的执行时机，本文是我学习过程中对 RAC 线程问题的梳理。</p> <h2 id="重温-signal-的订阅顺序"><a href="#重温-signal-的订阅顺序" class="header-anchor">#</a> 重温 signal 的订阅顺序</h2> <p>来看段代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;create a signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;didSubscribe block invoked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// mark 1</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;value&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// mark 2</span>
    <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
     
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// mark 3</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;capture next event: %@&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// mark 4</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;subscribe finished&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这段代码的执行环境是 main thread，执行结果是：</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase">create a signal
didSubscribe block invoked
capture next event: value
subscribe finished
</span></code></pre></div><p>可以看出：</p> <ol><li>Signal 一旦被订阅（如上<code>mark 3</code>），didSubscribe block（如上<code>mark 1</code>）就立马被调用</li> <li>Signal 一旦产生 event（如上<code>mark 2</code>），相关的 subscription block（如上<code>mark 4</code>）就立马被调用</li></ol> <p>P.S: 这两句话是下文分析<strong>异步订阅</strong>和<strong>异步发送</strong>的关键。</p> <h2 id="异步订阅"><a href="#异步订阅" class="header-anchor">#</a> 异步订阅</h2> <p>何为异步订阅？指的是：signal 的订阅逻辑相对于定义 signal 的上下文而言，不是同步的。</p> <p>譬如，如下代码在主线程环境下执行：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// mark 1</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token comment">// mark 2</span>
    <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler scheduler<span class="token punctuation">]</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>  <span class="token comment">// mark 3</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// mark 4</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>mark 3</code>异步（子线程）执行了一个订阅事件，需要关心的是：<code>mark 2</code>和<code>mark 4</code>分别在哪个线程执行，主线程还是子线程？</p> <p>答案是：<code>mark 2</code>和<code>mark 4</code>的调用都在同一个子线程中完成。如下图：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/asnyc-subscribe@2x.png" srcset="/image/asnyc-subscribe@2x.png 2x" data-v-339c7bd5></div> <p>如何解释这一结果呢？先抛结论：signal（<code>RACDynamicSignal</code>实例）一旦被订阅，其 didSubscribe block 就立马被同步调用。</p> <p>如下是代码分析：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token comment">// signal是RACDynamicSignal类型</span>
<span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span>  <span class="token comment">// step 1</span>
 
<span class="token operator">-&gt;</span>
 
<span class="token comment">// RACDynamicSignal#subscribe:</span>
<span class="token comment">// RACDynamicSignal.m</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>didSubscribe <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>RACScheduler<span class="token punctuation">.</span>subscriptionScheduler schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>  <span class="token comment">// step 2</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">didSubscribe</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token operator">-&gt;</span>
 
<span class="token comment">// RACScheduler.subscriptionScheduler, schedule `didSubscribe` block</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>instancetype<span class="token punctuation">)</span>subscriptionScheduler <span class="token punctuation">{</span>
    <span class="token keyword">static</span> dispatch_once_t onceToken<span class="token punctuation">;</span>
    <span class="token keyword">static</span> RACScheduler <span class="token operator">*</span>subscriptionScheduler<span class="token punctuation">;</span>
    <span class="token function">dispatch_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>onceToken<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        subscriptionScheduler <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>RACSubscriptionScheduler alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> subscriptionScheduler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
<span class="token operator">-&gt;</span>
  
<span class="token comment">// RACSubscriptionScheduler#schedule:</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">)</span>schedule<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>block <span class="token punctuation">{</span>  <span class="token comment">// step 3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RACScheduler<span class="token punctuation">.</span>currentScheduler <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>backgroundScheduler schedule<span class="token punctuation">:</span>block<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从如上的调用链可以看出，<code>RACDynamicSignal</code>的<code>didSubscribe</code> block 最终在<code>RACSubscriptionScheduler#schedule:</code>中被调用。回到<code>RACSubscriptionScheduler#schedule:</code>：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">)</span>schedule<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>block <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RACScheduler<span class="token punctuation">.</span>currentScheduler <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>backgroundScheduler schedule<span class="token punctuation">:</span>block<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>RACScheduler.currentScheduler</code>是什么鬼呢？简单来说，若当前上下文被包裹在<code>RACScheduler#schedule:</code>的 block 中，或者当前上下文处于 main thread 中，<code>RACScheduler.currentScheduler</code>返回有效值，否则返回<code>nil</code>。而所谓的当前上下文，其实就是<code>[signal subscribeNext:{}]</code>所处的上下文。</p> <p>换句话说，如果在<code>RACScheduler#schedule</code>中 – 或者在主线程中 – 执行<code>[signal subscribeNext:{}]</code>逻辑，则 2~4 行的<code>if</code>语句不会被执行，而是直接执行<code>didSubscribe</code>这个 block（第 5 行）。这充分验证了「在订阅线程里执行 didSubscribe block」这个说法。</p> <p>又一个问题来了：如果使用<code>dispatch_async(someQueue, {})</code>代替<code>[RACScheduler scheduler] schedule:{}</code>，还有「在订阅线程里执行 didSubscribe block」这个保证吗？</p> <p>我验证过，同样没问题！</p> <h2 id="异步发送"><a href="#异步发送" class="header-anchor">#</a> 异步发送</h2> <p>如下代码在主线程环境下执行：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// mark 1</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler scheduler<span class="token punctuation">]</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>   <span class="token comment">// mark 2</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>           <span class="token comment">// mark 3</span>
        <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// mark 4</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>mark 2</code>异步（子线程）产生了一个值事件，这次需要关心的是：<code>mark 1</code>、<code>mark 3</code>以及<code>mark 4</code>分别在哪个线程执行，主线程还是子线程？
答案是：<code>mark 1</code>在主线程执行，<code>mark 3</code>和<code>mark 4</code>的调用都在同一个子线程中完成。如下图：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/asnyc-send@2x.png" srcset="/image/asnyc-send@2x.png 2x" data-v-339c7bd5></div> <p><strong>Signal 一旦产生 event，相关的 subscription block 就立马被调用</strong>。这没啥好说的：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>sendNext<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>value <span class="token punctuation">{</span>
    <span class="token operator">@</span>synchronized <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span>nextBlock<span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>next copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextBlock <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
 
        <span class="token function">nextBlock</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有了对「异步订阅」和「异步发送」的认知，更复杂的情况也比较容易分析了。</p> <h2 id="同步-异步发送"><a href="#同步-异步发送" class="header-anchor">#</a> 同步 + 异步发送</h2> <p>在上面的代码的基础上，做了一点修改，分别以同步和异步的方式产生值事件：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// mark 1</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;5&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>             <span class="token comment">// mark 5</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler scheduler<span class="token punctuation">]</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>   <span class="token comment">// mark 2</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">// mark 3</span>
        <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// mark 4</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>显然，<code>mark 4</code>被调用两次，需要关心的是：这两次的执行线程是怎么样的？</p> <p>答案是：<code>5</code>在主线程被打印，<code>3</code>在子线程被打印。如下图：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/snyc-send-and-asnyc-send@2x.png" srcset="/image/snyc-send-and-asnyc-send@2x.png 2x" data-v-339c7bd5></div> <h2 id="异步订阅-异步发送"><a href="#异步订阅-异步发送" class="header-anchor">#</a> 异步订阅+异步发送</h2> <p>继续看代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// mark 1</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler scheduler<span class="token punctuation">]</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>   <span class="token comment">// mark 2</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">// mark 3</span>
        <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler scheduler<span class="token punctuation">]</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>       <span class="token comment">// mark 4</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// mark 5</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>mark 4</code>和<code>mark 2</code>分别会创建两个子线程，称为「子线程 4」和「子线程 2」，则打印结果如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/asnyc-subscribe-and-asnyc-send@2x.png" srcset="/image/asnyc-subscribe-and-asnyc-send@2x.png 2x" data-v-339c7bd5></div> <h2 id="subscribeon-和-deliveron"><a href="#subscribeon-和-deliveron" class="header-anchor">#</a> <code>subscribeOn:</code>和 deliverOn</h2> <p>上面的分析看出，异步订阅和异步发送会带来一些坑，臧成威总结了两点：</p> <ul><li>订阅时机不确定。即 didSubscribe block 的执行线程是不确定的，它由订阅的上下文线程决定。</li> <li>发送时机不确定。subscription block 的执行线程也不确定，它有<code>sendNext:</code>/<code>sendError:</code>/<code>sendCompleted</code>的执行线程决定。</li></ul> <p>P.S: 对于「订阅时机不确定」，更专业的说法是，副作用的执行线程不确定。</p> <p><code>subscribeOn:</code>和<code>deliverOn:</code>分别可以解决这两个问题。</p> <h3 id="subscribeon"><a href="#subscribeon" class="header-anchor">#</a> subscribeOn</h3> <p>在上文「异步订阅」代码块的基础上添加一句：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// mark 1</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token comment">// mark 2</span>
    <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
signal <span class="token operator">=</span> <span class="token punctuation">[</span>signal subscribeOn<span class="token punctuation">:</span><span class="token punctuation">[</span>RACScheduler mainThreadScheduler<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// add</span>
 
<span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler scheduler<span class="token punctuation">]</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>  <span class="token comment">// mark 3</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// mark 4</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行结果描述如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/subscribe-on@2x.png" srcset="/image/subscribe-on@2x.png 2x" data-v-339c7bd5></div> <p><code>RACSignal+Operation.h</code>告诫尽可能不要使用<code>subscribeOn:</code>：</p> <blockquote><p>Creates and returns a signal that executes its side effects and delivers its events on the given scheduler.
Use of this operator should be avoided whenever possible, because the receiver's side effects may not be safe to run on another thread. If you just want to receive the signal's events on <code>scheduler</code>, use -deliverOn: instead.</p></blockquote> <h3 id="deliveron"><a href="#deliveron" class="header-anchor">#</a> deliverOn</h3> <p>在上文「异步发送」代码块的基础上添加一句：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// mark 1</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>RACScheduler scheduler<span class="token punctuation">]</span> schedule<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>   <span class="token comment">// mark 2</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token operator">@</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>           <span class="token comment">// mark 3</span>
        <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
signal <span class="token operator">=</span> <span class="token punctuation">[</span>signal deliverOn<span class="token punctuation">:</span><span class="token punctuation">[</span>RACScheduler mainThreadScheduler<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// add</span>
<span class="token comment">// 使用`signal = [signal deliverOnMainThread]`更简洁</span>
 
<span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// mark 4</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>执行结果描述如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/deliver-on@2x.png" srcset="/image/deliver-on@2x.png 2x" data-v-339c7bd5></div> <p><code>RACSignal+Operation.h</code>对<code>deliverOn:</code>的描述如下：</p> <blockquote><p>Creates and returns a signal that delivers its events on the given scheduler. Any side effects of the receiver will still be performed on the original thread.
This is ideal when the signal already performs its work on the desired thread, but you want to handle its events elsewhere.
This corresponds to the <code>ObserveOn</code> method in Rx.</p></blockquote></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/95.fa3326f7.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
