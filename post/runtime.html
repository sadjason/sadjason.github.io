<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Objective-C Runtime 分析 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/98.d745e5ec.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">Objective-C Runtime 分析</div> <div class="post-info">2018-11-01</div></div> <div class="content content__default"><p>稍微了解 Mach-O 和 dyld 后，自然抑制不住重新梳理 Objective-C 底层知识的想法。OC 底层知识最核心的部分莫过于 runtime；所以本文的分析对象是 OC 的 runtime。OC runtime 源码是开放的，本文参考的版本是：<a href="https://opensource.apple.com/source/objc4/objc4-750/runtime" target="_blank" rel="noopener noreferrer">objc4-750<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <blockquote><p>在分析过程中，若能将 objc-runtime 跑起来，岂不美哉？RetVal 大神制作了一份可以跑的 objc/runtime 工程：<a href="https://github.com/RetVal/objc-runtime/tree/objc.750" target="_blank" rel="noopener noreferrer">RetVal/objc-runtime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></blockquote> <p>objc/runtime 值得分析的点非常多，本文的分析主要围绕两个大问题进行：</p> <ul><li><code>_objc_init</code>（runtime 的入口）是如何被调用的？</li> <li>类的加载过程是怎么样的？</li></ul> <h1 id="从-objc-init-说起"><a href="#从-objc-init-说起" class="header-anchor">#</a> 从 _objc_init 说起</h1> <p><code>_objc_init</code>是 libobjc runtime 的入口函数，通过给 Xcode 工程设置<code>_objc_init</code>符号断点可以证明这一点：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/objc_init_breakpoint.png" srcset="/image/objc_init_breakpoint.png 2x" data-v-339c7bd5></div> <p>上图调用栈中，从 dyld 的入口函数<code>_dyld_start</code>开始，经过一系列周转，最终<code>_objc_init</code>被调用。</p> <h2 id="objc-init-调用过程分析"><a href="#objc-init-调用过程分析" class="header-anchor">#</a> _objc_init 调用过程分析</h2> <p>在开始分析<code>_objc_init</code>之前，得搞清楚这么一个问题：<code>_objc_init</code>是如何被调用的？为啥抛出这么一个问题，上图调用链不是很明显吗？事实是，上图<code>libSystem_initializer</code>的调用逻辑稍微有些令人困惑，因为并没有在源码中找到对它的显式调用。关于这一疑点，没有在任何博客中找到解释。因此，本文略花篇幅围绕源码进行简单分析，所参考的源码包括：</p> <ul><li><a href="https://opensource.apple.com/source/dyld/dyld-635.2/" target="_blank" rel="noopener noreferrer">dyld-635.2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://opensource.apple.com/source/libdispatch/libdispatch-1008.220.2/" target="_blank" rel="noopener noreferrer">libdispatch-1008.200.78<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://opensource.apple.com/source/Libsystem/Libsystem-1252/" target="_blank" rel="noopener noreferrer">libsystem-1252<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://opensource.apple.com/source/objc4/objc4-750/" target="_blank" rel="noopener noreferrer">objc4-750<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>通过分析 libsystem、libdispatch、objc 这几个 library 的源码，很快理清了这么一条调用栈：</p> <div class="language-raw extra-class"><pre class="language-text"><code>-&gt; libSystem_initializer (定义于 libSystem 的 init.c)
  -&gt; libdispatch_init (定义于 libdispatch 的 queue.c)
    -&gt; _os_object_init (定义于 libdispatch 的 object.mm)
      -&gt; _objc_init (定义于 libobjc 的 objc-os.mm)
</code></pre></div><p>而从上文截图的调用栈可以知道，<code>libSystem_initializer</code>是在<code>doModInitFunctions</code>中被调用的，后者定义于<a href="https://opensource.apple.com/source/dyld/dyld-635.2/src/ImageLoaderMachO.cpp.auto.html" target="_blank" rel="noopener noreferrer">ImageLoaderMachO.cpp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>如上所述，<code>doModInitFunctions</code>中并没有显式调用<code>libSystem_initializer</code>的逻辑，如下是该函数源码的简化版：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> ImageLoaderMachO<span class="token operator">::</span><span class="token function">doModInitFunctions</span><span class="token punctuation">(</span><span class="token keyword">const</span> LinkContext<span class="token operator">&amp;</span> context<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cmd_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> cmd<span class="token operator">-&gt;</span>cmd <span class="token operator">==</span> LC_SEGMENT_COMMAND <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">macho_section</span><span class="token operator">*</span> sect<span class="token operator">=</span>sectionsStart<span class="token punctuation">;</span> sect <span class="token operator">&lt;</span> sectionsEnd<span class="token punctuation">;</span> <span class="token operator">++</span>sect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> uint8_t type <span class="token operator">=</span> sect<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> SECTION_TYPE<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> type <span class="token operator">==</span> S_MOD_INIT_FUNC_POINTERS <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Initializer<span class="token operator">*</span> inits <span class="token operator">=</span> <span class="token punctuation">(</span>Initializer<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sect<span class="token operator">-&gt;</span>addr <span class="token operator">+</span> fSlide<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Initializer func <span class="token operator">=</span> inits<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> dyld<span class="token operator">::</span>gProcessInfo<span class="token operator">-&gt;</span>libSystemInitialized <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> installPath <span class="token operator">=</span> <span class="token function">getInstallPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>installPath <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>installPath<span class="token punctuation">,</span> LIBSYSTEM_DYLIB_PATH<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                  dyld<span class="token operator">::</span><span class="token function">throwf</span><span class="token punctuation">(</span><span class="token string">&quot;initializer in image (%s) that does not link with libSystem.dylib\n&quot;</span><span class="token punctuation">,</span> this<span class="token operator">-&gt;</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              bool haveLibSystemHelpersBefore <span class="token operator">=</span> <span class="token punctuation">(</span>dyld<span class="token operator">::</span>gLibSystemHelpers <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">{</span>
                <span class="token function">func</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>argc<span class="token punctuation">,</span> context<span class="token punctuation">.</span>argv<span class="token punctuation">,</span> context<span class="token punctuation">.</span>envp<span class="token punctuation">,</span> context<span class="token punctuation">.</span>apple<span class="token punctuation">,</span> <span class="token operator">&amp;</span>context<span class="token punctuation">.</span>programVars<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              bool haveLibSystemHelpersAfter <span class="token operator">=</span> <span class="token punctuation">(</span>dyld<span class="token operator">::</span>gLibSystemHelpers <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>haveLibSystemHelpersBefore <span class="token operator">&amp;&amp;</span> haveLibSystemHelpersAfter <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// now safe to use malloc() and other calls in libSystem.dylib</span>
                dyld<span class="token operator">::</span>gProcessInfo<span class="token operator">-&gt;</span>libSystemInitialized <span class="token operator">=</span> true<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个函数要做的事情很直接，找到镜像中<code>flags</code>字段匹配<code>S_MOD_INIT_FUNC_POINTERS</code>的 section，这种类型的 section 存储函数指针，dyld 遍历这些函数指针并调用。</p> <p>不出意外，libSystem.dylib 中就有 flags 为<code>S_MOD_INIT_FUNC_POINTERS</code>的 section，可以使用 MachOView 或者 otool 工具查看确认：</p> <div class="language-sh extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-sh"><code>$ otool -l /usr/lib/libSystem.dylib
<span class="token punctuation">..</span>.
Section
  sectname __mod_init_func
   segname __DATA
      addr 0x0000000000002218
      size 0x0000000000000008
    offset <span class="token number">8728</span>
     align <span class="token number">2</span>^3 <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    reloff <span class="token number">0</span>
    nreloc <span class="token number">0</span>
     flags 0x00000009
 reserved1 <span class="token number">0</span>
 reserved2 <span class="token number">0</span>
</code></pre></div><p>上述 0x09 对应的值即<code>S_MOD_INIT_FUNC_POINTERS</code>，顾名思义，它表示该字段存储的是函数指针，这些函数指针在模块（镜像）被加载时调用。</p> <p>对于 libSystem.dylib 而言，该 section 名为<code>__mod_init_func</code>（一般都是这个名字），存储了一个函数指针，该函数指针恰好对应<code>_libSystem_initializer</code>符号。当<code>libSystem_initializer</code>被调用时，dyld 会对<code>gProcessInfo-&gt;libSystemInitialized</code>进行标记，表示 libSystem 已经被初始化。</p> <div class="custom-block tip"><p class="custom-block-title">补充说明</p> <p>如何确保自定义函数被编译到<code>__mod_init_func</code>中呢？一种常见的做法是对函数标记<code>__attribute__((constructor))</code>。</p> <p>libSystem 的初始化是一个内部行为，dyld 是如何知道它被初始化的呢？libSystem 是一个特殊的 dylib，默认情况下会被所有可执行文件所依赖，dyld 为它单独提供了一个 API：<code>_dyld_initializer</code>，当 libSystem 被初始化时，会调用该函数，进而 dyld 内部就知道了 libSystem 被初始化了。</p></div> <p>OK，搞清楚<code>libSystem_initializer</code>的调用逻辑，强行对<code>_objc_init</code>的调用链分析收个尾。接下来看看<code>_objc_init</code>做了些什么...</p> <h2 id="objc-init-逻辑分析"><a href="#objc-init-逻辑分析" class="header-anchor">#</a> _objc_init 逻辑分析</h2> <p>如下是<code>_objc_init</code>的源码，非常短：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">_objc_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> bool initialized <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    initialized <span class="token operator">=</span> true<span class="token punctuation">;</span>
    
    <span class="token comment">// fixme defer initialization until an objc-using image is found?</span>
    <span class="token function">environ_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tls_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">static_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lock_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exception_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">_dyld_objc_notify_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>map_images<span class="token punctuation">,</span> load_images<span class="token punctuation">,</span> unmap_image<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该函数做了两件事，首先进行一系列的初始化，本文不对这些初始化展开（其实也说不太清除）；其次调用<code>_dyld_objc_notify_register</code>注册，它是关键。</p> <p><code>_dyld_objc_notify_register</code>是 dyld 为 libobjc 提供的一个钩子，用来注册 handlers：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//</span>
<span class="token comment">// Note: only for use by objc runtime</span>
<span class="token comment">// Register handlers to be called when objc images are mapped, unmapped, and initialized.</span>
<span class="token comment">// Dyld will call back the &quot;mapped&quot; function with an array of images that contain an objc-image-info section.</span>
<span class="token comment">// Those images that are dylibs will have the ref-counts automatically bumped, so objc will no longer need to</span>
<span class="token comment">// call dlopen() on them to keep them from being unloaded.  During the call to _dyld_objc_notify_register(),</span>
<span class="token comment">// dyld will call the &quot;mapped&quot; function with already loaded objc images.  During any later dlopen() call,</span>
<span class="token comment">// dyld will also call the &quot;mapped&quot; function.  Dyld will call the &quot;init&quot; function when dyld would be called</span>
<span class="token comment">// initializers in that image.  This is when objc calls any +load methods in that image.</span>
<span class="token comment">//</span>
<span class="token keyword">void</span> <span class="token function">_dyld_objc_notify_register</span><span class="token punctuation">(</span>_dyld_objc_notify_mapped    mapped<span class="token punctuation">,</span>
                                _dyld_objc_notify_init      init<span class="token punctuation">,</span>
                                _dyld_objc_notify_unmapped  unmapped<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当 dyld 完成对镜像的符号绑定时，镜像状态变为<code>dyld_image_state_bound</code>， dyld 会针对 OC 镜像，调用 libobjc 注册的 mapped handler，对镜像进行 objc 层次的处理；此后，dyld 对镜像进行初始化，触发 init handler 的调用；而 remove 镜像操作触发 unmapped handler 的调用。</p> <blockquote><p>dyld 如何判断 OC 镜像呢？不同版本的 dyld 处理逻辑不同，本文所参考的 dyld，会根据镜像是否含有<code>__objc_image_info</code> section 来判断它是否是 OC 镜像。</p></blockquote> <p>从 objc/runtime 内部来看，mapped 和 init 这俩 handler 分别对应<code>map_images()</code>和<code>load_images()</code>函数，在<code>map_images</code>中，runtime 完成了对镜像的类的构建，它是本文分析的重点。<code>load_images</code>逻辑相对比较简单，所做的事情主要是调用<code>+load</code>方法。</p> <h1 id="从-mach-o-视角看类结构"><a href="#从-mach-o-视角看类结构" class="header-anchor">#</a> 从 Mach-O 视角看类结构</h1> <p>在分析类的构建过程之前，先站在 Mach-O 的视角窥视静态状态下的类结构。</p> <p>Mach-O 是如何组织类信息的呢？源码中的类信息是内聚在一起的，类和类元素（方法、成员变量等）有着比较清晰的包含关系，但落实到二进制数据组织上，信息分散得比较厉害，下图截自某个 Mach-O 文件中描述 OC 类信息的片区：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/objc-in-macho.png" srcset="/image/objc-in-macho.png 2x" data-v-339c7bd5></div> <p>下表对这些 section 简单描述一下：</p> <table><thead><tr><th style="text-align:left;">Section Name</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">__objc_imageinfo</td> <td style="text-align:left;">记录 Objective-C 环境信息等，dyld 用它来判断镜像是否是 objc 镜像</td></tr> <tr><td style="text-align:left;">__objc_classlist</td> <td style="text-align:left;">记录镜像所定义的类，每个条目都是一个指针，指向到 __objc_data section</td></tr> <tr><td style="text-align:left;">__objc_data</td> <td style="text-align:left;">存放真正的类数据，和 __objc_classlist 条目呼应</td></tr> <tr><td style="text-align:left;">__objc_classname</td> <td style="text-align:left;">类名列表</td></tr> <tr><td style="text-align:left;">__objc_methodname</td> <td style="text-align:left;">方法名列表</td></tr> <tr><td style="text-align:left;">__objc_methodtype</td> <td style="text-align:left;">方法类型列表</td></tr> <tr><td style="text-align:left;">__objc_selrefs</td> <td style="text-align:left;">selector 列表信息，每个条目是指向到 __objc_methname 的指针，记录 selector 的名字</td></tr> <tr><td style="text-align:left;">__objc_classrefs</td> <td style="text-align:left;">类引用列表</td></tr> <tr><td style="text-align:left;">__objc_ivar</td> <td style="text-align:left;">类的成员变量列表</td></tr> <tr><td style="text-align:left;">__objc_const</td> <td style="text-align:left;">存放类的元数据，包括：method list、variable list、property list、class info</td></tr></tbody></table> <p>如何知道一个镜像定义了多少个类？可以从<code>__objc_classlist</code> section 知晓，它是一个列表，每一项是一个指针，对应镜像定义的某个类，指针指向到<code>__objc_data</code> section。<code>__objc_data</code>中的条目长度是固定的：40 bytes（64 位架构）；在 runtime 阶段，libobjc 根据<code>__objc_classlist</code>对<code>__objc_data</code> section 进行解析，解析所使用的结构体是<code>objc_class</code>。</p> <p><code>objc_class</code>继承自<code>objc_object</code>，如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">objc_object</span> <span class="token punctuation">{</span>
    isa_t isa<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_object</span> <span class="token operator">*</span>id<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">objc_class</span> <span class="token operator">:</span> objc_object <span class="token punctuation">{</span>
    <span class="token comment">// Class ISA;</span>
    Class superclass<span class="token punctuation">;</span>
    cache_t cache<span class="token punctuation">;</span>             <span class="token comment">// formerly cache pointer and vtable</span>
    class_data_bits_t bits<span class="token punctuation">;</span>    <span class="token comment">// class_rw_t * plus custom rr/alloc flags</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">objc_class</span> <span class="token operator">*</span>Class<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>Runtime 定义了各种各样的数据结构描述类和相关元素，其中部分数据结构是用户可见的，除了<code>objc_object</code>、<code>objc_class</code>，还有：<code>objc_selector</code>、<code>method_t</code>、<code>objc_ivar</code>、<code>objc_property</code>、<code>objc_category</code>，另外很多数据结构于用户而言是不可见的，譬如<code>classref</code>、<code>class_rw_t</code>等。本文只在需要的时候对结构体展开分析，如无必要，一带而过。</p></blockquote> <p><code>objc_object</code>用来描述 OC 中的实例，当用口语描述实例时，总会说「XX 类的实例 x」或「x 是 XX 的实例」；<code>objc_object</code>的<code>isa</code>在程序结构上表达类似的含义，它指向了该实例所对应的类，类在 runtime 中被描述成<code>objc_class</code>结构。</p> <p><code>objc_class</code>继承自<code>objc_object</code>，所以它也有<code>isa</code>指针，指向到它的元类，对于元类而言，类本身也是一个对象；<code>objc_class</code>的<code>superclass</code>成员变量指向该类的父类；<code>isa</code>和<code>superclass</code>这两个成员变量在继承链中扮演着关键作用，满足了类的继承关系的构建，针对它们进行分析的资料太多了，本文不再赘述。<code>cache</code>成员变量与优化有关，譬如缓存最近命中的方法等。对于<code>bits</code>字段，通过它，可以找到类的其他描述信息，包括类名、方法、成员变量等。</p> <p><code>bits</code>的类型<code>class_data_bits_t</code>是一个结构体，只有一个也叫<code>bits</code>的成员变量，对于 64 位机器架构，它有 64 bits，低二位用于描述 Swift 版本，<code>bit[3]</code>描述当前类或者父类是否有默认的<code>retain</code>、<code>release</code>、<code>autorelease</code>、<code>retainCount</code>、<code>_tryRetain</code>、<code>_isDeallocating</code>、<code>retainWeakReference</code>、<code>allowsWeakReference</code>系列方法。<code>bits[3:47]</code>描述的是指向到 class data 的指针，高 17 位是保留区，如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/class_data_bits_t.png" srcset="/image/class_data_bits_t.png 2x" data-v-339c7bd5></div> <p>初始状态下，class data 的指针指向到镜像的<code>__objc_const</code>区域，该区域的其中一部分存储类的元数据，如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/class-info-in-macho.png" srcset="/image/class-info-in-macho.png 2x" data-v-339c7bd5></div> <p>Runtime 对上图数据的解析使用<code>class_ro_t</code>结构体，该结构体于用户而言是不可见的，定义如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">class_ro_t</span> <span class="token punctuation">{</span>
    uint32_t flags<span class="token punctuation">;</span>                   <span class="token comment">// 杂项</span>
    uint32_t instanceStart<span class="token punctuation">;</span>           <span class="token comment">// 与健壮性有关</span>
    uint32_t instanceSize<span class="token punctuation">;</span>            <span class="token comment">// 与健壮性有关</span>
    uint32_t reserved<span class="token punctuation">;</span>                <span class="token comment">// 保留</span>

    <span class="token keyword">const</span> uint8_t <span class="token operator">*</span> ivarLayout<span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> name<span class="token punctuation">;</span>                <span class="token comment">// 类名</span>
    method_list_t <span class="token operator">*</span> baseMethodList<span class="token punctuation">;</span>   <span class="token comment">// 方法列表</span>
    protocol_list_t <span class="token operator">*</span> baseProtocols<span class="token punctuation">;</span>  <span class="token comment">// 协议列表</span>
    <span class="token keyword">const</span> ivar_list_t <span class="token operator">*</span> ivars<span class="token punctuation">;</span>        <span class="token comment">// 实例变量</span>

    <span class="token keyword">const</span> uint8_t <span class="token operator">*</span> weakIvarLayout<span class="token punctuation">;</span>
    property_list_t <span class="token operator">*</span>baseProperties<span class="token punctuation">;</span>

    <span class="token comment">/* ...... */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>__objc_const</code>的 class info 条目（<code>class_ro_t</code>实例）的成员变量，大部分都是指针，分别描述类名、方法列表、协议列表等，从 Mach-O 视角来看，这些指针指向到<code>__objc_classname</code>、<code>__objc_const</code> method list、<code>__objc_const</code> variable list、<code>__objc_const</code> protocol list 等等，而它们又通过指针将触角伸到其他以<code>__objc</code>为前缀的 section。</p> <p>综上，可以看到，在编译阶段，编译器就对 OC 类结构的基本信息进行了整理，只是这些信息比较分散，零散分布到各种以<code>__objc</code>为前缀的 section 中。libobjc 在 runtime 阶段，特别重要的一项工作是：将 Mach-O 中以<code>__objc</code>为前缀的零散 section 信息提取出来进行再加工结构化。</p> <h1 id="类的加载过程"><a href="#类的加载过程" class="header-anchor">#</a> 类的加载过程</h1> <p>从函数<code>map_images()</code>开始分析类的加载过程，调用栈如下：</p> <div class="language-raw extra-class"><pre class="language-text"><code>map_images
  -&gt; map_images_nolock
    -&gt; _read_images
</code></pre></div><p>类的主要加载过程在<code>_read_images()</code>完成，做了如下事情：</p> <ul><li>discover classes. 即从镜像提取类信息，并存到名为<code>allocatedClasses</code>的全局 hash table 中</li> <li>remap classes. 重新调整类之间的引用</li> <li>fix up selector references. 提取方法，并注册到名为<code>namedSelectors</code>的全局 map table 中</li> <li>fix up objc_msgSend_fixup</li> <li>discover protocols. 提取 protocols，存储到全局 map table</li> <li>fix up @protocol references. 和类一样，protocol 也有继承关系，此过程 fixup 它们的依赖关系</li> <li>realize non-lazy classes. realize 含有<code>+load</code>方法或者静态实例的类</li> <li>realize future classes. realize 含有<code>RO_FUTURE</code>标识的类，这些类一般是 Core Foundation 中的类</li> <li>discover categories. 提取 categories，存储到全局 map table</li></ul> <p>上述过程最值得研究的莫过于 realize。</p> <p>笔者并没有找到权威的资料来解释 realize 的含义，只能根据对源码的理解自说自话。OC 类在被使用之前（譬如调用类方法），需要进行一系列的初始化，譬如：指定 superclass、指定 isa 指针、attach categories 等等；libobjc 在 runtime 阶段就可以做这些事情，但是有些过于浪费，更好的选择是懒处理，这一举措极大优化了程序的执行速度。而 runtime 把对类的这些惰性初始化过程称为「realize」。</p> <p>对于用户定义的大部分类的 realize 处理，是在类第一次被使用时进行的；但对于某些类，需要在 runtime 阶段就进行 realize 处理；其一是 non-lazy classes，包括含有<code>+load</code>方法的类，以及含有静态实例（譬如单例）的类；其二是 future classes，笔者也不太理解这个概念，但貌似是为 Core Foundation 中定义的类服务的。</p> <p>接下来的重点是分析 realize 做了哪些事情，realize class 的主要逻辑发生在<code>realizeClass()</code>中，如下是其逻辑代码的简化版本：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/***********************************************************************
* realizeClass
* Performs first-time initialization on class cls, 
* including allocating its read-write data.
* Returns the real class structure for the class. 
* Locking: runtimeLock must be write-locked by the caller
**********************************************************************/</span>
<span class="token keyword">static</span> Class <span class="token function">realizeClass</span><span class="token punctuation">(</span>Class cls<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 分配可读写的 class_rw_t 来替换 class_ro_t</span>
    rw <span class="token operator">=</span> <span class="token punctuation">(</span>class_rw_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>class_rw_t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rw<span class="token operator">-&gt;</span>ro <span class="token operator">=</span> ro<span class="token punctuation">;</span>
    rw<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> RW_REALIZED<span class="token operator">|</span>RW_REALIZING<span class="token punctuation">;</span>
    cls<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span>rw<span class="token punctuation">)</span><span class="token punctuation">;</span>

    isMeta <span class="token operator">=</span> ro<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> RO_META<span class="token punctuation">;</span>

    <span class="token comment">// 2. 设置 class 的 index</span>
    cls<span class="token operator">-&gt;</span><span class="token function">chooseClassArrayIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. realize and fixup superclass and metaclass</span>
    supercls <span class="token operator">=</span> <span class="token function">realizeClass</span><span class="token punctuation">(</span><span class="token function">remapClass</span><span class="token punctuation">(</span>cls<span class="token operator">-&gt;</span>superclass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    metacls <span class="token operator">=</span> <span class="token function">realizeClass</span><span class="token punctuation">(</span><span class="token function">remapClass</span><span class="token punctuation">(</span>cls<span class="token operator">-&gt;</span><span class="token function">ISA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cls<span class="token operator">-&gt;</span>superclass <span class="token operator">=</span> supercls<span class="token punctuation">;</span>
    cls<span class="token operator">-&gt;</span><span class="token function">initClassIsa</span><span class="token punctuation">(</span>metacls<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 将自身添加到 superclass 的 subclass 列表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>supercls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addSubclass</span><span class="token punctuation">(</span>supercls<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">addRootClass</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 将 class_ro_t 和 category 中的 methods、protocols、properties，添加到 class_rw_t 中</span>
    <span class="token function">methodizeClass</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> cls<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关键代码是：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// 1. 分配可读写的 class_rw_t 来替换 class_ro_t</span>
<span class="token comment">// 1.1 创建 class_rw_t 结构体</span>
rw <span class="token operator">=</span> <span class="token punctuation">(</span>class_rw_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>class_rw_t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1.2 挂载 class_ro_t 到 class_rw_t</span>
rw<span class="token operator">-&gt;</span>ro <span class="token operator">=</span> ro<span class="token punctuation">;</span>
<span class="token comment">// 1.3 设置 flags，表示该 class 已经被 realize 了</span>
rw<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> RW_REALIZED<span class="token operator">|</span>RW_REALIZING<span class="token punctuation">;</span>
<span class="token comment">// 1.4 将 cls 的 data 指针指向到 rw</span>
cls<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span>rw<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>前文站在 Mach-O 的视角分析了类的结构，我们得知，objc_class 的 data 指针最开始指向<code>class_ro_t</code>结构体，它包含了类名、方法列表、属性列表、协议列表等信息；但在 realize 逻辑中，libobjc 创建了一个<code>class_rw_t</code>结构体，并将 data 指针指向到该结构体。</p> <p>如何看待 libobjc 的这个设计呢？可以这么理解，<code>class_ro_t</code>包含的类信息（方法、属性、协议等）都是在编译期就可以确定的，暂且称为元信息吧，在之后的逻辑中，它们显然是不希望被改变的；后续在用户层，无论是方法还是别的扩展，都是在<code>class_rw_t</code>上进行操作，这些操作都不会影响类的元信息。</p> <p><code>class_rw_t</code>的定义如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">class_rw_t</span> <span class="token punctuation">{</span>
    uint32_t flags<span class="token punctuation">;</span>               <span class="token comment">// 杂项</span>
    uint32_t version<span class="token punctuation">;</span>

    <span class="token keyword">const</span> class_ro_t <span class="token operator">*</span>ro<span class="token punctuation">;</span>         <span class="token comment">// 原始类信息</span>

    method_array_t methods<span class="token punctuation">;</span>       <span class="token comment">// 类列表</span>
    property_array_t properties<span class="token punctuation">;</span>  <span class="token comment">// 属性列表</span>
    protocol_array_t protocols<span class="token punctuation">;</span>   <span class="token comment">// 协议列表</span>

    Class firstSubclass<span class="token punctuation">;</span>          <span class="token comment">// 第一个子类</span>
    Class nextSiblingClass<span class="token punctuation">;</span>       <span class="token comment">// 兄弟类</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>demangledName<span class="token punctuation">;</span>
    uint32_t index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>realize 作为 objc runtime 中类的懒加载机制，在类真正要使用时再去做相应的准备工作，为确保程序的快速启动发挥了很大的作用；利用已经被 realize 的类含有<code>RW_REALIZED</code>和<code>RW_REALIZING</code>标记的特点，可以为项目找出无用类：因为没有被使用的类，一定没有被 realized。</p> <h1 id="load"><a href="#load" class="header-anchor">#</a> +load</h1> <p>当 dyld 完成对 OC 镜像初始化时，会调用<code>load_images()</code>，它所做的工作比较简单，找出所有<code>+load</code>方法并调用：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">load_images</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path __unused<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">mach_header</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Discover load methods</span>
    <span class="token function">prepare_load_methods</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> headerType <span class="token operator">*</span><span class="token punctuation">)</span>mh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Call +load methods</span>
    <span class="token function">call_load_methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>prepare_load_methods()</code>遍历找出类的<code>+load</code>方法，并把它们添加到全局数组<code>loadable_classes</code>中；并找出 category 的<code>+load</code>方法，把它们添加到全局数组<code>loadable_categories</code>中。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">schedule_class_load</span><span class="token punctuation">(</span>Class cls<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 确保 superclass 的 +load 先加入</span>
    <span class="token function">schedule_class_load</span><span class="token punctuation">(</span>cls<span class="token operator">-&gt;</span>superclass<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">add_class_to_loadable_list</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cls<span class="token operator">-&gt;</span><span class="token function">setInfo</span><span class="token punctuation">(</span>RW_LOADED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">prepare_load_methods</span><span class="token punctuation">(</span><span class="token keyword">const</span> headerType <span class="token operator">*</span>mhdr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    classref_t <span class="token operator">*</span>classlist <span class="token operator">=</span>  <span class="token function">_getObjc2NonlazyClassList</span><span class="token punctuation">(</span>mhdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">schedule_class_load</span><span class="token punctuation">(</span><span class="token function">remapClass</span><span class="token punctuation">(</span>classlist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>

    <span class="token comment">// category 的 +load 被加入到全局数组 loadable_categories 中</span>
    category_t <span class="token operator">*</span><span class="token operator">*</span>categorylist <span class="token operator">=</span> <span class="token function">_getObjc2NonlazyCategoryList</span><span class="token punctuation">(</span>mhdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        category_t <span class="token operator">*</span>cat <span class="token operator">=</span> categorylist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Class cls <span class="token operator">=</span> <span class="token function">remapClass</span><span class="token punctuation">(</span>cat<span class="token operator">-&gt;</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">realizeClass</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add_category_to_loadable_list</span><span class="token punctuation">(</span>cat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">call_load_methods</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool more_categories<span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. Repeatedly call class +loads until there aren't any more</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>loadable_classes_used <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">call_class_loads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. Call category +loads ONCE</span>
        more_categories <span class="token operator">=</span> <span class="token function">call_category_loads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. Run more +loads if there are classes OR more untried categories</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>loadable_classes_used <span class="token operator">&gt;</span> <span class="token number">0</span>  <span class="token operator">||</span>  more_categories<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从这段代码，可以梳理出我们所熟悉的<code>+load</code>调用顺序：</p> <ul><li>父类的<code>+load</code>一定比子类的<code>+load</code>早被调用</li> <li>主类的<code>+load</code>一定比分类的<code>+load</code>早被调用</li></ul> <p><code>+load</code>的源码相对较简单，左神的博客<a href="https://draveness.me/load" target="_blank" rel="noopener noreferrer">你真的了解 load 方法么？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>有更丰富的分析...</p> <h1 id="更多阅读"><a href="#更多阅读" class="header-anchor">#</a> 更多阅读</h1> <ul><li><a href="https://draveness.me/load" target="_blank" rel="noopener noreferrer">你真的了解 load 方法么？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://draveness.me/method-struct" target="_blank" rel="noopener noreferrer">深入解析 ObjC 中方法的结构<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://cocoasamurai.blogspot.jp/2010/01/understanding-objective-c-runtime.html" target="_blank" rel="noopener noreferrer">Understanding the Objective-C Runtime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/98.d745e5ec.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
