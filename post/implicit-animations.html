<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>隐式动画 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/74.b4028d07.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/4.a7413ce2.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">隐式动画</div> <div class="post-info">2016-06-26 • iOS</div></div> <div class="content content__default"><p>根据我粗浅的理解，「隐式动画」中的所谓「隐式」，是相对于「显式动画」中的显式而言的。</p> <p>实现显式动画时，往往会创建一个动画对象，譬如<code>CAAnimation</code>、<code>CABasicAnimation</code>、<code>CAKeyframeAnimation</code>，然后通过<code>CALayer#addAnimation(_:forKey:)</code>方法该动画对象绑定到 layer 中，简单来说，我们所选的动画类型是确定的。</p> <blockquote><p>P.S: 关于显式动画更多内容详见<a href="/explicit-animations/">这里</a>。</p></blockquote> <p>而实现隐式动画时，无需指定动画类型，仅仅改变了一个属性，然后 Core Animation 来决定如何并且何时去做动画。</p> <h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <p>隐式动画中有一个「事务」的概念。</p> <p><strong>事务</strong>（transaction）实际上是 Core Animation 用来包含一系列属性动画集合的机制，用指定事务去改变可以做动画的图层属性，不会立刻发生变化，而是提交事务时用一个动画过渡到新值。</p> <p>Core Animation 中的事务通过<code>CATransaction</code>类来做管理，这个类有些奇怪，它没有属性或实例方法，并且也不能创建实例，但可以用类方法<code>begin()</code>或<code>commit()</code>分别来入栈或出栈。</p> <h3 id="使用-catransaction"><a href="#使用-catransaction" class="header-anchor">#</a> 使用 CATransaction</h3> <p><code>CATransaction</code>没有任何实例方法，只有类型方法。<code>CATransaction.begin()</code>和<code>CATransaction.commit()</code>构成了一个<strong>动画块</strong>：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">CATransaction</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">/* animation block */</span>
<span class="token builtin">CATransaction</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>在<strong>动画块</strong>中配置动画（譬如指定 duration）、设置 animated properties，如下是一个简单的应用示例（平移动画）：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">CATransaction</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">CATransaction</span><span class="token punctuation">.</span><span class="token function">setAnimationDuration</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token comment">// duration = 1.0</span>
targetLayer<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token function">CATransform3DMakeTranslation</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token builtin">CATransaction</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>除了<code>begin()</code>和<code>commit()</code>，<code>CATransaction</code>还有一些其他的类型方法：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function">animationDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">CFTimeInterval</span>  <span class="token comment">// get duration, defaults to 0.25s</span>
<span class="token keyword">func</span> <span class="token function">setAnimationDuration</span><span class="token punctuation">(</span>dur<span class="token punctuation">:</span> <span class="token builtin">CFTimeInterval</span><span class="token punctuation">)</span>  <span class="token comment">// set duration</span>

<span class="token keyword">func</span> <span class="token function">animationTimingFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">CAMediaTimingFunction</span><span class="token operator">?</span>  <span class="token comment">// get timing function</span>
<span class="token keyword">func</span> <span class="token function">setAnimationTimingFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">:</span> <span class="token builtin">CAMediaTimingFunction</span><span class="token operator">?</span><span class="token punctuation">)</span>  <span class="token comment">// set timing function</span>

<span class="token keyword">func</span> <span class="token function">disableActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Bool</span>  <span class="token comment">// get disable actions state</span>
<span class="token keyword">func</span> <span class="token function">setDisableActions</span><span class="token punctuation">(</span>flag<span class="token punctuation">:</span> <span class="token builtin">Bool</span><span class="token punctuation">)</span>  <span class="token comment">// set disable actions state</span>

<span class="token keyword">func</span> <span class="token function">completionBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span>  <span class="token comment">// get completion block</span>
<span class="token keyword">func</span> <span class="token function">setCompletionBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>  <span class="token comment">// set completion block</span>
</code></pre></div><p>共有 4 组可配置项：duration、timing function、disable actions、completion block。如上的 4 组 getters/setters 可以用如下两个类型方法代替：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function">valueForKey</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">AnyObject</span><span class="token operator">?</span>
<span class="token keyword">func</span> <span class="token function">setValue</span><span class="token punctuation">(</span>anObject<span class="token punctuation">:</span> <span class="token builtin">AnyObject</span><span class="token operator">?</span><span class="token punctuation">,</span> forKey key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token comment">// key的可选值共有4种：</span>
<span class="token comment">// 1. kCATransactionAnimationDuration, duration</span>
<span class="token comment">// 2. kCATransactionAnimationTimingFunction, timing function</span>
<span class="token comment">// 3. kCATransactionDisableActions, disable actions</span>
<span class="token comment">// 4. kCATransactionCompletionBlock, completion block</span>
</code></pre></div><p>需要注意的是：</p> <ul><li><code>CATransaction</code>没办法配置 delay、repeat count 等；</li> <li><code>CATransaction</code>动画块只能处理<code>CALayer</code>相关动画，无法正确处理<code>UIView</code>的动画，甚至<code>UIView#layer</code>（与<code>UIView</code>相关联的<code>CALayer</code>）也不行；</li></ul> <p>既然<code>CATransaction</code>只能处理<code>CALayer</code>相关动画，<code>UIView</code>的隐式动画怎么实现？</p> <p>对应<code>CATransaction.begin()</code>和<code>CATransaction.commit()</code>，<code>UIView</code>也有两个类型方法：<code>beginAnimations(_:context:)</code>和<code>UIView.commitAnimations()</code>。换句话说，这两个方法一前一后也构成了一个针对<code>UIView</code>的动画块：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">UIView</span><span class="token punctuation">.</span><span class="token function">beginAnimations</span><span class="token punctuation">(</span><span class="token constant">nil</span><span class="token punctuation">,</span> context<span class="token punctuation">:</span> <span class="token constant">nil</span><span class="token punctuation">)</span>
<span class="token comment">/* animation block */</span>
<span class="token builtin">UIView</span><span class="token punctuation">.</span><span class="token function">commitAnimations</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>可以通过<code>UIView.setAnimationDuration()</code>等方法对动画进行配置，值得一提的是，相对于<code>CATransaction.setXXX</code>，<code>UIView.setAnimationXXX</code>要更丰富一些，可以额外配置 delay、repeat count 等。</p> <p>在 iOS 4 中，苹果对<code>UIView</code>添加了一种基于 block 的动画方法，即<code>UIView.animateXXX</code>系列方法，在做一堆的属性动画时，这些方法在语法上会更加简单，但实质上它们都是在做同样的事情。</p> <h2 id="图层行为"><a href="#图层行为" class="header-anchor">#</a> 图层行为</h2> <p>这一部分着重解释<code>UIView#layer</code>动画为什么会在<code>CATransaction</code>动画块中失效。这一部分内容几乎拷贝自<a href="https://zsisme.gitbooks.io/ios-/content/chapter7/layer-actions.html" target="_blank" rel="noopener noreferrer">图层行为<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>先来做个试验，尝试直接对<code>UIView</code>关联的图层（<code>UIView#layer</code>）而不是一个单独的图层（<code>CALayer</code>）做动画：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> ViewController <span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> weak<span class="token punctuation">)</span> IBOutlet UIView <span class="token operator">*</span>layerView<span class="token punctuation">;</span>

<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> ViewController

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//set the color of our layerView backing layer directly</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>layerView<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor blueColor<span class="token punctuation">]</span><span class="token punctuation">.</span>CGColor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>IBAction<span class="token punctuation">)</span>changeColor
<span class="token punctuation">{</span>
    <span class="token comment">//begin a new transaction</span>
    <span class="token punctuation">[</span>CATransaction begin<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//set the animation duration to 1 second</span>
    <span class="token punctuation">[</span>CATransaction setAnimationDuration<span class="token punctuation">:</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//randomize the layer background color</span>
    CGFloat red <span class="token operator">=</span> <span class="token function">arc4random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>CGFloat<span class="token punctuation">)</span>INT_MAX<span class="token punctuation">;</span>
    CGFloat green <span class="token operator">=</span> <span class="token function">arc4random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>CGFloat<span class="token punctuation">)</span>INT_MAX<span class="token punctuation">;</span>
    CGFloat blue <span class="token operator">=</span> <span class="token function">arc4random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>CGFloat<span class="token punctuation">)</span>INT_MAX<span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>layerView<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor colorWithRed<span class="token punctuation">:</span>red green<span class="token punctuation">:</span>green blue<span class="token punctuation">:</span>blue alpha<span class="token punctuation">:</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>CGColor<span class="token punctuation">;</span>
    <span class="token comment">//commit the transaction</span>
    <span class="token punctuation">[</span>CATransaction commit<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行程序，你会发现当按下按钮，图层颜色瞬间切换到新的值，而不是之前平滑过渡的动画。发生了什么呢？隐式动画好像被<code>UIView</code>关联图层给禁用了。</p> <p>试想一下，如果<code>UIView</code>的属性都有动画特性的话，那么无论在什么时候修改它，我们都应该能注意到的。所以，如果说<code>UIKit</code>建立在 Core Animation（默认对所有东西都做动画）之上，那么隐式动画是如何被<code>UIKit</code>禁用掉呢？</p> <p>我们知道 Core Animation 通常对<code>CALayer</code>的所有属性（可动画的属性）做动画，但是<code>UIView</code>把它关联的图层的这个特性关闭了。为了更好说明这一点，我们需要知道隐式动画是如何实现的。</p> <p>我们把改变属性时 CALayer 自动应用的动画称作行为，当<code>CALayer</code>的属性被修改时候，它会调用<code>-actionForKey:</code>方法，传递属性的名称。剩下的操作都在<code>CALayer</code>的头文件中有详细的说明，实质上是如下几步：</p> <ul><li>图层首先检测它是否有委托，并且是否实现<code>CALayerDelegate</code>协议指定的<code>-actionForLayer:forKey:</code>方法。如果有，直接调用并返回结果。</li> <li>如果没有委托，或者委托没有实现<code>-actionForLayer:forKey:</code>方法，图层接着检查包含属性名称对应行为映射的 actions 字典。</li> <li>如果 actions 字典没有包含对应的属性，那么图层接着在它的 style 字典接着搜索属性名。</li> <li>最后，如果在 style 里面也找不到对应的行为，那么图层将会直接调用定义了每个属性的标准行为的<code>-defaultActionForKey:</code>方法。</li></ul> <p>所以一轮完整的搜索结束之后，<code>-actionForKey:</code>要么返回空（这种情况下将不会有动画发生），要么是<code>CAAction</code>协议对应的对象，最后<code>CALayer</code>拿这个结果去对先前和当前的值做动画。</p> <p>于是这就解释了<code>UIKit</code>是如何禁用隐式动画的：每个 UIView 对它关联的图层都扮演了一个委托，并且提供了<code>-actionForLayer:forKey:</code>的实现方法。当不在一个动画块的实现中，<code>UIView</code>对所有图层行为返回<code>nil</code>，但是在动画 block 范围之内，它就返回了一个非空值。我们可以用一个 demo 做个简单的实验：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> ViewController <span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> weak<span class="token punctuation">)</span> IBOutlet UIView <span class="token operator">*</span>layerView<span class="token punctuation">;</span>

<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> ViewController

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//test layer action when outside of animation block</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;Outside: %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>layerView actionForLayer<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>layerView<span class="token punctuation">.</span>layer forKey<span class="token punctuation">:</span><span class="token string">@&quot;backgroundColor&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//begin animation block</span>
    <span class="token punctuation">[</span>UIView beginAnimations<span class="token punctuation">:</span>nil context<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//test layer action when inside of animation block</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;Inside: %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>layerView actionForLayer<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>layerView<span class="token punctuation">.</span>layer forKey<span class="token punctuation">:</span><span class="token string">@&quot;backgroundColor&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//end animation block</span>
    <span class="token punctuation">[</span>UIView commitAnimations<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>
</code></pre></div><p>运行程序，控制台显示结果如下：</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase">$ LayerTest[21215:c07] Outside: </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>null</span><span class="token punctuation">&gt;</span></span>
<span class="token phrase">$ LayerTest[21215:c07] Inside: &lt;CABasicAnimation: 0x757f090&gt;
</span></code></pre></div><p>于是我们可以预言，当属性在动画块之外发生改变，<code>UIView</code>直接通过返回<code>nil</code>来禁用隐式动画。但如果在动画块范围之内，根据动画具体类型返回相应的属性，在这个例子就是<code>CABasicAnimation</code>。</p> <p>当然返回<code>nil</code>并不是禁用隐式动画唯一的办法，<code>CATransacition</code>有个方法叫做<code>+setDisableActions:</code>，可以用来对所有属性打开或者关闭隐式动画。</p> <p>总结一下，我们知道了如下几点：</p> <ul><li><code>UIView</code>关联的图层禁用了隐式动画，对这种图层做动画的唯一办法就是使用<code>UIView</code>的动画函数（而不是依赖<code>CATransaction</code>），或者继承<code>UIView</code>，并覆盖<code>-actionForLayer:forKey:</code>方法，或者直接创建一个显式动画。</li> <li>对于单独存在的图层，我们可以通过实现图层的<code>-actionForLayer:forKey:</code>委托方法，或者提供一个 actions 字典来控制隐式动画。</li></ul> <p>如上文所述，<code>UIView</code>和<code>CALayer</code>处理隐式动画的逻辑不一样，那么如何同时实现它们俩的动画呢？这个问题并不复杂，懒得叙述了，直接参考：</p> <ul><li><a href="http://stackoverflow.com/questions/10801414/how-to-synchronously-animate-a-uiview-and-a-calayer" target="_blank" rel="noopener noreferrer">How to synchronously animate a UIView and a CALayer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://khanlou.com/2012/10/mixing-uiview-and-calayer-animations/" target="_blank" rel="noopener noreferrer">Mixing UIView and CALayer animations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.apple.com/library/ios/documentation/WindowsViews/Conceptual/ViewPG_iPhoneOS/AnimatingViews/AnimatingViews.html#//apple_ref/doc/uid/TP40009503-CH6-SW12" target="_blank" rel="noopener noreferrer">Animating View and Layer Changes Together<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="uiview-animatexxx-汇总"><a href="#uiview-animatexxx-汇总" class="header-anchor">#</a> UIView.animateXXX 汇总</h2> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function">animateWithDuration</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                         animations<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span>
                         
<span class="token keyword">func</span> <span class="token function">animateWithDuration</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                         animations<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">,</span>
                         completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">animateWithDuration</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                         delay<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                         options<span class="token punctuation">:</span> <span class="token builtin">UIViewAnimationOptions</span><span class="token punctuation">,</span>
                         animations<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">,</span>
                         completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">animateWithDuration</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                         delay<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                         usingSpringWithDamping dampingRatio<span class="token punctuation">:</span> <span class="token builtin">CGFloat</span><span class="token punctuation">,</span>
                         initialSpringVelocity velocity<span class="token punctuation">:</span> <span class="token builtin">CGFloat</span><span class="token punctuation">,</span>
                         options<span class="token punctuation">:</span> <span class="token builtin">UIViewAnimationOptions</span><span class="token punctuation">,</span>
                         animations<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">,</span>
                         completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">transitionWithView</span><span class="token punctuation">(</span>view<span class="token punctuation">:</span> <span class="token builtin">UIView</span><span class="token punctuation">,</span>
                        duration<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                        options<span class="token punctuation">:</span> <span class="token builtin">UIViewAnimationOptions</span><span class="token punctuation">,</span>
                        animations<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
                        completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">transitionFromView</span><span class="token punctuation">(</span>fromView<span class="token punctuation">:</span> <span class="token builtin">UIView</span><span class="token punctuation">,</span>
                        toView<span class="token punctuation">:</span> <span class="token builtin">UIView</span><span class="token punctuation">,</span>
                        duration<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                        options<span class="token punctuation">:</span> <span class="token builtin">UIViewAnimationOptions</span><span class="token punctuation">,</span>
                        completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">performSystemAnimation</span><span class="token punctuation">(</span>animation<span class="token punctuation">:</span> <span class="token builtin">UISystemAnimation</span><span class="token punctuation">,</span>
                            onViews views<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">UIView</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            options<span class="token punctuation">:</span> <span class="token builtin">UIViewAnimationOptions</span><span class="token punctuation">,</span>
                            animations parallelAnimations<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
                            completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">/* 关键帧动画 */</span>
<span class="token keyword">func</span> <span class="token function">animateKeyframesWithDuration</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                                  delay<span class="token punctuation">:</span> <span class="token builtin">NSTimeInterval</span><span class="token punctuation">,</span>
                                  options<span class="token punctuation">:</span> <span class="token builtin">UIViewKeyframeAnimationOptions</span><span class="token punctuation">,</span>
                                  animations<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">,</span>
                                  completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">addKeyframeWithRelativeStartTime</span><span class="token punctuation">(</span>frameStartTime<span class="token punctuation">:</span> <span class="token builtin">Double</span><span class="token punctuation">,</span>
                                      relativeDuration frameDuration<span class="token punctuation">:</span> <span class="token builtin">Double</span><span class="token punctuation">,</span>
                                      animations<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span>
</code></pre></div><p>如上这些 API 能够做到的事情，使用 Core Animation 的显式动画（基于<code>CAAnimation</code>）都能做到。</p></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/74.b4028d07.js" defer></script>
  </body>
</html>
