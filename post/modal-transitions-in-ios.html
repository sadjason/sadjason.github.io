<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Modal Transition | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/84.f2aff9f4.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">Modal Transition</div> <div class="post-info">2016-06-09 • iOS</div></div> <div class="content content__default"><p>本文旨在分析 modal transition 自定义过场动画的实现过程，总结一些基本套路。</p> <p>视图控制器的转场动画涉及几大组件：</p> <ol><li><strong>转场上下文</strong>（transition context）</li> <li><strong>转场代理</strong>（transitioning delegation）</li> <li><strong>动画控制器</strong>（animation controller）</li> <li><strong>交互控制器</strong>（interaction controller）</li> <li><strong>转场协调器</strong>（transition coordination）</li> <li><strong>呈现控制器</strong>（presentation controller）</li></ol> <p>其中前 5 个是 iOS 7 中引入的，都以<strong>协议</strong>的形式定义，利用这 5 个接口可以实现丰富转场动画（不光是 modal transition），详细内容参考<a href="/viewcontroller-transitions-basics/">iOS 转场动画概述</a>；第 6 个是 Apple 在 iOS 8 中引入的，以类（<code>UIPresentationController</code>）的形式定义，在 modal transition 中可能会用到。</p> <p>下文若涉及如上这些概念，均以对应的英文代指。</p> <p>在 iOS 中，modal transition 涉及两个控制器：presenting view controller 和 presented view controller。transition 结束后，后者盖在前者上面。</p> <p>过场动画说到底是对 view 的动画处理，根据我的分析，相关的 view 包括：key window、presenting controller's view、container view、presented controller's view，完成 transition 后，它们的层次结构如下：</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase"><span class="token table"><span class="token punctuation">|</span>--key window
   <span class="token punctuation">|</span>--presenting controller's view
   <span class="token punctuation">|</span>--container view
      <span class="token punctuation">|</span></span>--presented controller's view</span>

<span class="token phrase"><span class="token list"><span class="token punctuation">#</span> 说明：</span>
<span class="token list"><span class="token punctuation">#</span> a. 此处presenting view controller是keyWindow的rootViewController；</span>
<span class="token list"><span class="token punctuation">#</span> b. container view并不一定是presented controller's view的super view，但一定是它的ancestor view；</span>
</span></code></pre></div><p>为叙述简单起见，下文中的<strong>presented view</strong>等价于上述的<strong>presented controller's view</strong>，<strong>presenting view</strong>则等价于<strong>presenting controller's view</strong>。</p> <p>如上的层次结构是我通过阅读文档和测试得出的结论，可以看出，presenting view 和 presented view 并没有包含关系。container view 是什么呢？在 transition 过程中，系统先创建一个临时的 view，把它纳入到 key window 的层次结构中，然后将 presented view 加入到 container view 中。</p> <p>对于 modal transition，一般来说，container view 是系统产生的。</p> <blockquote><p>P.S: 根据我的认知，貌似只有在自定义容器控制器时，才需要指定 container view。</p></blockquote> <h2 id="简单的自定义-modal-过场动画"><a href="#简单的自定义-modal-过场动画" class="header-anchor">#</a> 简单的自定义 Modal 过场动画</h2> <p>把相关的 view 层次关系理清，实现简单的自定义过场动画就不难了，先来一个最简单的：presented view 渐进显示（alpha 从 0.0 到 1.0），效果如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/simple-modal-transition-demo1.gif" alt="Simple Modal Transition Demo" srcset="/image/simple-modal-transition-demo1.gif 2x" data-v-339c7bd5></div> <p>上述 demo 中涉及两个 view controller，本文将它们对应的类命名为：PresentingViewController 和 PresentedViewController。</p> <p>从 PresentingViewController 过渡到 PresentedViewController 非常容易，一行代码解决：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token function">presentViewController</span><span class="token punctuation">(</span><span class="token function">PresentedViewController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> animated<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>默认情况下，PresentedViewController 会从底部升起，现在想让它执行自定义动画（alpha 从 0.0 到 1.0），需要对 PresentedViewController 稍作处理，首先是设置其 modal style 为 Custom，并指定其过场动画的代理：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">PresentedViewController</span><span class="token punctuation">:</span> <span class="token builtin">UIViewController</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> presenter<span class="token punctuation">:</span> <span class="token builtin">UIViewControllerTransitioningDelegate</span><span class="token operator">?</span>
  <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>nibName<span class="token punctuation">:</span> <span class="token constant">nil</span><span class="token punctuation">,</span> bundle<span class="token punctuation">:</span> <span class="token constant">nil</span><span class="token punctuation">)</span>
    <span class="token function">commonSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">required</span> <span class="token keyword">init</span><span class="token operator">?</span><span class="token punctuation">(</span>coder aDecoder<span class="token punctuation">:</span> <span class="token builtin">NSCoder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>coder<span class="token punctuation">:</span> aDecoder<span class="token punctuation">)</span>
    <span class="token function">commonSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">commonSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    modalPresentationStyle <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token builtin">Custom</span>
    presenter <span class="token operator">=</span> <span class="token function">SimpleModalPresenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    transitioningDelegate <span class="token operator">=</span> presenter
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>modalPresentationStyle=.Custom</code>告诉系统自定义过场处理，而<code>transitioningDelegate</code>属性指定 transitioning delegation，值得一提的是，<code>transitioningDelegate</code>属性被<code>weak</code>修饰，不强持有所指向的资源，故而<code>commonSetup()</code>不能写成如下这样（曾在这里栽过跟头）：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">commonSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  modalPresentationStyle <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token builtin">Custom</span>
  transitioningDelegate <span class="token operator">=</span> <span class="token function">SimpleModalPresenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>目前为止（当前最新版本为 iOS 9），transitioning delegation 有 5 个可选回调，作用有三个：</p> <ul><li>提供 animation controllers（遵循<code>UIViewControllerAnimatedTransitioning</code>协议的对象）；</li> <li>提供 interaction controllers（遵循<code>UIViewControllerInteractiveTransitioning</code>协议的对象）；</li> <li>提供 presentation controller（<code>UIPresentationController</code>对象）；</li></ul> <p><code>SimpleModalPresenter</code>的实现非常简单，实现两个回调，分别为 presentation transition 和 dismissal transition 提供 animation controller（暂时不考虑交互，因此略过 interaction controller，<code>UIPresentationController</code>下文会提到）：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">SimpleModalPresenter</span><span class="token punctuation">:</span> <span class="token builtin">NSObject</span><span class="token punctuation">,</span> <span class="token builtin">UIViewControllerTransitioningDelegate</span> <span class="token punctuation">{</span>
  
  <span class="token comment">// 非交互动画</span>
  <span class="token keyword">func</span> <span class="token function">animationControllerForPresentedController</span><span class="token punctuation">(</span>presented<span class="token punctuation">:</span> <span class="token builtin">UIViewController</span><span class="token punctuation">,</span> presentingController presenting<span class="token punctuation">:</span> <span class="token builtin">UIViewController</span><span class="token punctuation">,</span> sourceController source<span class="token punctuation">:</span> <span class="token builtin">UIViewController</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">UIViewControllerAnimatedTransitioning</span><span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> animator <span class="token operator">=</span> <span class="token function">SimpleModalAnimator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    animator<span class="token punctuation">.</span>isPresentation <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span> animator
  <span class="token punctuation">}</span>
  
  <span class="token keyword">func</span> <span class="token function">animationControllerForDismissedController</span><span class="token punctuation">(</span>dismissed<span class="token punctuation">:</span> <span class="token builtin">UIViewController</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">UIViewControllerAnimatedTransitioning</span><span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> animator <span class="token operator">=</span> <span class="token function">SimpleModalAnimator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    animator<span class="token punctuation">.</span>isPresentation <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">return</span> animator
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Animation controller 的实现也非常简单，无非是利用系统提供 transition context 信息进行简单的动画处理：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">SimpleModalAnimator</span><span class="token punctuation">:</span> <span class="token builtin">NSObject</span><span class="token punctuation">,</span> <span class="token builtin">UIViewControllerAnimatedTransitioning</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> isPresentation<span class="token punctuation">:</span> <span class="token builtin">Bool</span> <span class="token operator">=</span> <span class="token boolean">false</span>
  
  <span class="token comment">// 定义过场动画时间，其他地方可能会用到这个</span>
  <span class="token keyword">func</span> <span class="token function">transitionDuration</span><span class="token punctuation">(</span>transitionContext<span class="token punctuation">:</span> <span class="token builtin">UIViewControllerContextTransitioning</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">NSTimeInterval</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1.0</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 过场动画的具体执行</span>
  <span class="token keyword">func</span> <span class="token function">animateTransition</span><span class="token punctuation">(</span>transitionContext<span class="token punctuation">:</span> <span class="token builtin">UIViewControllerContextTransitioning</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> containerView <span class="token operator">=</span> transitionContext<span class="token punctuation">.</span><span class="token function">containerView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">let</span> presentedView<span class="token punctuation">:</span> <span class="token builtin">UIView</span><span class="token operator">?</span>
    <span class="token keyword">if</span> isPresentation <span class="token punctuation">{</span>
      presentedView <span class="token operator">=</span> transitionContext<span class="token punctuation">.</span><span class="token function">viewForKey</span><span class="token punctuation">(</span><span class="token builtin">UITransitionContextToViewKey</span><span class="token punctuation">)</span>
      presentedView<span class="token operator">?</span><span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token punctuation">(</span>containerView<span class="token operator">?</span><span class="token punctuation">.</span>bounds<span class="token punctuation">)</span><span class="token operator">!</span>
      presentedView<span class="token operator">?</span><span class="token punctuation">.</span>alpha <span class="token operator">=</span> <span class="token number">0.0</span>
      containerView<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>presentedView<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      presentedView <span class="token operator">=</span> transitionContext<span class="token punctuation">.</span><span class="token function">viewForKey</span><span class="token punctuation">(</span><span class="token builtin">UITransitionContextFromViewKey</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token builtin">UIView</span><span class="token punctuation">.</span><span class="token function">animateWithDuration</span><span class="token punctuation">(</span><span class="token function">transitionDuration</span><span class="token punctuation">(</span>transitionContext<span class="token punctuation">)</span><span class="token punctuation">,</span> animations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      presentedView<span class="token operator">?</span><span class="token punctuation">.</span>alpha <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>isPresentation <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> <span class="token number">0.0</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>finished<span class="token punctuation">)</span> <span class="token keyword">in</span>
        transitionContext<span class="token punctuation">.</span><span class="token function">completeTransition</span><span class="token punctuation">(</span>finished<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>isPresentation <span class="token punctuation">{</span>
          presentedView<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">removeFromSuperview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>SimpleModalAnimator</code>将 presentation 和 dismissal 二合一，定义<code>isPresentation</code>属性以便区分。</p> <p>综上，实现简单的 modal transition 只需要三个步骤：</p> <ol><li>在 presented view controller 中指定 modal style 和 transition delegate；</li> <li>实现 transition delegate，即定义遵循<code>UIViewControllerTransitioningDelegate</code>协议的类，transition delegate 为 presented view controller 提供 animation controllers；</li> <li>实现 animation controllers，即定义遵循<code>UIViewControllerAnimatedTransitioning</code>协议的类，animation controller 利用系统所提供的 transition context 信息，处理一些简单的 view animation。</li></ol> <h2 id="uipresentationcontroller"><a href="#uipresentationcontroller" class="header-anchor">#</a> UIPresentationController</h2> <p>Presentation controller 是 iOS 8 引入的新概念，能够帮助我们更方便快捷地实现 view controller 的自定义过渡效果，与 animation controller 等不同，它不是以协议的方式定义，而是定义了一个名为<code>UIPresentationController</code>的类。</p> <blockquote><p>P.S: 很好奇为什么不把 presentation controller 也定义成 protocol。</p></blockquote> <p>简单来说，presentation controller 和 animation controller 有些类似，它们都不是视图控制器，没有<code>view</code>属性，都拥有 container view、presented view 等访问权，都由 transitioning delegation 提供；presentation controller 的主要使命是提供一些回调，系统在 presentation transition 的开始/结束、dismissal transition 的开始/结束会调用这些回调，有点类似视图控制器的<code>viewWillAppear(_:)</code>、<code>viewDidAppear(_:)</code>，常用的回调如下：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">// presentation transition</span>
<span class="token keyword">func</span> <span class="token function">presentationTransitionWillBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">presentationTransitionDidEnd</span><span class="token punctuation">(</span>completed<span class="token punctuation">:</span> <span class="token builtin">Bool</span><span class="token punctuation">)</span>
<span class="token comment">// dismissal transition</span>
<span class="token keyword">func</span> <span class="token function">dismissalTransitionWillBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">dismissalTransitionDidEnd</span><span class="token punctuation">(</span>completed<span class="token punctuation">:</span> <span class="token builtin">Bool</span><span class="token punctuation">)</span>

<span class="token comment">/* Position of the presented view in the container view 
 * by the end of the presentation transition.
 * (Default: container view bounds)
 */</span>
<span class="token keyword">func</span> <span class="token function">frameOfPresentedViewInContainerView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">CGRect</span>

<span class="token comment">/* Indicate whether the view controller's view we are transitioning from 
 * will be removed from the window in the end of the presentation transition
 * (Default: NO)
 */</span>
<span class="token keyword">func</span> <span class="token function">shouldRemovePresentersView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Bool</span>
</code></pre></div><p>可以看到，相较于 animation controller，presentation controller 所涉及的过场讯息更加精细。</p> <blockquote><p>Note: <code>UIPresentationController</code>实例的初始化不能使用<code>init()</code>，必须要使用<code>init(presentedViewController:presentingViewController:)</code>。</p></blockquote> <p>刚开始接触 presentation controller 时有些疑点：</p> <ul><li>Presentation controller 一定要配合 animation controller 使用？可以单独使用吗？</li> <li>Presentation controller 和 animation controller 都可以访问 container view 和 presented view，都能处理过场动画，如何让它们俩协调工作？</li></ul> <p>首先，presentation controller 是可以单独使用的！也就是说，transitioning delegation 可以只提供 presentation controller，而不提供 animation controller，如下这样：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">// 转场代理只提供presentation controller</span>
<span class="token keyword">class</span> <span class="token class-name">SimpleModalPresenter</span><span class="token punctuation">:</span> <span class="token builtin">NSObject</span><span class="token punctuation">,</span> <span class="token builtin">UIViewControllerTransitioningDelegate</span> <span class="token punctuation">{</span>

  <span class="token keyword">func</span> <span class="token function">presentationControllerForPresentedViewController</span><span class="token punctuation">(</span>presented<span class="token punctuation">:</span> <span class="token builtin">UIViewController</span><span class="token punctuation">,</span> presentingViewController presenting<span class="token punctuation">:</span> <span class="token builtin">UIViewController</span><span class="token punctuation">,</span> sourceViewController source<span class="token punctuation">:</span> <span class="token builtin">UIViewController</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">UIPresentationController</span><span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">SimplePresentationController</span><span class="token punctuation">(</span>presentedViewController<span class="token punctuation">:</span> presented<span class="token punctuation">,</span> presentingViewController<span class="token punctuation">:</span> presenting<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>StackOverFlow 中有一个简单的<a href="http://stackoverflow.com/questions/29219688/present-modal-view-controller-in-half-size-parent-controller/29220983#29220983" target="_blank" rel="noopener noreferrer">用例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：让 presented view 占据屏幕的下半部分，而不是全屏。重载自定义 presentation controller 的<code>frameOfPresentedViewInContainerView() -&gt; CGRect</code>方法即可实现。</p> <blockquote><p>Note: 当 transitioning delegation 同时提供自定义的 animation controller 和 presentation controller 时，presentation controller 的<code>frameOfPresentedViewInContainerView() -&gt; CGRect</code>方法不管用了，不晓得什么原因，非常诡异！除了这种方式，还可以在 animation controller 的<code>animateTransition(_:)</code>设置 presented view 的<code>frame</code>。</p></blockquote> <p>然后来分析 presentation controller 和 animation controller 如何协同工作。</p> <p>如上文所述，二者拥有对 presented view 和 container view 的访问权...在我看来，它们所能做的事情有些重叠，modal 呈现 presented view controller 的一个重要步骤是<code>containerView.addSubview(presentedView)</code>，这行代码在哪里执行呢？可以在 animation controller 的<code>animateTransition(_:)</code>方法中处理，也可以在 presentation controller 的回调<code>presentationTransitionWillBegin()</code>中处理。此外，presentation controller 的很多用法是在 container view 和 presented view 中加入一层 view（充当遮罩或者蒙板），比如<a href="http://www.cocoachina.com/industry/20140707/9053.html" target="_blank" rel="noopener noreferrer">这样<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>；这种事情显然也可以在 animation controller 的<code>animateTransition(_:)</code>方法中完成。</p> <p>总之，在我看来，presentation controller 不是必要的，它所能做的事情，animation controller 的<code>animateTransition(_:)</code>都能做，只是 presentation controller 把工作给简化了一些。</p> <blockquote><p>Note: 把 presentation controller 看作是 animation controller 和 interaction controller 的扩展。</p></blockquote> <p>个人感觉，presentation controller 虽然简化了自定义 modal transition 的实现，但是让逻辑更复杂了，甚至更混乱了。</p> <p>因此，有必要将 presentation controller 和 animation controller 的工作给分清楚。我是这么想的：presented view 相关的设置与动画处理都放在 animation controller 中完成，而 presentation view（一般是夹在 container view 和 presented view 之间的临时 view）相关设置和处理都放在 presentation controller 中处理。</p> <p>在 presentation transition 和 dismissal transition 过程中，animation controller 的<code>animateTransition(_:)</code>和 presentation controller 的几个回调的执行顺序是：</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase"><span class="token list"><span class="token punctuation">#</span> presentation transition</span>
presentationTransitionWillBegin()
animateTransition(_:)
presentationTransitionDidEnd(_:)</span>

<span class="token phrase"><span class="token list"><span class="token punctuation">#</span> dismissal transition</span>
dismissalTransitionWillBegin()
animateTransition(_:)
dismissalTransitionDidEnd(_:)
</span></code></pre></div><h2 id="presentation-style"><a href="#presentation-style" class="header-anchor">#</a> Presentation Style</h2> <p><code>UIViewController</code>有个属性<code>modalPresentationStyle</code>，上文中用到了该属性，只是用得稀里糊涂，这一部分对它进行进一步说明。</p> <p>Apple 文档对<code>modalPresentationStyle</code>属性的解释如下：</p> <blockquote><p>The presentation style determines how a modally presented view controller is displayed onscreen. In a horizontally compact environment, modal view controllers are always presented full-screen. In a horizontally regular environment, there are several different presentation options. For a list of possible presentation styles, and their compatibility with the available transition styles, see the <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIViewController_Class/#//apple_ref/c/tdef/UIModalPresentationStyle" target="_blank" rel="noopener noreferrer">UIModalPresentationStyle<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> constant descriptions.</p></blockquote> <p>该属性是个枚举值，包括 9 个 case，其中大多数都与 iPad 环境有关，这里只介绍 iPhone 开发环境中会常常涉及到的 3 个枚举值：</p> <ul><li><code>.FullScreen</code> -- A presentation style in which the presented view covers the screen. The views belonging to the presenting view controller are removed after the presentation completes.</li> <li><code>.OverFullScreen</code> -- A view presentation style in which the presented view covers the screen. The views beneath the presented content are not removed from the view hierarchy when the presentation finishes. So if the presented view controller does not fill the screen with opaque content, the underlying content shows through.</li> <li><code>.Custom</code> -- A custom view presentation style that is managed by a custom presentation controller and one or more custom animator objects. All of these objects are provided by the presented view controller’s transitioning delegate.</li></ul> <p>简单来说，当<code>modalPresentationStyle</code>属性赋值<code>.FullScreen</code>或者<code>.OverFullScreen</code>时，transitioning delegation 提供的自定义 presentation controller 就没什么卵用。换句话说，如果想使用自定义的 presentation controller，必须对<code>modalPresentationStyle</code>属性赋值<code>.Custom</code>。</p> <p>它们仨有啥不同呢？</p> <p><code>.FullScreen</code>所对应的内置 presentation controller，会在 presentation transition 结束时，将 presenting view 从 key window 的 view hierarchy 中移除掉。</p> <p>而<code>.OverFullScreen</code>所对应的内置 presentation controller，则不会在 presentation transition 结束时移除掉 presenting view。</p> <p>在<code>.Custom</code>模式下，不会使用任何一种系统内置 presentation controller，它依赖于用户自定义 presentation controller，即实现一个<code>UIPresentationController</code>子类，该子类有一个<code>shouldRemovePresentersView() -&gt; Bool</code>方法。单从对待 presenting view 的角度来看，当该方法返回<code>false</code>时，<code>.Custom</code>与<code>.OverFullScreen</code>一致，反之，当该方法返回<code>true</code>时，<code>.Custom</code>与<code>.FullScreen</code>一致。</p> <p>我为什么会关注<code>modalPresentationStyle</code>属性呢？</p> <p>这是因为我在 animation controller 的<code>animateTransition(_:)</code>方法中无法访问 presenting view，如下：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function">animateTransition</span><span class="token punctuation">(</span>transitionContext<span class="token punctuation">:</span> <span class="token builtin">UIViewControllerContextTransitioning</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">let</span> presentingView <span class="token operator">=</span> transitionContext<span class="token punctuation">.</span><span class="token function">viewForKey</span><span class="token punctuation">(</span><span class="token builtin">UITransitionContextFromViewKey</span><span class="token punctuation">)</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>查了半天资料，发现这个<a href="http://stackoverflow.com/questions/24338700/from-view-controller-disappears-using-uiviewcontrollercontexttransitioning/25901154#25901154" target="_blank" rel="noopener noreferrer">说法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>比较靠谱。大概的意思是：</p> <ul><li>如果在 presentation transition 结束时仍然将 presenting view 保留到 key window 中，iOS（iOS 8 及以后版本）认为没有必要让你再操控 presenting view，故而通过<code>viewForKey(UITransitionContextFromViewKey)</code>访问 presenting view 得到的结果为<code>nil</code>；</li> <li>如果在 presentation transition 结束时将 presenting view 从 key window 中移除掉，iOS 认为你可能需要在 presentation transition 过程中对 presenting view 做一个动画，故而通过<code>viewForKey(UITransitionContextFromViewKey)</code>能够访问到 presenting view。</li></ul> <p>UIKit 的 UIViewControllerTransitioning.h 文件中也有对这种说法的佐证：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">// Currently only two keys are defined by the system -</span>
<span class="token comment">// UITransitionContextFromViewKey, and UITransitionContextToViewKey</span>
<span class="token comment">// viewForKey: may return nil which would indicate that the animator should not</span>
<span class="token comment">// manipulate the associated view controller's view.</span>
@<span class="token function">available</span><span class="token punctuation">(</span>iOS <span class="token number">8.0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function">viewForKey</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">UIView</span><span class="token operator">?</span>
</code></pre></div><p>对于这种做法，我的下意识是：What The Fuck!</p> <p>当然，如果非要访问 presenting view，除了通过<code>viewForKey(_:)</code>，还可以曲线救国：先通过<code>viewControllerForKey(_:)</code>访问 presenting view controller，然后再访问 view。</p> <h2 id="本文参考"><a href="#本文参考" class="header-anchor">#</a> 本文参考</h2> <ul><li><a href="http://www.cocoachina.com/industry/20140707/9053.html" target="_blank" rel="noopener noreferrer">iOS 8 的 PresentationController<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIPresentationController_class/" target="_blank" rel="noopener noreferrer">UIPresentationController Class Reference<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.apple.com/library/prerelease/content/featuredarticles/ViewControllerPGforiPhoneOS/CustomizingtheTransitionAnimations.html" target="_blank" rel="noopener noreferrer">Customizing the Transition Animations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/84.f2aff9f4.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
