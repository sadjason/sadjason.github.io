<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NSObject 的消息转发机制 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/81.bc82bd01.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">NSObject 的消息转发机制</div> <div class="post-info">2017-10-12 • iOS</div></div> <div class="content content__default"><p>15 年，刚开始接触 runtime 的时候，记录过消息转发相关的博客，最近做需求涉及到了一些消息转发相关的内容，得闲将旧博客翻出来重新梳理了一下。</p> <p>为什么标题含有「NSObject」关键字眼呢？因为本文叙述的消息转发机制是针对<code>NSObject</code>对象；在我看来，Objective-C 世界里的另一个根类<code>NSProxy</code>的消息转发逻辑和<code>NSObject</code>完全不同。</p> <p>P.S: 如果没有特别说明，本文的<code>NSObject</code>指的是<code>class NSObject</code>，而不是<code>protocol NSObject</code>。</p> <p>如下这张取自《Effective Objective-C 2.0》的图片描述了<code>NSObject</code>对象的消息转发全流程：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/QQ20150427-1.png" srcset="/image/QQ20150427-1.png 2x" data-v-339c7bd5></div> <p>简单来说，当一个 OC 对象（receiver）接收到 Unknown selector 时，会进入如图流程，用户可以在这三个步骤中 override receiver 的相关方法，进而避免<code>doesNotRecognizeSelector:</code>异常。</p> <p>这三次处理时机有何区别呢？《Effective Objective-C 2.0》的描述是：</p> <blockquote><p>步骤越往后，处理消息的代价就越大；最好能在第一步就处理完，这样的话，runtime 系统就可以将此方法缓存起来，进而提高效率。若想在第三步里把消息转发给备援的 receiver，那还不如把转发操作提前到第二步。因为第三步只是修改了调用目标，这项改动放在第二步会更为简单，不然的话，还得创建并处理完整的<code>NSInvocation</code>。</p></blockquote> <p>本文旨在梳理这三个步骤。</p> <h2 id="resolveinstancemethod"><a href="#resolveinstancemethod" class="header-anchor">#</a> +resolveInstanceMethod</h2> <p>Receiver 在收到 unknown selector 后，首先将调用其本类的<code>resolveInstanceMethod:</code>方法，该方法定义如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>resolveInstanceMethod<span class="token punctuation">:</span><span class="token punctuation">(</span>SEL<span class="token punctuation">)</span>sel<span class="token punctuation">;</span>
</code></pre></div><p>该方法的参数就是那个 unknown selector，其返回值为<code>Boolean</code>类型，表示这个类是否能新增一个实例方法用以处理该 unknown selector。在继续往下执行转发机制之前，本类有机会新增一个处理此 selector 的方法。所以<code>resolveInstanceMethod:</code>的一般使用套路是：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>resolveInstanceMethod<span class="token punctuation">:</span><span class="token punctuation">(</span>SEL<span class="token punctuation">)</span>aSelector <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* aSelector满足某个条件  */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
         调用class_addMethod为该类添加一个处理aSelector的方法，譬如：
         class_addMethod(self, aSelector, aImp, @&quot;v@:@&quot;);
         */</span>
        <span class="token keyword">return</span> YES<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">super</span> resolveInstanceMethod<span class="token punctuation">:</span>aSelector<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>假如尚未实现的方法不是实例方法而是类方法，那么 runtime 系统会调用另外一个与<code>resolveInstanceMethod:</code>类似的方法<code>resolveClassMethod:</code>。</p> <p>就我经验而言，<code>resolveInstanceMethod:</code>的使用场景一般用来动态添加 setter 和 getter。</p> <h2 id="forwardingtargetforselector"><a href="#forwardingtargetforselector" class="header-anchor">#</a> -forwardingTargetForSelector</h2> <p>当前 receiver 还有第二次机会能处理 unknown selector，在这一步中，runtime 系统会问它：可否把这条消息转给其他对象处理？该步骤对应的处理方法是<code>forwardingTargetForSelector:</code>，定义于<code>&lt;objc/NSObject.h&gt;</code>中：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>forwardingTargetForSelector<span class="token punctuation">:</span><span class="token punctuation">(</span>SEL<span class="token punctuation">)</span>aSelector<span class="token punctuation">;</span>
</code></pre></div><p>若当前 receiver 能找到备援对象，则将其返回，当然，备援对象必须能够响应 aSelector，否则依然会抛出<code>doesNotRecognizeSelector:</code>异常；若找不到，则返回<code>nil</code>。</p> <p><code>-forwardingTargetForSelector:</code>的使用逻辑非常简单，应用场景包括：</p> <ul><li>实现多继承。Objective-C 不允许多继承，基于<code>-forwardingTargetForSelector:</code>，可以通过组合的方式，模拟出多继承的某些特性。</li> <li>为协议遵循者提供默认实现。譬如某个协议定义了多个方法，有必要为这几个方法提供默认实现；具体做法是定义一个类（假设为 Implement），用于实现这几个方法，然后 override 协议遵循者的<code>-forwardingTargetForSelector:</code>方法，将协议方法的 receiver 定位到 Implement 对象。</li></ul> <h2 id="forwardinvocation"><a href="#forwardinvocation" class="header-anchor">#</a> -forwardInvocation</h2> <p><code>-forwardInvocation:</code>要和<code>-methodSignatureForSelector:</code>配套使用，后者为<code>NSMethodSignature</code>对象，该对象携带 selector 的签名信息，包括参数类型、返回值类型和长度等。Runtime 内部会基于<code>NSMethodSignature</code>实例构建一个<code>NSInvocation</code>对象，作为回调<code>-forwardInvocation:</code>的入参。</p> <p>P.S: 知道<code>NSMethodSignature</code>对象携带 selector 的签名信息一般就够了，彻底了解它还得搞清楚 type encodings，这东西挺没劲的，很少会和它打交道，更多信息参考<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="http://nshipster.com/type-encodings/" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>只要回调<code>-methodSignatureForSelector:</code>的返回值不为空，就会进入<code>-forwardInvocation:</code>方法，用户可以在此过程中修改 invocation 的 target，将 receiver 定位到别处：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>forwardInvocation<span class="token punctuation">:</span><span class="token punctuation">(</span>NSInvocation <span class="token operator">*</span><span class="token punctuation">)</span>invocation <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>invocation setTarget<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>target<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 让self.target成为消息的receiver</span>
    <span class="token punctuation">[</span>invocation invoke<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>值得一提的是，除了修改 receiver，还可以修改入参，甚至是返回值。<code>NSInvocation#invoke</code>会触发 receiver 的 selector 的调用，如果不想调用怎么办？没怎么办，只要确保 invocation 的返回值（<code>NSInvocation#setReturnValue:</code>）的类型和长度一致即可。</p> <p>Unknown selector 触发的三个回调介绍完毕，简单总结一下。</p> <p>就作用而言，<code>+resolveInstanceMethod:</code>主要用于为类动态增加实例方法；<code>-forwardingTargetForSelector:</code>用于将 selector 的 receiver 从<code>self</code>定位到别的 target；这两个方法的使用都比较直接简单，不太能整出花样。<code>-forwardInvocation:</code>就不同了，在它身上可以动的手脚比较多，不光可以修改 receiver，还可以篡改入参、返回值；当然，<code>-forwardInvocation:</code>的代价比较大一些，毕竟还会触发<code>-methodSignatureForSelector:</code>，构建<code>NSMethodSignature</code>和<code>NSInvocation</code>实例。</p> <p>如果需要动态新增方法，可以在<code>+resolveInstanceMethod:</code>阶段完成；如果只是需要篡改 receiver，在<code>-forwardingTargetForSelector:</code>阶段完成更省事儿；如果需要更高阶的玩法，或许真的只有<code>-forwardInvocation:</code>能满足需求。</p> <h2 id="一些应用场景"><a href="#一些应用场景" class="header-anchor">#</a> 一些应用场景</h2> <p>这一部分罗列一些简单而有意思的应用场景。</p> <h3 id="可以接受任何消息的-nsnull"><a href="#可以接受任何消息的-nsnull" class="header-anchor">#</a> 可以接受任何消息的 NSNull</h3> <p>Objective-C 里的<code>nil</code>是个好东西，向它发送任何消息都不会导致<code>doesNotRecognizeSelector:</code>异常；然而，它不能作为集合类型的有效元素，也不能作为 nonnull 类型的入参或返回值。<code>NSNull</code>是表达「空」这一概念的另一种类型，但它的局限在于不能像<code>nil</code>一样安全接受任何消息。然而，基于<code>-forwardInvocation:</code>可以比较容易完成这一目标，即让<code>NSNull</code>能安全接受任何消息，代码如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@implementation</span> NSNull <span class="token punctuation">(</span>Safe<span class="token punctuation">)</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>forwardInvocation<span class="token punctuation">:</span><span class="token punctuation">(</span>NSInvocation <span class="token operator">*</span><span class="token punctuation">)</span>invocation <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">self</span> respondsToSelector<span class="token punctuation">:</span><span class="token punctuation">[</span>invocation selector<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>invocation invokeWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>NSMethodSignature <span class="token operator">*</span><span class="token punctuation">)</span>methodSignatureForSelector<span class="token punctuation">:</span><span class="token punctuation">(</span>SEL<span class="token punctuation">)</span>selector <span class="token punctuation">{</span>
    NSMethodSignature <span class="token operator">*</span>methodSignature <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSNull class<span class="token punctuation">]</span> instanceMethodSignatureForSelector<span class="token punctuation">:</span>selector<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>methodSignature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        methodSignature <span class="token operator">=</span> <span class="token punctuation">[</span>NSMethodSignature signatureWithObjCTypes<span class="token punctuation">:</span><span class="token string">&quot;@:&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// `@:`是随便定义的有效type encodings</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> methodSignature<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>
</code></pre></div><p>且不说这种设计的好坏，但它确实达到了目的：</p> <ul><li><code>-methodSignatureForSelector:</code>的处理使得<code>NSNull</code>对象可以接受任何 selector 而不产生<code>doesNotRecognizeSelector:</code>异常</li> <li><code>-forwardInvocation:</code>的处理使得<code>NSNull</code>实例接受到 unknown selector 时，不做任何处理，即空操作</li></ul> <p>更多有趣的应用场景，有待补充...</p> <p><strong>本文参考</strong></p> <ul><li>《Effective Objective-C 2.0》</li> <li><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtForwarding.html" target="_blank" rel="noopener noreferrer">Message Forwarding<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/81.bc82bd01.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
