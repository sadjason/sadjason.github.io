<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入理解 Auto Layout 第一弹 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/55.f0d54751.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/94.e9cc0386.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">深入理解 Auto Layout 第一弹</div> <div class="post-info">2015-07-16 • iOS</div></div> <div class="content content__default"><p>iOS 的的布局机制「auto layout」不是一个新概念，它早在 iOS 6 中就推出来了，当下距离 iOS 9 正式版面世已不远矣，我却对它的了解还比较初级。</p> <p>我之前对 auto layout 机制的理解非常粗浅，几乎把它和「constraint」对等。对它的使用有这么几个阶段：</p> <ol><li>Storyboard 中通过拖拽设置 constraints；</li> <li>学习 VFL（Visual Format Language）语法使用代码设置 constraints；</li> <li>使用大杀器<a href="https://github.com/SnapKit/Masonry" target="_blank" rel="noopener noreferrer">Masonry<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ol> <blockquote><p>P.S: iOS 的 VFL 语法实在太罗嗦了，又臭又长且可读性差难于调试，无法忍受，Masonry 正是解决这一痛点的第三方库，非常好用，学习成本非常低。</p></blockquote> <p>近期因为项目，我需要实现一个能够自适应文本自动调整高度的 table view cell。网上有相关丰富的资源（category、博客等），思路都非常简单，比如这篇：<a href="http://www.cocoachina.com/industry/20140604/8668.html" target="_blank" rel="noopener noreferrer">动态计算 UITableViewCell 高度详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。但即便如此，我对有些东西理解起来还有障碍，譬如<code>systemLayoutSizeFittingSize:</code>和<code>sizeThatFits:</code>之类的，想到我都将近有大半年的开发经验了，居然还无法理解这么简单的东西，不能忍！</p> <p>导致这种结果的主要原因有俩：一是之前项目比较简单，涉及 auto layout 相关的知识无非是 add/update/remove constraints；二是自己太轻浮，把 auto layout 想得太简单。</p> <p>通过对各种资讯梳理，大概搞明白了自己最大的问题是对 auto layout 相关的各种 API 不熟悉或者完全陌生，这导致了无法在一些实际问题中使用正确的策略解决问题。本文的着重点正是结合各种资料加上自己的理解对这些 API 进行分析。</p> <p>本文涉及的 API 包括：</p> <ul><li><code>sizeThatFits:</code>和<code>sizeToFit</code></li> <li><code>systemLayoutSizeFittingSize:</code></li> <li><code>intrinsicContentSize</code></li></ul> <blockquote><p>P.S: 这几个 API 都是与 size 相关，该如何使用它们呢？这曾让笔者一时非常困惑。以上这几个 API 都是 UIView 的实例方法，除此之外，本文还涉及一些属性，譬如<code>preferredMaxLayoutWidth</code>。</p></blockquote> <h3 id="ios-布局机制"><a href="#ios-布局机制" class="header-anchor">#</a> iOS 布局机制</h3> <p>iOS 布局机制大概分这么几个层次：</p> <ul><li>frame layout</li> <li>autoresizing</li> <li>auto layout</li></ul> <p><strong>frame layout</strong></p> <p>frame layout 最简单直接，简单来说，即通过设置 view 的<code>frame</code>属性值进而控制 view 的位置（相对于 superview 的位置）和大小。</p> <p><strong>autoresizing</strong></p> <p>autoresizing 和 frame layout 一样，从一开始存在，它算是后者的补充，基于 autoresizing 机制，能够让 subview 和 superview 维持一定的布局关系，譬如让 subview 的大小适应 superview 的大小，随着后者的改变而改变。</p> <p>站在代码接口的角度来看，autoresizing 主要体现在几个属性上，包括（但不限于）：</p> <ol><li><code>translatesAutoresizingMaskIntoConstraints</code></li> <li><code>autoresizingMask</code></li></ol> <p>第一个属性标识 view 是否愿意被 autoresize；
第二个属性是一个枚举值，决定了当 superview 的 size 改变时，subview 应该做出什么样的调整；</p> <p>关于 autoresizing 的更详细使用说明，参考：<a href="http://www.cocoachina.com/ios/20141216/10652.html" target="_blank" rel="noopener noreferrer">自动布局之 autoresizingMask 使用详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p><strong>auto layout</strong></p> <p>autoresizing 存在的不足是非常显著的，通过<code>autoresizingMask</code>的可选枚举值可以看出：基于 autoresizing 机制，我们只能让 view 在 superview 的大小改变时做些调整；而无法处理兄弟 view 之间的关系，譬如处理与兄弟 view 的间隔；更无法反向处理，譬如让 superview 依据 subview 的大小进行调整。</p> <p>Auto Layout 是随着 iOS 6 推出来的，关于它的介绍，官方文档《Auto Layout Guide》的描述非常精炼：</p> <blockquote><p>Auto Layout is a system that lets you lay out your app’s user interface by creating a mathematical description of the relationships between the elements. You define these relationships in terms of constraints either on individual elements, or between sets of elements. Using Auto Layout, you can create a dynamic and versatile interface that responds appropriately to changes in screen size, device orientation, and localization.</p></blockquote> <p>简单来说，它是一种基于约束的布局系统，可以根据你在元素（对象）上设置的约束自动调整元素（对象）的位置和大小。</p> <p>值得一提的是，对于某个 view 的布局方式，autoresizing 和 auto layout 只能二选一，简单来说，若要对某个 view 采用 auto layout 布局，则需要设置其<code>translatesAutoresizingMaskIntoConstraints</code>属性值为<code>NO</code>。</p> <h3 id="几个重要的-api"><a href="#几个重要的-api" class="header-anchor">#</a> 几个重要的 API</h3> <p><strong>intrinsicContentSize 方法</strong></p> <p>在介绍<code>intrinsicContentSize</code>方法之前，先来看一个应用场景：</p> <p>场景一：某个 UILabel 用于显示<strong>单行</strong>文本，让其能够自适应文本，即根据文本自动调整其大小。</p> <p>让 UILabel 自适应文本，在 auto layout 之前，一般做法是先给定字体，进而计算文本内容所占据的宽度 width 和高度 height，然后使用得来的 width 和 height 设置其<code>frame</code>属性值。</p> <p>但是使用 auto layout 非常简单，如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> ViewController <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    UILabel <span class="token operator">*</span>testLabel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor whiteColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    testLabel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        UILabel <span class="token operator">*</span>label        <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UILabel alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>textAlignment   <span class="token operator">=</span> NSTextAlignmentCenter<span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>font            <span class="token operator">=</span> <span class="token punctuation">[</span>UIFont systemFontOfSize<span class="token punctuation">:</span><span class="token number">14.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>textColor       <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor whiteColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor lightGrayColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>view addSubview<span class="token punctuation">:</span>testLabel<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 使用Masonry添加constraints</span>
    <span class="token punctuation">[</span>testLabel mas_makeConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        make<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_left<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    testLabel<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">@&quot;天地玄黄 宇宙洪荒 日月盈昃 辰宿列张&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidAppear<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>animated <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidAppear<span class="token punctuation">:</span>animated<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;testLabel.origin = %@&quot;</span><span class="token punctuation">,</span> <span class="token function">NSStringFromCGPoint</span><span class="token punctuation">(</span>testLabel<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;testLabel.size = %@&quot;</span><span class="token punctuation">,</span> <span class="token function">NSStringFromCGSize</span><span class="token punctuation">(</span>testLabel<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// print: &quot;testLabel.origin = {10, 40}&quot;</span>
    <span class="token comment">// print: &quot;testLabel.size = {236.5, 17}&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>效果如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150716-01.png" srcset="/image/20150716-01.png 2x" data-v-339c7bd5></div> <p>问题来了，auto layout system 知道 testLabel 的 size 呢？</p> <p>OK，就此引入 API <code>intrinsicContentSize</code>。</p> <p><code>intrinsicContentSize</code>是 UIView 的基础方法（Available in iOS 6.0 and later），<a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/" target="_blank" rel="noopener noreferrer">UIView Class References<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对它的描述如下：</p> <blockquote><p>Returns the natural size for the receiving view, considering only properties of the view itself.
 
<strong>Return Value</strong>
A size indicating the natural size for the receiving view based on its intrinsic properties.
 
<strong>Discussion</strong>
Custom views typically have content that they display of which the layout system is unaware. Overriding this method allows a custom view to communicate to the layout system what size it would like to be based on its content. This intrinsic size must be independent of the content frame, because there’s no way to dynamically communicate a changed width to the layout system based on a changed height, for example.
If a custom view has no intrinsic size for a given dimension, it can return UIViewNoIntrinsicMetric for that dimension.</p></blockquote> <p>「intrinsic content size」在中文世界里常被译作：「固有内容大小」，简单来说，<strong>它被用来告诉 auto layout system 应该给它分配多大的 size</strong>。</p> <p>所以呢，在上文代码（<strong>场景一</strong>的 Solution）中，根据我的理解，layout 工作流程是这样的：在 layout 时，auto layout system 会去回调 testLabel 的实例方法<code>intrinsicContentSize</code>，该方法能够根据「文本内容+字体」计算出 content 的 size，进而根据此 size 对 testLabel 进行布局。</p> <p>为了验证这个说法，对上述代码做些改变。</p> <p>首先定义一个继承自 UILabel 的类 ZWLabel，重写 ZWLabel 的<code>intrinsicContentSize</code>方法，如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> ZWLabel <span class="token punctuation">:</span> UILabel
    
<span class="token keyword">@end</span>
    
<span class="token keyword">@implementation</span> ZWLabel
    
<span class="token operator">-</span> <span class="token punctuation">(</span>CGSize<span class="token punctuation">)</span>intrinsicContentSize <span class="token punctuation">{</span>
    CGSize size <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">super</span> intrinsicContentSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    size<span class="token punctuation">.</span>width  <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    size<span class="token punctuation">.</span>height <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token keyword">@end</span>
</code></pre></div><p>然后让上文的<code>testLabel</code>从<code>UILabel</code>的实例改为<code>ZWLabel</code>的实例，其余不变：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>testLabel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    ZWLabel <span class="token operator">*</span>label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>ZWLabel alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
    label<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>效果如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150716-02.png" srcset="/image/20150716-02.png 2x" data-v-339c7bd5></div> <p>效果明显，本示例较为直观说明了<code>intrinsicContentSize</code>这个 API 的作用了，这个 API 是为 auto layout system 的 callback 提供的！</p> <p>P.S：笔者刚开始对<code>intrinsicContentSize</code>这个 API 的用法感到非常疑惑，在我的理解里，它有两种可能：</p> <ol><li>Auto Layout System 会根据 content 为 view 设置一个合适的 size，开发者有时需要知道这个 size，因此可以通过<code>intrinsicContentSize</code>获取；</li> <li>Auto Layout System 在 layout 时，不知道该为 view 分配多大的 size，因此回调 view 的<code>intrinsicContentSize</code>方法，该方法会给 auto layout system 一个合适的 size，system 根据此 size 对 view 的大小进行设置；</li></ol> <p>现在看来，第二种理解更靠谱！</p> <p>对于上文所用到的<code>UILabel</code>，想必 Cocoa 在实现<code>intrinsicContentSize</code>方法时已经根据<code>text</code>属性值和<code>font</code>属性值进行了计算。那是不是每个原生 view 都实现了<code>intrinsicContentSize</code>呢？</p> <p>NO！《<a href="https://developer.apple.com/library/watchos/documentation/UserExperience/Conceptual/AutolayoutPG/AutoLayoutConcepts/AutoLayoutConcepts.html" target="_blank" rel="noopener noreferrer">Auto Layout Guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>》在谈论「intrinsic content size」时，总会与另外一个词语「leaf-level views」相关联，譬如：</p> <blockquote><p><strong>Intrinsic Content Size</strong>
Leaf-level views such as buttons typically know more about what size they should be than does the code that is positioning them. This is communicated through the <strong>intrinsic content size</strong>, which tells the layout system that a view contains some content that it doesn’t natively understand, and indicates how large that content is, intrinsically.</p></blockquote> <p>「leaf-level views」指的是那种一般不包含任何 subview 的 view，譬如<code>UILabel</code>、<code>UIButton</code>等，这类的 view 往往能够直接计算出 content（譬如<code>UILabel</code>的 text、<code>UIButton</code>的 title，<code>UIImageView</code>的 image）的大小。</p> <p>但是有些 view 不包含 content，譬如<code>UIView</code>，这种 view 被认为「has no intrinsic size」，它们的<code>intrinsicContentSize</code>返回的值是<code>(-1,-1)</code>。</p> <blockquote><p>P.S: 官方文档中说的是：UIView's default implementation is to return (UIViewNoIntrinsicMetric, UIViewNoIntrinsicMetric)，而 UIViewNoIntrinsicMetric 等于<code>-1</code>，为什么是<code>-1</code>而不是<code>0</code>，我猜是<code>0</code>是一个有效的 width/height，而<code>-1</code>不是，更容易区分处理。</p></blockquote> <p>还有一种 view 虽然包含 content，但是<code>intrinsicContentSize</code>返回值也是<code>(-1,-1)</code>，这类 view 往往是<code>UIScrollView</code>的子类，譬如<code>UITextView</code>，它们是可滚动的，因此 auto layout system 在对这类 view 进行布局时总会存在一些未定因素，Cocoa 干脆让这些 view 的<code>intrinsicContentSize</code>返回<code>(-1,-1)</code>。</p> <p><strong>preferredMaxLayoutWidth 属性</strong></p> <p>基于上述<strong>场景一</strong>，我们来分析更复杂一点的 UILabel 自适应问题。</p> <p>场景二：某个 UILabel 用于显示<strong>多行</strong>文本，让其能够自适应文本，即根据文本自动调整其大小；</p> <p>对于单行文本 UILabel，UILabel 的<code>intrinsicContentSize</code>在计算 content size 时比较容易；但对于多行文本的 UILabel，同样的 content，譬如「天地玄黄宇宙洪荒」这八个字，摆放方式可以是 1x8，可以是 2x4，可以是 4x2，auto layout system 该如何处理呢？UILabel 的属性<code>preferredMaxLayoutWidth</code>正是用来应对这个问题的。</p> <p><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UILabel_Class/" target="_blank" rel="noopener noreferrer">UILabel Class References<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对它的描述如下：</p> <blockquote><p>The preferred maximum width (in points) for a multiline label.
 
<strong>Discussion</strong>
This property affects the size of the label when layout constraints are applied to it. During layout, if the text extends beyond the width specified by this property, the additional text is flowed to one or more new lines, thereby increasing the height of the label.</p></blockquote> <p><code>preferredMaxLayoutWidth</code>的作用顾名思义，用来限制 UILabel content size 的最大宽度值。如下代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>testLabel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    UILabel <span class="token operator">*</span>label                <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UILabel alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    label<span class="token punctuation">.</span>textAlignment           <span class="token operator">=</span> NSTextAlignmentCenter<span class="token punctuation">;</span>
    label<span class="token punctuation">.</span>font                    <span class="token operator">=</span> <span class="token punctuation">[</span>UIFont systemFontOfSize<span class="token punctuation">:</span><span class="token number">14.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    label<span class="token punctuation">.</span>textColor               <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor whiteColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    label<span class="token punctuation">.</span>numberOfLines           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">// mark</span>
    label<span class="token punctuation">.</span>preferredMaxLayoutWidth <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token comment">// mark</span>
    label<span class="token punctuation">.</span>backgroundColor         <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor lightGrayColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    label<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>view addSubview<span class="token punctuation">:</span>testLabel<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
<span class="token comment">// 使用Masonry添加constraints</span>
<span class="token punctuation">[</span>testLabel mas_makeConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    make<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    make<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_left<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
testLabel<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">@&quot;天地玄黄 宇宙洪荒 日月盈昃 辰宿列张&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>效果如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150716-03.png" srcset="/image/20150716-03.png 2x" data-v-339c7bd5></div> <p>那么最后<code>testLabel</code>的 width 是不是就是<code>preferredMaxLayoutWidth</code>的属性值呢？No，最终<code>testLabel</code>的属性值小于等于<code>preferredMaxLayoutWidth</code>的属性值。</p> <p><strong>sizeThatFits:方法和 sizeToFit 方法</strong></p> <p>上文已经提到，<code>UITextView</code>继承自<code>UIScrollView</code>，是可以滚动的，它的<code>intrinsicContentSize</code>方法返回值是<code>(-1,-1)</code>，auto layout system 在处理 UITextView 对象时，为其设置的 size 是<code>(0,0)</code>。如此看来，似乎<code>UITextView</code>无法体验到 auto layout 带来的好处了。</p> <p>继续结合应用场景引出<code>sizeThatFits:</code>方法和<code>sizeToFit</code>方法。</p> <p>场景三：某个<code>UITextView</code>用于显示文本，让其能够自适应文本，即根据文本自动调整其大小；</p> <p>既然 UITextView 的 content 计算方法<code>intrinsicContentSize</code>无法向 auto layout system 传递我们想要传达的值，我们就应该另想别的方法。</p> <p>好在 iOS 有直接的接口可供我们使用。</p> <p>先谈<code>sizeThatFits:</code>方法，<a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/" target="_blank" rel="noopener noreferrer">UIView Class References<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对它的描述如下：</p> <blockquote><p>Asks the view to calculate and return the size that best fits the specified size.
 
<strong>Return Value</strong>
A new size that fits the receiver’s subviews.
 
<strong>Discussion</strong>
The default implementation of this method returns the existing size of the view. Subclasses can override this method to return a custom value based on the desired layout of any subviews. For example, a UISwitch object returns a fixed size value that represents the standard size of a switch view, and a UIImageView object returns the size of the image it is currently displaying.</p></blockquote> <p>简单来说，调用<code>sizeThatFits:</code>方法意味着「根据文本计算最适合 UITextView 的 size」。从功能来讲，<code>sizeThatFits:</code>和<code>intrinsicContentSize</code>方法比较类似，都是用来计算 view 的 size 的。笔者曾一度对二者的关系非常疑惑，甚至觉得二者存在相互调用的关系。后来通过验证发现不是这么回事儿，后文会通过示例说明。</p> <p>对于显示多行文本的<code>UILabel</code>，为了方便<code>intrinsicContentSize</code>方法更方便计算 content size，需要指定<code>preferredMaxLayoutWidth</code>属性值；对于<code>UITextView</code>的<code>sizeThatFits:</code>，似乎有类似的需求，毕竟<code>UITextView</code>也可能会显示多行啊，这样说来，<code>UITextView</code>也有一个<code>preferredMaxLayoutWidth</code>属性？</p> <p>No！<code>preferredMaxLayoutWidth</code>属性是 iOS 6 才引入的，<code>sizeThatFits:</code>方法则早得多，况且，<code>UITextView</code>是可以滚动的，哪怕文本不会全部呈现出来，但也可以通过左右或者上下滚动浏览所有内容；传给<code>sizeThatFits:</code>的参数（假设为 size）是<code>CGSize</code>类型，size.width 的功能和<code>UILabel</code>的<code>preferredMaxLayoutWidth</code>差不多，指定了<code>UITextView</code>区域的最大宽度，size.height 则指定了<code>UITextView</code>区域的最大高度；可能有人问，若传给<code>sizeThatFits:</code>的 size 小于<code>UITextView</code>的 text 面积怎么办，岂不是有些内容无法显示出来？傻啊，可以滚啊！</p> <p>值得一提的是，调用<code>sizeThatFits:</code>并不改变 view 的 size，它只是让 view 根据已有 content 和给定 size 计算出最合适的 view.size。</p> <p>那么<code>sizeToFit</code>方法是干嘛的呢？很简单：</p> <blockquote><p>calls sizeThatFits: with current view bounds and changes bounds size.</p></blockquote> <p>P.S：有点不太理解，这个「current view」指的是啥？self？还是 superview？
P.P.S：经过验证，这里的「current view」指的是<code>self</code>。简单来说，<code>sizeToFit</code>等价于：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token comment">// calls sizeThatFits</span>
CGSize size <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">self</span> sizeThatFits<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>bounds<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// change bounds size</span>
CGRect bounds <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>bounds<span class="token punctuation">;</span>
bounds<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width <span class="token operator">=</span> size<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
bounds<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height <span class="token operator">=</span> size<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>bounds <span class="token operator">=</span> bounds<span class="token punctuation">;</span>
</code></pre></div><p>P.S：值得一提的是，经过测试发现，当调用<code>sizeThatFits:</code>的<code>size=(width, height)</code>，当 width/height 的值为 0 时，width/height 似乎就被认为是无穷大！</p> <p><strong>systemLayoutSizeFittingSize:方法</strong></p> <p>首先来看一个应用场景。</p> <p>场景四：某个<code>UIView</code>，宽度等于屏幕宽度，包含两个<code>UILabel</code>，两个 label 都可能显示多行文本，要求结合 auto layout 让<code>UIView</code>大小能够自适应 subviews。</p> <p>Easy，给出如下代码：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor lightGrayColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    bgView <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        UIView <span class="token operator">*</span>view         <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UIView alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        view<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor grayColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        view<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>view addSubview<span class="token punctuation">:</span>bgView<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    label1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        UILabel <span class="token operator">*</span>label                <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UILabel alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>font                    <span class="token operator">=</span> <span class="token punctuation">[</span>UIFont systemFontOfSize<span class="token punctuation">:</span><span class="token number">14.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>preferredMaxLayoutWidth <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>numberOfLines           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>textColor               <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor whiteColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>backgroundColor         <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor purpleColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>bgView addSubview<span class="token punctuation">:</span>label1<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    label2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        UILabel <span class="token operator">*</span>label                <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UILabel alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>font                    <span class="token operator">=</span> <span class="token punctuation">[</span>UIFont systemFontOfSize<span class="token punctuation">:</span><span class="token number">18.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>preferredMaxLayoutWidth <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>numberOfLines           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>textColor               <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor whiteColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>backgroundColor         <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor redColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>bgView addSubview<span class="token punctuation">:</span>label2<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 添加约束（基于Masonry）</span>
    <span class="token punctuation">[</span>bgView mas_makeConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        make<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span>label1 mas_makeConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        make<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_left<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">lessThanOrEqualTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_right<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span>label2 mas_makeConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        make<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>label1<span class="token punctuation">.</span>mas_left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">lessThanOrEqualTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_right<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>label1<span class="token punctuation">.</span>mas_bottom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>bottom<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_bottom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    label1<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">@&quot;天地玄黄 宇宙洪荒 日月盈昃 辰宿列张 寒来暑往 秋收冬藏 闰余成岁 律吕调阳&quot;</span><span class="token punctuation">;</span>
    label2<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">@&quot;天地玄黄 宇宙洪荒 日月盈昃 辰宿列张 寒来暑往 秋收冬藏 闰余成岁 律吕调阳&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码看得有些枯燥，简单来说，bgView（UIView）中嵌入两个能显示多行文本的 label1（UILabel）和 label2（UILabel），设置约束如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150716-05.png" srcset="/image/20150716-05.png 2x" data-v-339c7bd5></div> <p>代码运行后的显示效果：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150716-04.png" srcset="/image/20150716-04.png 2x" data-v-339c7bd5></div> <p>代码中除了添加各种各样的 constraints，没有任何设置 frame 的代码，显然都是基于 auto layout 的。</p> <p>那么问题来了，理解 label1 和 label2 的布局没啥子问题，因为它们的<code>intrinsicContentSize</code>方法会将 content size 告诉 auto layout system，进而后者会为它们的 size 设置对应值；但对于 bgView，它可是一个<code>UIView</code>对象，它的<code>intrinsicContentSize</code>回调方法的返回值为<code>(-1,-1)</code>，那么 auto layout system 是如何为它设置合适的 size 的呢？</p> <p>根据我的理解，auto layout system 在处理某个 view 的 size 时，参考值包括：</p> <ul><li>自身的<code>intrinsicContentSize</code>方法返回值；</li> <li>subviews 的<code>intrinsicContentSize</code>方法返回值；</li> <li>自身和 subviews 的 constraints；</li></ul> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150716-06.png" srcset="/image/20150716-06.png 2x" data-v-339c7bd5></div> <p>OK，根据笔者理解，结合上图，我认为 auto layout system 是这样计算一下 bgView 的 size 的：</p> <p>width=max{10+size1.width+10, 10+size2.width+10, size3.width}
height=max{10+size1.height+10+size2.height+10, size3.height}</p> <p>我们在<code>viewDidAppear:</code>方法中将相关值打印出来瞧瞧看：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidAppear<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>animated <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidAppear<span class="token punctuation">:</span>animated<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    CGSize size1 <span class="token operator">=</span> <span class="token punctuation">[</span>label1 intrinsicContentSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    CGSize size2 <span class="token operator">=</span> <span class="token punctuation">[</span>label2 intrinsicContentSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    CGSize size3 <span class="token operator">=</span> <span class="token punctuation">[</span>bgView intrinsicContentSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;size1 = %@&quot;</span><span class="token punctuation">,</span> <span class="token function">NSStringFromCGSize</span><span class="token punctuation">(</span>size1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// print: &quot;size1 = {300, 33.5}&quot;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;size2 = %@&quot;</span><span class="token punctuation">,</span> <span class="token function">NSStringFromCGSize</span><span class="token punctuation">(</span>size2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// print: &quot;size2 = {290.5, 64.5}&quot;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;size3 = %@&quot;</span><span class="token punctuation">,</span> <span class="token function">NSStringFromCGSize</span><span class="token punctuation">(</span>size3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// print: &quot;size3 = {-1, -1}&quot;</span>
    
    CGSize bgViewSize <span class="token operator">=</span> bgView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;bgViewSize = %@&quot;</span><span class="token punctuation">,</span> <span class="token function">NSStringFromCGSize</span><span class="token punctuation">(</span>bgViewSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// print: &quot;bgViewSize = {320, 128}&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>完全吻合我理解的 auto layout size 计算公式。</p> <p>P.S：然而，我知道，事实往往并没有这么简单，当处理自定义 View 时，当 constraints 设置不完整或者冲突时，事情总会变得复杂起来，也总会得到意想不到的结果。但，暂且就这么理解吧！</p> <p>啰里啰嗦写了这么多，还没引出<code>systemLayoutSizeFittingSize:</code>方法...</p> <p>OK，再来看另外一个应用场景。</p> <p>场景五：某个<code>UIView</code>，宽度等于屏幕宽度，包含一个<code>UILabel</code>和一个<code>UITextView</code>，二者都可能显示多行文本，要求结合 auto layout 让<code>UIView</code>大小能够自适应 subviews。</p> <p>在场景四代码基础上将 label2 改为 UITextView 对象 textView1，如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor lightGrayColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    bgView <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        UIView <span class="token operator">*</span>view         <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UIView alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        view<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor grayColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        view<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>view addSubview<span class="token punctuation">:</span>bgView<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    label1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        UILabel <span class="token operator">*</span>label                <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UILabel alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>font                    <span class="token operator">=</span> <span class="token punctuation">[</span>UIFont systemFontOfSize<span class="token punctuation">:</span><span class="token number">14.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>preferredMaxLayoutWidth <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>numberOfLines           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>textColor               <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor whiteColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>backgroundColor         <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor purpleColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>bgView addSubview<span class="token punctuation">:</span>label1<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    textView1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        UITextView <span class="token operator">*</span>label     <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UITextView alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>font            <span class="token operator">=</span> <span class="token punctuation">[</span>UIFont systemFontOfSize<span class="token punctuation">:</span><span class="token number">18.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>textColor       <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor whiteColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor redColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        label<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>bgView addSubview<span class="token punctuation">:</span>textView1<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 添加约束（基于Masonry）</span>
    <span class="token punctuation">[</span>bgView mas_makeConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        make<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>mas_width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span>label1 mas_makeConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        make<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_left<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">lessThanOrEqualTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_right<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span>textView1 mas_makeConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        make<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>label1<span class="token punctuation">.</span>mas_left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">lessThanOrEqualTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_right<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>label1<span class="token punctuation">.</span>mas_bottom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>bottom<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>bgView<span class="token punctuation">.</span>mas_bottom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    label1<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">@&quot;天地玄黄 宇宙洪荒 日月盈昃 辰宿列张 寒来暑往 秋收冬藏 闰余成岁 律吕调阳&quot;</span><span class="token punctuation">;</span>
    textView1<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">@&quot;天地玄黄 宇宙洪荒 日月盈昃 辰宿列张 寒来暑往 秋收冬藏 闰余成岁 律吕调阳&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行效果如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150716-07.png" srcset="/image/20150716-07.png 2x" data-v-339c7bd5></div> <p>这显然不是我们想要的结果，至少存在这么两个问题：</p> <ol><li>textView1 不见了；</li> <li>bgView 的大小不是我们想要的；</li></ol> <p>为什么会有出现这样的问题呢？</p> <p>首先正如上文所提到的那样，textView1 是 UITextView 的对象，而 UITextView 是 UIScrollView 的子类，它的<code>intrinsicContentSize:</code>方法的返回值是<code>(-1,-1)</code>，这意味着 textView1 对 bgView 的 auto layout size 没有产生影响。</p> <p>那 textView1 为什么不见了呢？或者说，为什么 textView1 的 size 为 CGSizeZero 呢？根据我对 auto layout system 的理解，auto layout system 在处理 view 的 size 时，受三个因素影响：</p> <ul><li>自身的<code>intrinsicContentSize</code>方法返回值；</li> <li>subviews 的<code>intrinsicContentSize</code>方法返回值；</li> <li>自身和 subviews 的 constraints；</li></ul> <p>对于 textView1，前两个因素可以忽略掉，简而言之，textView1 的 size 由它自身的 constraints 决定。而根据上述代码的约束可以计算出 textView1 的 height：
height = bgView.height-10-label1.height-10-10;</p> <p>而 bgView.height=10+label1.height+10+10；意味着 textView1 的 height 值为 0；当然就看不到了 textView1 了。</p> <p>因此，若想要让 textView1 正常可见，至少有这么一种策略：直接为 textView1 添加约束设置 width 和 height；</p> <p>简单来说，override 回调方法<code>viewWillLayoutSubviews</code>，如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewWillLayoutSubviews <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewWillLayoutSubviews<span class="token punctuation">]</span><span class="token punctuation">;</span>

    CGSize textViewFitSize <span class="token operator">=</span> <span class="token punctuation">[</span>textView1 sizeThatFits<span class="token punctuation">:</span><span class="token function">CGSizeMake</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>textView1 mas_updateConstraints<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>MASConstraintMaker <span class="token operator">*</span>make<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        make<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token punctuation">[</span>NSNumber numberWithFloat<span class="token punctuation">:</span>textViewFitSize<span class="token punctuation">.</span>width<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        make<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token punctuation">[</span>NSNumber numberWithFloat<span class="token punctuation">:</span>textViewFitSize<span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这种做法是有效的，运行效果如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/20150716-09.png" srcset="/image/20150716-09.png 2x" data-v-339c7bd5></div> <p>若将这种场景切换到 table view cell 中会如何呢？简单来说，如果将上述的 bgView 换成 UITableViewCell（或其子类）对象又会如何呢？</p> <p>在 table view 中，我们可以使用<code>- (CGFloat)tableView:heightForRowAtIndexPath:</code>接口，该回调方法会返回 CGFloat 值，该值指示了对应 cell 的高度；假设 auto layout system 为 cell 分配的 size 是 autoSize，在处理返回值时额外加上 textViewFitSize.height 即可。</p> <p>但问题是，我们如何获取这个 autoSize 的值呢？毕竟此时 cell 还未布局完成啊，直接读取 cell.frame.size 肯定是不行的。</p> <p><code>systemLayoutSizeFittingSize:</code>方法正是用于处理这个问题的。</p> <p><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/" target="_blank" rel="noopener noreferrer">UIView Class References<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对该方法描述如下：</p> <blockquote><p>Returns the size of the view that satisfies the constraints it holds.
 
<strong>Return Value</strong>
The size of the view that satisfies the constraints it holds.
 
<strong>Discussion</strong>
Determines the best size of the view considering all constraints it holds and those of its subviews.</p></blockquote> <p>我是这么理解<code>systemLayoutSizeFittingSize:</code>的：对于使用 auto layout 机制布局的 view，auto layout system 会在布局过程中综合各种约束的考虑为之设置一个 size，在布局完成后，该 size 的值即为 view.frame.size 的值；这包含的另外一层意思，即在布局完成前，我们是不能通过 view.frame.size 准确获取 view 的 size 的。但有时候，我们需要在 auto layout system 对 view 完成布局前就知道它的 size，<code>systemLayoutSizeFittingSize:</code>方法正是能够满足这种要求的 API。<code>systemLayoutSizeFittingSize:</code>方法会根据其 constraints 返回一个合适的 size 值。</p> <p><code>systemLayoutSizeFittingSize:</code>方法可传入一个参数，目前有两个值可以传入：</p> <ul><li>UILayoutFittingCompressedSize : The option to use the smallest possible size.</li> <li>UILayoutFittingExpandedSize : The option to use the largest possible size.</li></ul> <p>值得一提的是，在使用<code>[view systemLayoutSizeFittingSize:]</code>时，要注意尽量确保 view 的 constraints 的完整性，这样参数 UILayoutFittingCompressedSize 和 UILayoutFittingExpandedSize 得到的结果是一样的。否则，举个例子，若 view 的 right 属性没有设置，则这两个参数得到<code>systemLayoutSizeFittingSize:</code>返回值 size 是不一样的，前者 size.width=0，后者 size.width=1000。
P.S：这纯属个人使用体验。</p> <p>至于<code>systemLayoutSizeFittingSize:</code>的使用场景，<a href="http://www.cocoachina.com/industry/20140604/8668.html" target="_blank" rel="noopener noreferrer">动态计算 UITableViewCell 高度详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>非常值得参考！</p> <p><strong>对比几种 API</strong></p> <p>在刚开始接触这几个 API 时感到非常困惑。分不清<code>intrinsicContentSize</code>、<code>sizeThatFits:</code>以及<code>systemLayoutSizeFittingSize:</code>的区别。经过这么将近一天的折腾，现在大概有了基本的判断。</p> <p>首先说<code>intrinsicContentSize</code>，它的最主要作用是告诉 auto layout system 一些信息，可以认为它是后者的回调方法，auto layout system 在对 view 进行布局时会参考这个回调方法的返回值；一般很少像<code>CGSize size = [view intrinsicContentSize]</code>去使用<code>intrinsicContentSize</code> API。</p> <p>再来看<code>sizeThatFits:</code>和<code>systemLayoutSizeFittingSize:</code>，它们俩非常相似，都是为开发者直接服务的 API（而不是回调方法）。所不同的是，<code>sizeThatFits:</code>是 auto layout 之前就存在的，一般在 leaf-level views 中用得比较多，在计算 size 过程中，它可不会考虑 constraints 神马的；对于<code>systemLayoutSizeFittingSize:</code>，它是随着 auto layout（iOS 6）引入的，用于在 view 完成布局前获取 size 值，如果 view 的 constraints 确保了完整性和正确性，通常它的返回值就是 view 完成布局之后的 view.frame.size 的值。</p> <p>它们之前存在相互调用的关系吗？经过测试发现，三者之前没有直接的调用关系。但是能得出这样的结论：<code>intrinsicContentSize</code>的返回值会直接影响<code>systemLayoutSizeFittingSize:</code>的返回值。至于底层是如何处理的不得而知。</p> <h3 id="写在后面"><a href="#写在后面" class="header-anchor">#</a> 写在后面</h3> <p>本博客写了好多个小时，非常勉强，写完后不忍直视，臭又长。进一步意识到把博客写长不难，难的是把它写短同时传递足够多的信息。这在方面，我需要极大的提升啊！</p> <p>用人话把技术讲清楚。</p> <h3 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h3> <ul><li><a href="http://stackoverflow.com/questions/24127032/proper-usage-of-intrinsiccontentsize-and-sizethatfits-on-uiview-subclass-with-a" target="_blank" rel="noopener noreferrer">Proper usage of intrinsicContentSize and sizeThatFits: on UIView Subclass with autolayout<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://stackoverflow.com/questions/27711853/how-to-set-a-labels-preferredmaxlayoutwidth-to-automatic-programmatically" target="_blank" rel="noopener noreferrer">How to set a label's preferredMaxLayoutWidth to automatic programmatically?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://stackoverflow.com/questions/18118021/how-to-resize-superview-to-fit-all-subviews-with-autolayout/18155803#18155803" target="_blank" rel="noopener noreferrer">How to resize superview to fit all subviews with autolayout?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://stackoverflow.com/questions/18746929/using-auto-layout-in-uitableview-for-dynamic-cell-layouts-variable-row-heights/18746930#18746930" target="_blank" rel="noopener noreferrer">Using Auto Layout in UITableView for dynamic cell layouts &amp; variable row heights<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://xuexuefeng.com/autolayout/" target="_blank" rel="noopener noreferrer">iOS 开发实践之 Auto Layout<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.cocoachina.com/industry/20140604/8668.html" target="_blank" rel="noopener noreferrer">动态计算 UITableViewCell 高度详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/55.f0d54751.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
