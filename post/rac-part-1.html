<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RACSignal 的简单使用与基本操作 | 张不坏的博客</title>
    <meta name="description" content="Just For Fun">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.37bfab3d.css" as="style"><link rel="preload" href="/assets/js/app.50bca889.js" as="script"><link rel="preload" href="/assets/js/5.081d1701.js" as="script"><link rel="preload" href="/assets/js/94.e9cc0386.js" as="script"><link rel="preload" href="/assets/js/4.a7413ce2.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb33f06.js"><link rel="prefetch" href="/assets/js/100.014ff06c.js"><link rel="prefetch" href="/assets/js/101.28f11de0.js"><link rel="prefetch" href="/assets/js/102.be9d2e87.js"><link rel="prefetch" href="/assets/js/103.a1210d81.js"><link rel="prefetch" href="/assets/js/104.7101a956.js"><link rel="prefetch" href="/assets/js/105.833e6f80.js"><link rel="prefetch" href="/assets/js/106.978e1fc0.js"><link rel="prefetch" href="/assets/js/107.5af47fd0.js"><link rel="prefetch" href="/assets/js/108.efc3ce89.js"><link rel="prefetch" href="/assets/js/109.a69d6b5a.js"><link rel="prefetch" href="/assets/js/11.2de4afc9.js"><link rel="prefetch" href="/assets/js/110.30984b63.js"><link rel="prefetch" href="/assets/js/12.bfc099bd.js"><link rel="prefetch" href="/assets/js/13.20253e0d.js"><link rel="prefetch" href="/assets/js/14.67131b1c.js"><link rel="prefetch" href="/assets/js/15.1af26cbd.js"><link rel="prefetch" href="/assets/js/16.4b261ee0.js"><link rel="prefetch" href="/assets/js/17.1216332f.js"><link rel="prefetch" href="/assets/js/18.c0159773.js"><link rel="prefetch" href="/assets/js/19.0f007f87.js"><link rel="prefetch" href="/assets/js/2.b4633a05.js"><link rel="prefetch" href="/assets/js/20.4b295001.js"><link rel="prefetch" href="/assets/js/21.0c46767c.js"><link rel="prefetch" href="/assets/js/22.a5e065ea.js"><link rel="prefetch" href="/assets/js/23.f43a6a7e.js"><link rel="prefetch" href="/assets/js/24.245f4f15.js"><link rel="prefetch" href="/assets/js/25.618f74a1.js"><link rel="prefetch" href="/assets/js/26.274a606b.js"><link rel="prefetch" href="/assets/js/27.c2d8fe18.js"><link rel="prefetch" href="/assets/js/28.5c522d2a.js"><link rel="prefetch" href="/assets/js/29.c90fdb1a.js"><link rel="prefetch" href="/assets/js/3.9babd8f1.js"><link rel="prefetch" href="/assets/js/30.1ccbdebc.js"><link rel="prefetch" href="/assets/js/31.acf3eca6.js"><link rel="prefetch" href="/assets/js/32.ccfdc859.js"><link rel="prefetch" href="/assets/js/33.9b262756.js"><link rel="prefetch" href="/assets/js/34.c59a4044.js"><link rel="prefetch" href="/assets/js/35.2b10fefb.js"><link rel="prefetch" href="/assets/js/36.2daeeb7b.js"><link rel="prefetch" href="/assets/js/37.d649866c.js"><link rel="prefetch" href="/assets/js/38.aba1ac95.js"><link rel="prefetch" href="/assets/js/39.58a95fd1.js"><link rel="prefetch" href="/assets/js/40.8ef4d374.js"><link rel="prefetch" href="/assets/js/41.5799de7a.js"><link rel="prefetch" href="/assets/js/42.b7ee7489.js"><link rel="prefetch" href="/assets/js/43.28a65d64.js"><link rel="prefetch" href="/assets/js/44.90f92ea2.js"><link rel="prefetch" href="/assets/js/45.30b683fd.js"><link rel="prefetch" href="/assets/js/46.f57ccc19.js"><link rel="prefetch" href="/assets/js/47.7a82bd74.js"><link rel="prefetch" href="/assets/js/48.72503020.js"><link rel="prefetch" href="/assets/js/49.3a4ba077.js"><link rel="prefetch" href="/assets/js/50.0c3297f3.js"><link rel="prefetch" href="/assets/js/51.e9ba9363.js"><link rel="prefetch" href="/assets/js/52.473ee9ff.js"><link rel="prefetch" href="/assets/js/53.166d6e7a.js"><link rel="prefetch" href="/assets/js/54.78af3662.js"><link rel="prefetch" href="/assets/js/55.f0d54751.js"><link rel="prefetch" href="/assets/js/56.5de81531.js"><link rel="prefetch" href="/assets/js/57.6e18322f.js"><link rel="prefetch" href="/assets/js/58.1fccc879.js"><link rel="prefetch" href="/assets/js/59.773775e1.js"><link rel="prefetch" href="/assets/js/6.0c9cc532.js"><link rel="prefetch" href="/assets/js/60.0d665185.js"><link rel="prefetch" href="/assets/js/61.d9ae36dc.js"><link rel="prefetch" href="/assets/js/62.fb5e3b65.js"><link rel="prefetch" href="/assets/js/63.5ace8fda.js"><link rel="prefetch" href="/assets/js/64.d44fb0af.js"><link rel="prefetch" href="/assets/js/65.ed8fe56f.js"><link rel="prefetch" href="/assets/js/66.809078da.js"><link rel="prefetch" href="/assets/js/67.2489499e.js"><link rel="prefetch" href="/assets/js/68.e3ee952d.js"><link rel="prefetch" href="/assets/js/69.071411f8.js"><link rel="prefetch" href="/assets/js/7.8188415c.js"><link rel="prefetch" href="/assets/js/70.be8269cf.js"><link rel="prefetch" href="/assets/js/71.a320347a.js"><link rel="prefetch" href="/assets/js/72.f4fda48b.js"><link rel="prefetch" href="/assets/js/73.0f9f9284.js"><link rel="prefetch" href="/assets/js/74.b4028d07.js"><link rel="prefetch" href="/assets/js/75.6d63415f.js"><link rel="prefetch" href="/assets/js/76.d5b4df24.js"><link rel="prefetch" href="/assets/js/77.62b794e1.js"><link rel="prefetch" href="/assets/js/78.63e767ab.js"><link rel="prefetch" href="/assets/js/79.45056905.js"><link rel="prefetch" href="/assets/js/8.20d7cb0f.js"><link rel="prefetch" href="/assets/js/80.e06c5521.js"><link rel="prefetch" href="/assets/js/81.bc82bd01.js"><link rel="prefetch" href="/assets/js/82.4aeb6081.js"><link rel="prefetch" href="/assets/js/83.3ed6146f.js"><link rel="prefetch" href="/assets/js/84.f2aff9f4.js"><link rel="prefetch" href="/assets/js/85.2b8f4e50.js"><link rel="prefetch" href="/assets/js/86.27aea1da.js"><link rel="prefetch" href="/assets/js/87.7f5dc71e.js"><link rel="prefetch" href="/assets/js/88.9ca6511c.js"><link rel="prefetch" href="/assets/js/89.e8f54ad1.js"><link rel="prefetch" href="/assets/js/9.ee6c43f7.js"><link rel="prefetch" href="/assets/js/90.9abac718.js"><link rel="prefetch" href="/assets/js/91.9d8f5f36.js"><link rel="prefetch" href="/assets/js/92.2277b907.js"><link rel="prefetch" href="/assets/js/93.efca2f57.js"><link rel="prefetch" href="/assets/js/95.fa3326f7.js"><link rel="prefetch" href="/assets/js/96.82bafc57.js"><link rel="prefetch" href="/assets/js/97.da22d13e.js"><link rel="prefetch" href="/assets/js/98.d745e5ec.js"><link rel="prefetch" href="/assets/js/99.79a6f693.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37bfab3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div class="navbar"><div class="navbar-content"><div class="slogan">Valar Morghulis</div> <div class="links"><span class="link-item"><a href="/">首页</a></span> <span class="link-item"><a href="/category/iOS/">iOS</a></span> <span class="link-item"><a href="/category/other/">其他</a></span></div></div></div> <div class="content-header"><div class="post-title">RACSignal 的简单使用与基本操作</div> <div class="post-info">2016-07-28 • iOS</div></div> <div class="content content__default"><p><strong>写在前面</strong></p> <p>2016 年 07 月初入职场，因为工作需要，接触了 ReactiveCocoa（也常称为<em>RAC</em>）。彼时，正如前辈所告知的那样：ReactiveCocoa 的学习曲线较陡峭。或许是我网络搜索能力欠佳，那时很难在网上找到比较靠谱的 RAC 中文资料。然而比较幸运的是，我司大神臧成威恰好那时在内部开辟了系列 RAC 视频教学，让我的 RAC 学习经历没那么痛苦。另外，值得一提的是，美团几篇公开的<a href="https://tech.meituan.com/talk-about-reactivecocoas-cold-signal-and-hot-signal-part-1.html" target="_blank" rel="noopener noreferrer">ReactiveCocoa 技术博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>仍然是 RAC 初学者不得不看的优质资料。</p> <p>这一两年来，时至今日（2017 年尾），网络上优质的 RAC 博客慢慢多起来了，基于这些优质的博客，RAC 的「学习陡峭」问题其实已经有明显好转。</p> <p>我在学习 RAC 过程中，记录了不少的学习笔记，趁闲整理一下，大概包括如下几个部分：</p> <ul><li>信号（<code>RACSignal</code>）的简单使用和基本操作</li> <li>ReactiveCocoa 的内存管理</li> <li>ReactiveCocoa 与多线程</li></ul> <p>我个人认为，搞清楚了如上这三个方面的内容，基本上就可以上手使用 ReactiveCocoa 进行开发了。当然，<code>RACCommand</code>也是要了解的，后者的内部实现比较复杂，但使用起来还是蛮方便的，可能也会在后面博客中涉及它。至于其他相关概念，譬如<code>RACScheduler</code>、<code>RACSubject</code>，实现相对简单，遇到问题看源码基本就可以解决。</p> <p>本文总结的内容围绕<code>RACSignal</code>，包括：</p> <ul><li><code>RACSignal</code>的简单使用
<ul><li>获取信号</li> <li>订阅信号</li> <li>订阅过程</li></ul></li> <li><code>RACSignal</code>的基本操作
<ul><li>单个信号的变换</li> <li>多个信号的组合</li></ul></li></ul> <p>Signal 传递的 data 是 event，它所传递的 event 包括 3 种：<em>值事件</em>、<em>完成事件</em>和<em>错误事件</em>。其中在传递值事件时，可以携带数据。落实到代码层面，传递值事件/完成事件/错误事件的本质就是向 subscriber 发送<code>sendNext:</code>、<code>sendComplete</code>以及<code>sendError:</code>消息。</p> <p>为了更形象对各种操作进行表述，下文会大量使用图例，绿色圆圈代表值事件，红色叉代表错误事件，红色杠代表完成事件，灰色带箭头直线代表时间线，如下：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/signal-symbols@2x.png" srcset="/image/signal-symbols@2x.png 2x" data-v-339c7bd5></div> <p>Signal 在其生命周期内，可以传递任意多个值事件，但最多只能传递一个完成事件或错误事件；换句话说，一旦 Signal 的事件流中出现了错误事件或者完成事件，之后产生的任何事件都是无效的。</p> <h2 id="信号的简单使用"><a href="#信号的简单使用" class="header-anchor">#</a> 信号的简单使用</h2> <p>这一部分将从 3 个方面介绍信号的简单实用，包括：创建信号、订阅信号、订阅过程。</p> <h3 id="获取信号"><a href="#获取信号" class="header-anchor">#</a> 获取信号</h3> <p>获取信号的方式有很多种：</p> <ul><li>创建单元信号</li> <li>创建动态信号</li> <li>通过 Cocoa 桥接</li> <li>从别的信号变换而来</li> <li>由序列变换而来</li></ul> <p><strong>单元信号</strong></p> <p>最简单的信号是单元信号，有 4 种：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token comment">// return信号：被订阅后，立马产生一个值事件，然后产生一个完成事件</span>
RACSignal <span class="token operator">*</span>signal1 <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal <span class="token keyword">return</span><span class="token punctuation">:</span>someObject<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// error信号：被订阅后，立马产生一个错误事件</span>
RACSignal <span class="token operator">*</span>signal2 <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal error<span class="token punctuation">:</span>someError<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// empty信号：被订阅后，立马产生一个完成事件</span>
RACSignal <span class="token operator">*</span>signal3 <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal empty<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// never信号：永远不产生事件</span>
RACSignal <span class="token operator">*</span>signal4 <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal never<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>可以用图例描述这 4 个信号：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/return-error-empty-never@2x.png" srcset="/image/return-error-empty-never@2x.png 2x" data-v-339c7bd5></div> <p><strong>动态信号</strong></p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal5 <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>RACDisposable disposableWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Cocoa 桥接</strong></p> <p>RAC 为大量的 Cocoa 类型提供便捷的信号桥接工具，如下是一些常见的桥接方式：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal6 <span class="token operator">=</span> <span class="token punctuation">[</span>object rac_signalForSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>setFrame<span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
RACSignal <span class="token operator">*</span>signal7 <span class="token operator">=</span> <span class="token punctuation">[</span>control rac_signalForControlEvents<span class="token punctuation">:</span>UIControlEventTouchUpInside<span class="token punctuation">]</span><span class="token punctuation">;</span>
RACSignal <span class="token operator">*</span>signal8 <span class="token operator">=</span> <span class="token punctuation">[</span>object rac_willDeallocSignal<span class="token punctuation">]</span><span class="token punctuation">;</span>
RACSignal <span class="token operator">*</span>signal9 <span class="token operator">=</span> <span class="token function">RACObserve</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> keyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 还有更多</span>
</code></pre></div><p><strong>信号变换</strong></p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal10 <span class="token operator">=</span> <span class="token punctuation">[</span>signal1 map<span class="token punctuation">:</span><span class="token operator">^</span><span class="token function">id</span><span class="token punctuation">(</span>id value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> someObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>序列变换</strong></p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal11 <span class="token operator">=</span> sequence<span class="token punctuation">.</span>signal<span class="token punctuation">;</span>
</code></pre></div><h3 id="订阅信号"><a href="#订阅信号" class="header-anchor">#</a> 订阅信号</h3> <p>订阅信号的方式有 3 种：</p> <ul><li>通过<code>subscribeNext:error:completed:</code>方法订阅</li> <li>RAC 宏绑定</li> <li>Cocoa 桥接</li></ul> <p><strong>通过<code>subscribeNext:error:completed:</code>方法订阅</strong></p> <p><code>subscribeNext:error:completed:</code>是最基础的信号订阅方法，相关的方法原型如下：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">)</span>subscribeNext<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span><span class="token punctuation">)</span>nextBlock
                           error<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSError <span class="token operator">*</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>errorBlock
                       completed<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>RAC 宏绑定</strong></p> <p>可以使用<code>RAC()</code>宏（和上述的<code>RACObserve()</code>宏不一样）绑定：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token function">RAC</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> backgroundColor<span class="token punctuation">)</span> <span class="token operator">=</span> signal10<span class="token punctuation">;</span>
<span class="token comment">// 每当signal10产生一个值事件，就将view.backgroundColor设为相应的值</span>
</code></pre></div><p><strong>Cocoa 桥接</strong></p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token punctuation">[</span>object rac_liftSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>someSelector<span class="token punctuation">:</span><span class="token punctuation">)</span> withSignals<span class="token punctuation">:</span>signal1<span class="token punctuation">,</span> signal2<span class="token punctuation">,</span> nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>object rac_liftSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>someSelector<span class="token punctuation">:</span><span class="token punctuation">)</span> withSignalsFromArray<span class="token punctuation">:</span><span class="token operator">@</span><span class="token punctuation">[</span>signal1<span class="token punctuation">,</span> signal2<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>object rac_liftSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>someSelector<span class="token punctuation">:</span><span class="token punctuation">)</span> withSignalOfArguments<span class="token punctuation">:</span>signal1<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="订阅过程"><a href="#订阅过程" class="header-anchor">#</a> 订阅过程</h3> <p>所谓订阅过程指的是信号被订阅的处理逻辑，如下是简单的例子：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>RACSignal <span class="token operator">*</span>signal <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal createSignal<span class="token punctuation">:</span><span class="token operator">^</span>RACDisposable <span class="token operator">*</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>RACSubscriber<span class="token operator">&gt;</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>subscriber sendCompleted<span class="token punctuation">]</span><span class="token punctuation">;</span>     
    <span class="token punctuation">[</span>subscriber sendNext<span class="token punctuation">:</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 无效</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>RACDisposable disposableWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;dispose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 当错误事件或者完成事件产生时，该block被调用</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>signal subscribeNext<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;next value is :  %@&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> error<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>NSError <span class="token operator">*</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;error : %@&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> completed<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">/* prints:
next value is :  1
next value is :  2
completed
dispose
*/</span>
</code></pre></div><h2 id="信号的各类操作"><a href="#信号的各类操作" class="header-anchor">#</a> 信号的各类操作</h2> <p>这一部分将介绍信号的各类操作，内容比较多。将信号的操作分为两类：单个信号的变换、多个信号的组合。</p> <h3 id="单个信号的变换"><a href="#单个信号的变换" class="header-anchor">#</a> 单个信号的变换</h3> <p>单个信号的变换也可以分为几类：</p> <ul><li>值操作</li> <li>数量操作</li> <li>时间操作</li></ul> <p>下文结合图例对各种操作进行说明。</p> <p><strong>值操作 -- Map</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/map@2x.png" srcset="/image/map@2x.png 2x" data-v-339c7bd5></div> <ul><li>当<code>signalA</code>事件流出现完成事件时，<code>signalB</code>的事件流也会出现完成事件</li> <li>当<code>signalA</code>事件流出现错误事件时，<code>signalB</code>也会将该错误原封不动地释放出来</li></ul> <p><code>map:</code>操作还有一个简化版：<code>mapReplace:</code>，<code>[signalA mapReplace:@886];</code>等价于<code>[signalA map:^id(id value) { return @886; }];</code>。</p> <p><strong>值操作 -- ReduceEach</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/reduce-each@2x.png" srcset="/image/reduce-each@2x.png 2x" data-v-339c7bd5></div> <p><code>reduceEach:</code>这个操作的名字不太容易理解，但是操作本身还是非常简单，是<code>map:</code>的变体。当<code>signalA</code>的值事件包裹的数据是<code>RACTuple</code>类型时，才可以使用该操作；稍微读一下该操作的实现源码即可明白。</p> <p>此外，<code>reduceEach:</code>的 block 中，可以传入的参数是任意数量。</p> <p>P.S: 如何理解「reduce」？</p> <p><strong>值操作 -- 其他的 Map 变体操作</strong></p> <p>除了<code>reduceEach:</code>，<code>map:</code>还有其他的一些变体操作：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>not<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>and<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>or<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>reduceApply<span class="token punctuation">;</span>
</code></pre></div><p>前面 3 个都比较容易理解，<code>reduceApply</code>也要求值事件包裹的数据类型是<code>RACTuple</code>，并且该<code>RACTuple</code>的第一个元素是一个 block，后面的元素作为该 block 的参数传入，返回该 block 的执行结果。</p> <p><strong>值操作 -- Materialize 和 Dematerialize</strong></p> <p>对于<code>signalB = [signalA materialize];</code>，<code>signalA</code>产生的值事件包裹的数据都被转化为<code>RACEvent</code>对象，错误事件和完成事件亦然：</p> <div class="language-textile extra-class"><pre class="language-textile"><code><span class="token phrase">signalA -- sendNext:x
=&gt;
signalB -- sendNext:[RACEvent eventWithValue:x]</span>

<span class="token phrase">signalA -- sendError:error
=&gt;
signalB --  sendNext:[RACEvent eventWithError:error]
signalB --  sendCompleted</span>

<span class="token phrase">signalA -- sendCompleted
=&gt;
signalB -- sendNext:RACEvent.completedEvent
signalB -- sendCompleted
</span></code></pre></div><p><code>dematerialize</code>操作与<code>materialize</code>相反，写代码体会一下就明白了。这两个操作似乎很少被用到。</p> <p><strong>数量操作 -- Filter</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/filter@2x.png" srcset="/image/filter@2x.png 2x" data-v-339c7bd5></div> <p>和<code>map:</code>一样：</p> <ul><li>当<code>signalA</code>产生完成事件时，<code>signalB</code>也会产生完成事件</li> <li>当<code>signalA</code>产生错误事件时，<code>signalB</code>也会将该错误原封不动地释放出来</li></ul> <p><strong>数量操作 -- Ignore</strong></p> <p><code>ignore:</code>是<code>filter:</code>的变体操作：</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/ignore@2x.png" srcset="/image/ignore@2x.png 2x" data-v-339c7bd5></div> <p>还有其他的变体版本：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>ignoreValues<span class="token punctuation">;</span>
</code></pre></div><p><strong>数量操作 -- Distinct</strong></p> <p><code>distinctUntilChanged</code>去掉连续相同的值事件。</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/distinct-until-changed@2x.png" srcset="/image/distinct-until-changed@2x.png 2x" data-v-339c7bd5></div> <p><strong>数量操作 -- Take 和 Skip</strong></p> <p><code>take:</code>操作只取前<code>n</code>（传入的参数）个事件。</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/take@2x.png" srcset="/image/take@2x.png 2x" data-v-339c7bd5></div> <p>假设<code>signalA</code>第一次出现错误事件/完成事件的 index（从 1 开始）为<code>k</code>：</p> <ul><li>当<code>k</code> &gt; <code>n</code>时，<code>signalB</code>中就不会出现错误事件/完成事件</li> <li>当<code>k</code> &lt;= <code>n</code>时，错误事件/完成事件也会出现<code>signalB</code>中</li></ul> <p><code>skip:</code>与<code>take:</code>相反，它会将前<code>n</code>（传入的参数）个事件给过过滤掉。</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/skip@2x.png" srcset="/image/skip@2x.png 2x" data-v-339c7bd5></div> <p><code>signalA</code>的前<code>n</code>个事件中可能会出现错误事件/完成事件，这种情况下，<code>signalB</code>的第一个信号就是错误事件/完成事件，且不会有任何的值事件。</p> <p><code>take:</code>和<code>skip:</code>也有几个变体：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>takeLast<span class="token punctuation">:</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span>count<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>takeUntilBlock<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span><span class="token punctuation">)</span>predicate<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>takeWhileBlock<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span><span class="token punctuation">)</span>predicate<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>skipUntilBlock<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span><span class="token punctuation">)</span>predicate<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>skipWhileBlock<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span><span class="token punctuation">)</span>predicate<span class="token punctuation">;</span>
</code></pre></div><p>P.S: 还有两个操作也以「take」作为前缀，即<code>takeUntil:</code>和<code>takeUntilReplacement:</code>，但属于组合操作，详见下文。</p> <p><strong>数量操作 -- Start With</strong></p> <p><code>startWith:</code>操作的作用是在事件流的开始新增一个值事件。</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/start-with@2x.png" srcset="/image/start-with@2x.png 2x" data-v-339c7bd5></div> <p><strong>数量操作 -- Repeat</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/repeat@2x.png" srcset="/image/repeat@2x.png 2x" data-v-339c7bd5></div> <p>从图中可以看到，<code>repeat</code>操作会忽略<code>signalA</code>的完成事件，但它不会忽略错误事件，换句话说，如果<code>signalA</code>的事件流中含有错误事件，那么<code>signalB</code>的事件流会和<code>signalA</code>完全一致。</p> <p><strong>数量操作 -- Retry</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/retry@2x.png" srcset="/image/retry@2x.png 2x" data-v-339c7bd5></div> <p>然而，当<code>signalA</code>事件流中含有完成事件时，那么<code>signalA</code>的事件流会和<code>signalA</code>完全一致。</p> <p><code>retry</code>操作还有带参数版本<code>retry:</code>，该版本可以指定次数。这种操作在处理网络任务时非常有用。</p> <p><strong>数量操作 -- Collect</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/collect@2x.png" srcset="/image/collect@2x.png 2x" data-v-339c7bd5></div> <p><strong>Aggregate 和 Scan</strong></p> <p>Aggregate（译作「合计」）和 Scan 这两个操作有些类似，但明显有区别，前者改变了事件流的事件数量，后者没有，看如下图例就明白。</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/aggregate@2x.png" srcset="/image/aggregate@2x.png 2x" data-v-339c7bd5></div> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/scan@2x.png" srcset="/image/scan@2x.png 2x" data-v-339c7bd5></div> <p>Aggregate 和 Scan 还有一些其他变种方法：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>aggregateWithStartFactory<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>startFactory reduce<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id running<span class="token punctuation">,</span> id next<span class="token punctuation">)</span><span class="token punctuation">)</span>reduceBlock<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>aggregateWithStart<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>start reduceWithIndex<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> id<span class="token punctuation">,</span> NSUInteger<span class="token punctuation">)</span><span class="token punctuation">)</span>reduceBlock<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>scanWithStart<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>startingValue reduceWithIndex<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> id<span class="token punctuation">,</span> NSUInteger<span class="token punctuation">)</span><span class="token punctuation">)</span>reduceBlock<span class="token punctuation">;</span>
</code></pre></div><p><strong>时间操作 -- 常会用到的时间信号</strong></p> <p>经常会有这样的需求：定时产生一个事件。</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">+</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>interval<span class="token punctuation">:</span><span class="token punctuation">(</span>NSTimeInterval<span class="token punctuation">)</span>interval onScheduler<span class="token punctuation">:</span><span class="token punctuation">(</span>RACScheduler <span class="token operator">*</span><span class="token punctuation">)</span>scheduler<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>interval<span class="token punctuation">:</span><span class="token punctuation">(</span>NSTimeInterval<span class="token punctuation">)</span>interval onScheduler<span class="token punctuation">:</span><span class="token punctuation">(</span>RACScheduler <span class="token operator">*</span><span class="token punctuation">)</span>scheduler withLeeway<span class="token punctuation">:</span><span class="token punctuation">(</span>NSTimeInterval<span class="token punctuation">)</span>leeway<span class="token punctuation">;</span>
</code></pre></div><p>这两个类方法都会产生一个时间信号，时间信号会以一定频率产生一个值事件，值事件包裹的是<code>NSDate</code>对象。第二个方法中的参数<code>leeway</code>是「缓冲」、「余地」的意思，还不太明白其作用。</p> <p><strong>时间操作 -- Delay</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/delay@2x.png" srcset="/image/delay@2x.png 2x" data-v-339c7bd5></div> <p><strong>时间操作 -- Throttle</strong></p> <p>Throttle 信号理解起来相对比较繁琐些。在下图中，<code>signalA</code>事件流中一共有 5 个值事件和 1 个完成事件，其中 1 号和 2 号事件间隔 2s，2、3、4 号事件间隔 1s，5 号值事件比 4 号值事件晚 3s，完成事件比 5 号事件晚 1s。</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/throttle@2x.png" srcset="/image/throttle@2x.png 2x" data-v-339c7bd5></div> <p><code>signalB</code>由<code>[signalA throttle:1.5]</code>得到，throttle 表示门限，其作用效果是：</p> <ul><li>当<code>signalA</code>事件流产生一个值事件时，若 1.5s 内没有其他的值事件产生，则<code>signalB</code>事件流中也会产生该值事件；比如上图中的 1 号值事件，下一个值事件（2 号）在其 2s 后产生，满足要求，故而在 1.5s 后，<code>signalB</code>的事件流也产生该信号；</li> <li>当<code>signalA</code>事件流产生一个值事件时，若 1.5s 内有其他的值事件产生，则<code>signalB</code>会过滤掉该值事件；比如上图中的 2 号和 3 号值事件，在 1s 后分别有 3 号和 4 号信号产生，不满足要求，故而都不会出现在<code>signalB</code>的事件流中；</li> <li>对于<code>signalA</code>中的最后一个值事件，<code>signalB</code>事件流中总会也包含它。</li></ul> <p>这种信号有什么用呢？有一个常用的应用场景：在 App 内经常需要搜索，为了确保实时性，简单的做法是每输入一个字符就检索一下，但是若用户输入字符比较快，这种检索策略会比较浪费流量，因此比较好的做法是，用户输入某个字符后，1s（参考值）内没有再输入别的字符，就检索一次搜索结果。此时 throttle 就有了用武之地。</p> <p><code>throttle:</code>还有一个变体<code>throttle:valuesPassingTest:</code>；及类似操作：<code>bufferWithTime:onScheduler:</code>。</p> <p><strong>副作用操作</strong></p> <p>再补充一些 RAC 提供的副作用操作：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>doNext<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id x<span class="token punctuation">)</span><span class="token punctuation">)</span>block<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>doError<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSError <span class="token operator">*</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>block<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>doCompleted<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>block<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>initially<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>block<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>RACSignal <span class="token operator">*</span><span class="token punctuation">)</span>finally<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>block<span class="token punctuation">;</span>
</code></pre></div><p>这 5 个副作用操作，稍微查看一下源码立马能知道它们的作用；其中<code>initially:</code>的作用是让信号在第一次被订阅是调用其 block；<code>finally:</code>的作用是在信号的事件流结束（出现完成事件或错误事件）时调用传入的 block。</p> <h3 id="多个信号的组合"><a href="#多个信号的组合" class="header-anchor">#</a> 多个信号的组合</h3> <p>上面介绍的都是单信号操作，这部分介绍多信号组合操作，在熟悉这些组合操作时，以<code>signalA + signalB =&gt; signalC</code>为例，需要留意几个问题：</p> <ul><li>组合得到<code>signalC</code>的信号受哪个信号终止而终止，<code>signalA</code> or <code>signalB</code>？</li> <li>当<code>signalA</code>或<code>signalB</code>事件流中出现错误信号，会如何？</li> <li>各个信号何时开始被订阅？</li></ul> <p><strong>组合操作 -- Concat</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/concat@2x.png" srcset="/image/concat@2x.png 2x" data-v-339c7bd5></div> <p>在上图中，当<code>signalA</code>的事件流中出现完成事件时，立马订阅<code>signalB</code>，<code>signalC</code>事件流的完成事件与<code>signalB</code>的完成事件对应。同时，注意到当<code>signalA</code>中出现错误事件时，<code>signalC</code>中的事件流与<code>signalA</code>的事件流完全保持一致，就没<code>signalB</code>什么事儿了。</p> <p><strong>组合操作 -- Merge</strong></p> <p>Merge 操作比较简单，看图就明白。</p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/merge@2x.png" srcset="/image/merge@2x.png 2x" data-v-339c7bd5></div> <p>除了<code>signalC = [signalA merge:signalB]</code>这种用法外，还可以这样：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>signalC <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal merge<span class="token punctuation">:</span><span class="token operator">@</span><span class="token punctuation">[</span>signalA<span class="token punctuation">,</span> signalB<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
signalC <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal merge<span class="token punctuation">:</span><span class="token function">RACTuplePack</span><span class="token punctuation">(</span>signalA<span class="token punctuation">,</span> signalB<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>组合操作 -- Zip</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/zip@2x.png" srcset="/image/zip@2x.png 2x" data-v-339c7bd5></div> <p>除了<code>signalC = [signalA zip:signalB]</code>这种用法外，还可以这样：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>signalC <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal zip<span class="token punctuation">:</span><span class="token operator">@</span><span class="token punctuation">[</span>signalA<span class="token punctuation">,</span> signalB<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
signalC <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal zip<span class="token punctuation">:</span><span class="token function">RACTuplePack</span><span class="token punctuation">(</span>signalA<span class="token punctuation">,</span> signalB<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>组合操作 -- CombineLatest</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/combine-latest@2x.png" srcset="/image/combine-latest@2x.png 2x" data-v-339c7bd5></div> <p>除了<code>signalC = [signalA combineLatest:signalB]</code>这种用法外，还可以这样：</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code>signalC <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal combineLatest<span class="token punctuation">:</span><span class="token operator">@</span><span class="token punctuation">[</span>signalA<span class="token punctuation">,</span> signalB<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
signalC <span class="token operator">=</span> <span class="token punctuation">[</span>RACSignal combineLatest<span class="token punctuation">:</span><span class="token function">RACTuplePack</span><span class="token punctuation">(</span>signalA<span class="token punctuation">,</span> signalB<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>组合操作 -- Sample</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/sample@2x.png" srcset="/image/sample@2x.png 2x" data-v-339c7bd5></div> <p>在<code>signalC = [signalA sample:signalB]</code>中，<code>signalB</code>充当<code>signalA</code>的采样信号，一旦<code>signalA</code>或<code>signalB</code>先产生完成事件或者错误事件，<code>signalC</code>的事件流就被终止。</p> <p><strong>组合操作 -- Take Until</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/take-until@2x.png" srcset="/image/take-until@2x.png 2x" data-v-339c7bd5></div> <p><code>signalC</code>事件流中的事件和<code>signalA</code>一一对应，直到<code>signalB</code>事件流中出现了信号，事件流就终结。</p> <p><strong>组合操作 -- Take Until Replacement</strong></p> <div class="custom-image-wrapper" data-v-339c7bd5><img src="/image/take-until-replacement@2x.png" srcset="/image/take-until-replacement@2x.png 2x" data-v-339c7bd5></div> <p><code>signalC</code>事件流中的事件和<code>signalA</code>一一对应，一旦<code>signalB</code>事件流中出现了信号，<code>signalC</code>的事件就和<code>signalB</code>形成呼应，当然前提是<code>signalC</code>的事件流还没有终结。</p> <p>补充：本文的主体内容是我在刚入职场学习 ReactiveCocoa 时的笔记，当时在闲得蛋疼和郁闷的情况下，画了很多 operator 图例打发时间；然而罗列的信号的基本操作并不全，一些高阶操作（譬如 flatten）没有涉及到。ReactiveX 定义了更多更全的 operator，并配有详细说明，详见<a href="http://reactivex.io/documentation/operators.html" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，ReactiveCocoa 受 ReactiveX 启发，后者定义的 operator 在 ReactiveCocoa 基本都有实现，可以作为参考。另外，<a href="http://rxmarbles.com/" target="_blank" rel="noopener noreferrer">RxJS Marbles<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供的可交互 signal 操作能更生动地帮助理解各个 operator 的内涵。</p></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.50bca889.js" defer></script><script src="/assets/js/5.081d1701.js" defer></script><script src="/assets/js/94.e9cc0386.js" defer></script><script src="/assets/js/4.a7413ce2.js" defer></script>
  </body>
</html>
